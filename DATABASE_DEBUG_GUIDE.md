# Analytics Database Debug Guide

**Date:** 2025-12-26

This guide explains what data should be in your database and how to verify the analytics pipeline is working end-to-end.

---

## Understanding the Data Flow

### Step 1: Events are QUEUED in Memory/AsyncStorage (Frontend)

When a user takes an action (page view, bookmark, etc.), the event is:
1. Generated by store action (e.g., `shoppingAnalytics.recordPageVisitQueue()`)
2. Queued locally in `AnalyticsQueueService` (in-memory)
3. Persisted to device storage via AsyncStorage
4. **NOT YET in database**

**Where to check:** Device filesystem via Xcode debugger or app logs

---

### Step 2: Events are SYNCED to Backend (Periodic or On Demand)

The `useAnalyticsSyncTriggers` hook periodically (or on app background) calls `syncEvents()`:
1. Fetches pending events from queue
2. Sends batch POST request to `/api/shopping/analytics/events/batch`
3. Includes JWT token from Auth0
4. Backend validates and inserts into database
5. Server returns `accepted_client_event_ids` (which events were accepted)
6. Client marks those events as sent in queue

**Where to check:** Backend logs, database

---

### Step 3: Events are PERSISTED in Database

Once backend endpoint processes the batch:
1. Events inserted into `shopping_analytics_events` table
2. Each event has unique `(user_id, client_event_id)` pair
3. Duplicates rejected by UNIQUE constraint
4. Successfully inserted events returned in ACK

**Where to check:** PostgreSQL database

---

## Why You're Not Seeing Data

### Reason 1: App Never Generated Events

**Cause:** If you just started the app and haven't interacted with any shopping features, no events have been queued yet.

**Test:**
1. Open app
2. Navigate to Shopping section
3. Click on a product (triggers `recordPageVisitQueue()`)
4. Check Analytics Sync in background or wait 15 minutes

---

### Reason 2: Tracking Consent Not Accepted

**Cause:** Events are blocked at consent layer if user hasn't accepted tracking.

**Verification:**
```typescript
// In store/shoppingAnalytics.ts, every record* method checks:
if (!shoppingAnalytics.isTrackingEnabled()) {
  console.log('[Analytics] Page visit blocked: tracking not accepted');
  return;  // ❌ Event NEVER queued
}
```

**How to check:**
1. Open Settings or consent screen in app
2. Verify "Allow Analytics" or tracking consent is set to `accepted`
3. If declined, no events will be queued

---

### Reason 3: Events Queued but Never Synced

**Cause:** Sync never triggered (app in foreground, no 15-min timer elapsed).

**Verification:**
```typescript
// In useAnalyticsSyncTriggers.ts, sync happens when:
// 1. App goes to background (AppState listener)
// 2. Every 15 minutes (setInterval)
```

**How to check:**
1. Queue some events (navigate shopping)
2. Push app to background (press home button)
3. Wait 5-10 seconds
4. Backend should receive POST request to `/api/shopping/analytics/events/batch`
5. Check backend logs (or database)

---

### Reason 4: Sync Attempted but Backend Request Failed

**Cause:** JWT token expired, network error, or validation failed.

**Verification:**
```typescript
// In analyticsSyncService.ts, on sync failure:
if (response.status !== 200) {
  console.error('[Analytics Sync] Failed:', response.status);
  markFailed(clientEventId, errorMsg);  // Retry later
}
```

**How to check:**
1. Run backend: `cd apps/backend-nest && npm run start:dev`
2. Check for errors in console output
3. Verify JWT token is valid (check Auth0 credentials)
4. Test endpoint manually with curl

---

### Reason 5: Sync Succeeded but Data Not Visible

**Cause:** Events inserted but you're querying wrong schema or filtering by wrong user.

**See verification section below**

---

## Step-by-Step Verification

### 1. Verify Tables Exist (Post-Migration)

```bash
# Connect to your database
psql $DATABASE_URL

# List all analytics tables
\dt shopping_*

# Expected output:
#                     List of relations
#  Schema |             Name             | Type  | Owner
# --------+------------------------------+-------+-------
#  public | shopping_analytics_events    | table | postgres
#  public | shopping_bookmarks           | table | postgres
#  public | shopping_analytics_rollups_daily | table | postgres
```

---

### 2. Verify Table Schema

```bash
psql $DATABASE_URL

# Describe shopping_analytics_events table
\d shopping_analytics_events

# Expected columns:
#             Column            |       Type       | Modifiers
# ----------------------------+------------------+----------
#  id                          | uuid             | not null primary key
#  user_id                     | uuid             | not null
#  client_event_id             | uuid             | not null
#  event_type                  | text             | not null
#  event_ts                    | timestamptz      | not null
#  received_ts                 | timestamptz      | not null default NOW()
#  canonical_url               | text             | not null
#  domain                      | text             | not null
#  session_id                  | text             |
#  title_sanitized             | text             |
#  payload                     | jsonb            | not null
#  is_deleted                  | boolean          | not null default FALSE
```

---

### 3. Verify Constraints Exist

```bash
psql $DATABASE_URL

# Check UNIQUE constraint for idempotency
\d+ shopping_analytics_events

# Look for "UNIQUE (user_id, client_event_id)"

# Verify with query:
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'shopping_analytics_events' AND constraint_type = 'UNIQUE';

# Expected:
#            constraint_name         | constraint_type
# ─────────────────────────────────┼─────────────────
#  shopping_analytics_events_pkey  | PRIMARY KEY
#  shopping_analytics_events_user_id_client_event_id_key | UNIQUE
```

---

### 4. Count Events in Database

```bash
psql $DATABASE_URL

# Count ALL events (including soft-deleted)
SELECT COUNT(*) AS total_events FROM shopping_analytics_events;

# Count ACTIVE events (not soft-deleted)
SELECT COUNT(*) AS active_events FROM shopping_analytics_events WHERE is_deleted = FALSE;

# Count by event type
SELECT event_type, COUNT(*) FROM shopping_analytics_events WHERE is_deleted = FALSE GROUP BY event_type;

# Count by user
SELECT user_id, COUNT(*) FROM shopping_analytics_events WHERE is_deleted = FALSE GROUP BY user_id;
```

---

### 5. Check Events for Your User

```bash
psql $DATABASE_URL

# Get your user ID (replace with actual UUID)
SELECT id, email FROM users LIMIT 1;

# Query events for that user
SELECT
  id,
  client_event_id,
  event_type,
  event_ts,
  canonical_url,
  is_deleted
FROM shopping_analytics_events
WHERE user_id = '11111111-1111-1111-1111-111111111111'  -- YOUR USER ID
  AND is_deleted = FALSE
ORDER BY received_ts DESC
LIMIT 20;

# Expected output (if events exist):
#                  id                  |          client_event_id           | event_type | event_ts | canonical_url | is_deleted
# ─────────────────────────────────────┼────────────────────────────────────┼────────────┼──────────┼──────────────┼────────────
#  22222222-2222-2222-2222-222222222222 | 33333333-3333-3333-3333-333333333333 | page_view  | ...      | https://...  | f
```

---

### 6. Verify Idempotency (Test Duplicate Prevention)

```bash
psql $DATABASE_URL

# Get JWT token from Auth0 (or create test user)
export TOKEN="<your-jwt-token>"
export USER_ID="<your-internal-uuid>"

# Try to send same event twice (same client_event_id)
CLIENT_EVENT_ID="aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"

curl -X POST http://localhost:3001/api/shopping/analytics/events/batch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "events": [{
      "client_event_id": "'$CLIENT_EVENT_ID'",
      "event_type": "page_view",
      "event_ts": "2025-12-26T10:00:00Z",
      "canonical_url": "https://example.com/product/123",
      "domain": "example.com",
      "title_sanitized": "Product Title",
      "payload": { "dwell_time_sec": 5, "scroll_depth_pct": 25 }
    }],
    "client_id": "device-1"
  }'

# Check database
SELECT COUNT(*) FROM shopping_analytics_events
WHERE user_id = '$USER_ID' AND client_event_id = '$CLIENT_EVENT_ID';

# Send again with same client_event_id...

# Check database again
SELECT COUNT(*) FROM shopping_analytics_events
WHERE user_id = '$USER_ID' AND client_event_id = '$CLIENT_EVENT_ID';

# Expected: Still 1 (duplicate rejected by UNIQUE constraint)
```

---

### 7. Check Backend Logs

```bash
# Start backend in dev mode
cd apps/backend-nest
npm run start:dev

# Look for logs like:
# [Analytics Batch Ingest] user_id=11111111-1111-1111-1111-111111111111, event_count=5, client_id=device-1
# [Database] SERIALIZABLE transaction started
# [Database] Inserted 5 events
# [Analytics Batch Ingest] Accepted: ['event-1', 'event-2', 'event-3', 'event-4', 'event-5']
```

---

### 8. Check Frontend Logs (React Native)

The app logs analytics activity to console:

```
[Analytics] Page visit blocked: tracking not accepted  ← CONSENT NOT ACCEPTED
[AnalyticsQueue] Loaded 0 events from storage           ← QUEUE EMPTY
[AnalyticsQueue] Queued page_view event                 ← EVENT QUEUED
[Analytics Sync] Tracking not accepted, skipping sync   ← CONSENT GATE FAILED
[Analytics Sync] Syncing 5 events...                    ← SYNC STARTED
[Analytics Sync] Batch accepted: 5 events               ← SYNC SUCCEEDED
[AnalyticsQueue] Queue cleared                          ← QUEUE CLEARED (on consent decline)
```

---

## Expected Data Flow Timeline

### Scenario: User navigates to product page and stays 5 seconds

**T=0s:** User opens app, navigates to `/product/123`
- `recordPageVisitQueue()` called
- Tracking consent checked: ✅ accepted
- Event queued: `{ event_type: 'page_view', canonical_url: 'https://...', dwell_time_sec: 0, ... }`
- **State:** Event in memory + AsyncStorage (not in database yet)

**T=5s:** User scrolls and reads
- Event updated with `dwell_time_sec: 5`, `scroll_depth_pct: 35`
- Still queued locally

**T=15s:** Sync triggers (either app background or 15-min timer)
- `syncEvents()` called
- Fetches pending events from queue
- Sends POST `/api/shopping/analytics/events/batch` with JWT
- **State:** Event in transit to backend

**T=16s:** Backend processes request
- JWT guard extracts `user_id` (internal UUID)
- DTO validation passes
- Service starts SERIALIZABLE transaction
- INSERT event into database (ON CONFLICT DO NOTHING prevents duplicates)
- COMMIT transaction
- Return ACK: `{ accepted_client_event_ids: ['event-uuid'], ... }`

**T=17s:** Frontend marks event as sent
- `markAsSent(['event-uuid'])` updates queue
- Event no longer sent on next sync
- **State:** Event in database ✅

**To verify:** Query database for user_id + event_type = 'page_view'

---

## Debugging Checklist

- [ ] Migrations ran successfully (`\dt shopping_*` shows 3 tables)
- [ ] Tables have correct schema (`\d shopping_analytics_events`)
- [ ] UNIQUE constraint exists on (user_id, client_event_id)
- [ ] App is open (console logs visible)
- [ ] Tracking consent is accepted (check settings)
- [ ] User performed action (clicked product, bookmarked, etc.)
- [ ] App went to background or 15 min passed (sync triggered)
- [ ] Backend is running and receiving POST requests (check logs)
- [ ] JWT token is valid (not expired)
- [ ] Database query returns events for your user

---

## Common Issues & Solutions

### Issue: "No events in database but queue has events"
**Solution:** Sync hasn't triggered yet. Push app to background or wait 15 minutes for timer.

### Issue: "Sync failed with 401 Unauthorized"
**Solution:** JWT token expired. Log out and log back in to get fresh token.

### Issue: "Sync failed with 400 Bad Request"
**Solution:** Check error message. Likely: query params in URL, empty event array, or payload > 5MB.

### Issue: "Rate limited (429)"
**Solution:** Sent >100 requests in 15 minutes. Wait 15 min and try again.

### Issue: "Tracking not accepted, skipping sync"
**Solution:** User has declined analytics consent. Accept consent in settings and queue will be cleared automatically.

### Issue: "Duplicate event appears in database"
**Solution:** Shouldn't happen (UNIQUE constraint prevents it). If it does, check if it's from different user or different client_event_id.

---

## How to Generate Test Data

If you want to test without the app UI:

```bash
export TOKEN="<your-jwt-token>"
export USER_ID="<your-user-id-from-jwt>"

curl -X POST http://localhost:3001/api/shopping/analytics/events/batch \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "events": [
      {
        "client_event_id": "aaaaaaaa-1111-2222-3333-111111111111",
        "event_type": "page_view",
        "event_ts": "2025-12-26T10:00:00Z",
        "canonical_url": "https://example.com/product/100",
        "domain": "example.com",
        "title_sanitized": "Blue Shirt Size M",
        "payload": { "dwell_time_sec": 12, "scroll_depth_pct": 45 }
      },
      {
        "client_event_id": "bbbbbbbb-2222-3333-4444-222222222222",
        "event_type": "bookmark",
        "event_ts": "2025-12-26T10:00:30Z",
        "canonical_url": "https://example.com/product/100",
        "domain": "example.com",
        "title_sanitized": "Blue Shirt Size M",
        "payload": { "category": "tops", "brand": "Gap" }
      },
      {
        "client_event_id": "cccccccc-3333-4444-5555-333333333333",
        "event_type": "size_click",
        "event_ts": "2025-12-26T10:01:00Z",
        "canonical_url": "https://example.com/product/100",
        "domain": "example.com",
        "title_sanitized": "Blue Shirt Size M",
        "payload": { "size_clicked": "M" }
      }
    ],
    "client_id": "test-device"
  }'

# Verify:
psql $DATABASE_URL -c "SELECT COUNT(*) FROM shopping_analytics_events WHERE user_id = '$USER_ID';"
```

---

## Next Steps

1. **Verify migrations:** Run `\dt shopping_*` in psql
2. **Check app logs:** Navigate shopping in app, check console output
3. **Trigger sync:** Push app to background
4. **Check database:** Run count query above
5. **If no data:** Use curl to send test data directly

**Questions?** Check logs at each step:
- Frontend logs (React Native console)
- Backend logs (npm run start:dev)
- Database logs (psql queries)
