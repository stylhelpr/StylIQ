name: Deploy Backend to Cloud Run

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1) Install gcloud SDK
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: stylhelpr-prod

      # 2) Activate the service account explicitly (forces active account)
      - name: Activate GCP service account
        run: |
          echo '${{ secrets.GCP_CREDENTIALS }}' > $HOME/gcp.json
          gcloud auth activate-service-account --key-file=$HOME/gcp.json
          gcloud config set project stylhelpr-prod
          gcloud config set run/region us-central1

      # 3) Login Docker to Artifact Registry (for docker push)
      - name: Docker login to Artifact Registry
        uses: docker/login-action@v2
        with:
          registry: us-central1-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_CREDENTIALS }}

      # 4) Build & push the backend image from apps/backend-nest/Dockerfile
      - name: Build and Push Docker image
        run: |
          IMAGE="us-central1-docker.pkg.dev/stylhelpr-prod/backend/api:latest"
          docker build -t "$IMAGE" -f apps/backend-nest/Dockerfile apps/backend-nest
          docker push "$IMAGE"

      # 5) Deploy to Cloud Run (keeps existing env/secrets on the service)
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy backend \
            --image us-central1-docker.pkg.dev/stylhelpr-prod/backend/api:latest \
            --region us-central1 \
            --allow-unauthenticated \
            --quiet
