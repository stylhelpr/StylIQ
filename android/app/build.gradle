plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("com.facebook.react")
}

// ==========================================================
// ðŸ”§ Ensure autolinking.json exists in root android build
// ==========================================================
def rootAutoDir = file("$rootDir/android/build/generated/autolinking")
def rootAutoFile = file("$rootAutoDir/autolinking.json")
if (!rootAutoFile.exists()) {
    rootAutoDir.mkdirs()
    rootAutoFile.text = "{}"
    println("ðŸ§© Created missing root autolinking.json (${rootAutoFile})")
}

// ==========================================================
// ðŸ§  React Native project properties
// ==========================================================
project.ext.react = [
    packageName: "com.styliq",
    applicationId: "com.styliq",
    appName: "app",
    cliPath: "$rootDir/../node_modules/react-native/cli.js"
]

android {
    namespace "com.styliq"
    compileSdk 35

    defaultConfig {
        applicationId "com.styliq"
        minSdk 24
        targetSdk 35
        versionCode 1
        versionName "1.0"
    }

    signingConfigs {
        debug {
            storeFile file("debug.keystore")
            storePassword "android"
            keyAlias "androiddebugkey"
            keyPassword "android"
        }
    }

    buildTypes {
        debug { signingConfig signingConfigs.debug }
        release {
            signingConfig signingConfigs.debug
            minifyEnabled false
            shrinkResources false
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    kotlinOptions { jvmTarget = "17" }
}

dependencies {
    implementation("com.facebook.react:react-android")
    implementation("com.facebook.react:hermes-android")
    implementation("androidx.appcompat:appcompat:1.7.0")
    implementation("androidx.activity:activity-ktx:1.9.2")
}

// ==========================================================
// ðŸ§  Patch autolinking tasks to use root build folder
// ==========================================================
tasks.matching { it.name.startsWith("generateAutolinking") }.all { task ->
    task.doFirst {
        println("ðŸ§  Injecting autolinking context for ${task.name}")
        System.setProperty("REACT_NATIVE_PACKAGE_NAME", project.ext.react.packageName)
        System.setProperty("REACT_NATIVE_ANDROID_APP_NAME", project.ext.react.appName)
        System.setProperty("REACT_NATIVE_ANDROID_SOURCE_DIR", "$rootDir/android")

        // âœ… Ensure the root autolinking.json exists before the task runs
        if (!rootAutoFile.exists()) {
            rootAutoDir.mkdirs()
            rootAutoFile.text = "{}"
            println("ðŸ§© Created fallback root autolinking.json for task ${task.name}")
        }
    }
}
