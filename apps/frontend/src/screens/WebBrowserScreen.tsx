import React, {useRef, useState, useEffect, useCallback, useMemo} from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  StatusBar,
  TextInput,
  Keyboard,
  ScrollView,
  Dimensions,
  Animated,
  Easing,
  Modal,
  Share,
  Image,
  PanResponder,
  LayoutChangeEvent,
  Alert,
} from 'react-native';
import {WebView} from 'react-native-webview';
import {useSafeAreaInsets} from 'react-native-safe-area-context';
import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
import {captureRef} from 'react-native-view-shot';
import {useAppTheme} from '../context/ThemeContext';
import {useShoppingStore} from '../../../../store/shoppingStore';
import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
import {triggerHaptic} from '../utils/haptics';
import ShoppingAssistant from '../components/ShoppingAssistant';
import {useUUID} from '../context/UUIDContext';
import {tokens} from '../styles/tokens/tokens';
import {LiquidGlassView, isLiquidGlassSupported} from '@callstack/liquid-glass';
import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
import {fontScale, moderateScale} from '../utils/scale';
// ðŸ”¥ VOICE ADD/
import {useVoiceControl} from '../hooks/useVoiceControl';
import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
import {PermissionsAndroid, Platform} from 'react-native';
import ImageSaverModule from '../native/ImageSaverModule';
import {API_BASE_URL} from '../config/api';
import AppleTouchFeedback from '../components/AppleTouchFeedback/AppleTouchFeedback';
import Icon from 'react-native-vector-icons/MaterialIcons';
import TrackingConsentModal from '../components/TrackingConsentModal/TrackingConsentModal';
// Security imports
import {
  SECURE_WEBVIEW_DEFAULTS,
  createOnShouldStartLoadWithRequest,
  createCrashRecoveryHandler,
} from '../config/webViewDefaults';
import {sanitizeTitle} from '../utils/sanitize';
import {sanitizeUrlForAnalytics} from '../utils/urlSanitizer';

const {width: screenWidth} = Dimensions.get('window');
const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

const SHOPPING_SITES = [
  {name: 'Google', url: 'https://www.google.com'},
  {name: 'Amazon', url: 'https://www.amazon.com'},
  {name: 'ASOS', url: 'https://www.asos.com'},
  {name: 'H&M', url: 'https://www.hm.com'},
  {name: 'Zara', url: 'https://www.zara.com'},
  {name: 'Shein', url: 'https://www.shein.com'},
  {name: 'SSENSE', url: 'https://www.ssense.com'},
  {name: 'Farfetch', url: 'https://www.farfetch.com'},
  {name: 'Nordstrom', url: 'https://www.nordstrom.com'},
];

type Props = {
  route?: {params?: {url?: string; title?: string}};
  navigate: (screen: string, params?: any) => void;
  wardrobe: any[];
};

export default function WebBrowserScreen({navigate, route}: Props) {
  // ðŸ”¥ VOICE ADD
  const {speech, isRecording, startListening, stopListening} =
    useVoiceControl();
  const [isHoldingMic, setIsHoldingMic] = useState(false);
  const {theme} = useAppTheme();
  const insets = useSafeAreaInsets();
  const userId = useUUID();
  // Debug: Log only on actual mount, not every render
  useEffect(() => {
    console.log('WebBrowserScreen mounted, userId:', userId);
  }, []);
  const initialUrl = route?.params?.url || '';
  const webRef = useRef<WebView>(null);
  const containerRef = useRef<View>(null);
  // SECURITY: Rate limiter for WebView messages to prevent DoS attacks
  const messageRateLimiter = useRef({count: 0, lastReset: Date.now()});
  const [inputValue, setInputValue] = useState(initialUrl);
  const [showTabsView, setShowTabsView] = useState(false);
  const tabsViewScale = useRef(new Animated.Value(0)).current;

  const {
    tabs,
    currentTabId,
    addTab,
    removeTab,
    switchTab,
    updateTab,
    updateTabScreenshot,
    reorderTabs,
    addBookmark,
    removeBookmark,
    isBookmarked,
    bookmarks,
    collections,
    addItemToCollection,
    history,
    addToHistory,
    addSearch,
    _hasHydrated,
    aiShoppingAssistantSuggestions,
    setAiShoppingAssistantSuggestions,
    hasAiSuggestionsLoaded,
    setHasAiSuggestionsLoaded,
    isAiSuggestionsStale,
    trackingConsent,
    setTrackingConsent,
  } = useShoppingStore();

  // iOS Password AutoFill - passwords are managed by iOS/iCloud Keychain
  // No app-level password storage needed - iOS handles everything securely

  // ðŸ”¥ VOICE ADD
  async function prepareAudio() {
    try {
      if (Platform.OS === 'android') {
        const granted = await PermissionsAndroid.request(
          PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
        );
        if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
      } else {
        const AV = require('react-native').NativeModules.AVAudioSession;
        if (AV?.setCategory) {
          await AV.setCategory('PlayAndRecord');
          await AV.setActive(true);
        }
      }
      return true;
    } catch {
      return false;
    }
  }

  // ðŸ›ï¸ Fetch shopping suggestions with smart context classification
  async function fetchShoppingAssistantSuggestions() {
    if (!userId || (hasAiSuggestionsLoaded && !isAiSuggestionsStale())) {
      return;
    }

    const SHOPPING_PROMPT = `SHOPPING ASSISTANT MODE: Analyze the user's wardrobe, style profile, and calendar to generate 5 HIGHLY SPECIFIC personalized shopping recommendations.

ðŸŽ¯ CRITICAL REQUIREMENTS:
1. Access user's wardrobe inventory to identify SPECIFIC gaps (colors owned, categories missing, fit preferences)
2. Reference style profile: body type, preferred colors, disliked styles, climate
3. Check calendar for upcoming events needing specific pieces
4. NO GENERIC SUGGESTIONS - every recommendation must PROVE you know their wardrobe
5. EVERY recommendation MUST explicitly name SPECIFIC items they already own

â­ MANDATORY WARDROBE REFERENCING (you MUST do this):
- Use language patterns like "pair with your [COLOR] [ITEM] you own"
- Examples of GOOD recommendations:
  â€¢ "Navy blazer - pairs perfectly with your sleek white pants and complements your gray cardigans"
  â€¢ "Camel belt - fills your warm-neutral gap; works with your dark bottoms and existing brown shoes"
  â€¢ "Black tailored trousers - adds formality; you have 8 tops (mostly navy/gray) but only 2 bottoms"
  â€¢ "Cream linen shirt - bridges your white and navy pieces; works for your business casual events next month"
  â€¢ "Burgundy wool sweater - complements your warm undertones and pairs with the cream chinos you own"

- Examples of BAD recommendations (NEVER do these):
  â€¢ âŒ "Elevate your look with a premium leather belt"
  â€¢ âŒ "Fill the gap with classic black trousers"
  â€¢ âŒ "Add a stylish blazer to complete your wardrobe"

Use strategies:
1. **CALENDAR**: Reference specific events and what they NEED
2. **WARDROBE_GAP**: Name specific missing colors or categories (e.g., "you lack warm-toned bottoms") AND list similar items they own
3. **STYLE_UPGRADE**: Reference existing pieces BY NAME and suggest exact complementary items
4. **TRENDING**: Name trending style AND explain why THEIR specific aesthetic needs it
5. **COMPLETE_LOOK**: Reference saved outfits and name SPECIFIC pieces missing

Respond with JSON array of exactly 5 objects with SPECIFIC recommendations:
[
  {"text": "[Color] [fit] [garment] - [concrete reason naming specific items they own]", "site": "https://nordstrom.com", "search": "[specific search]", "strategy": "calendar"},
  ...
]`;

    try {
      const response = await fetch(`${API_BASE_URL}/ai/chat`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          user_id: userId,
          messages: [{role: 'user', content: SHOPPING_PROMPT}],
        }),
      });

      if (!response.ok) throw new Error('AI request failed');

      const data = await response.json();
      const aiText = data.reply || data.text || data.response || '';

      try {
        const parsed = JSON.parse(aiText.match(/\[[\s\S]*\]/)?.[0] || '[]');
        if (Array.isArray(parsed) && parsed.length > 0) {
          setAiShoppingAssistantSuggestions(parsed);
          setHasAiSuggestionsLoaded(true);
        }
      } catch {
        // Failed to parse shopping suggestions
      }
    } catch (err) {
      // Shopping suggestions fetch failed
    }
  }

  // Memoize currentTab to prevent unnecessary recalculations
  const currentTab = useMemo(
    () => tabs.find(t => t.id === currentTabId),
    [tabs, currentTabId],
  );
  const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
  const [showSaveMenu, setShowSaveMenu] = useState(false);
  const [showCollectionPicker, setShowCollectionPicker] = useState(false);
  const [showBookmarksModal, setShowBookmarksModal] = useState(false);
  const [showShareMenu, setShowShareMenu] = useState(false);
  const [activeBookmarksTab, setActiveBookmarksTab] = useState<
    'bookmarks' | 'history'
  >('bookmarks');
  const [showAutocomplete, setShowAutocomplete] = useState(false);
  const [isInputFocused, setIsInputFocused] = useState(false);
  const [showAutofillSettings, setShowAutofillSettings] = useState(false);
  const [historySearchQuery, setHistorySearchQuery] = useState('');

  // Image long-press save state
  const [longPressedImageUrl, setLongPressedImageUrl] = useState<string | null>(
    null,
  );
  const [showImageSaveModal, setShowImageSaveModal] = useState(false);
  const [showConsentModal, setShowConsentModal] = useState(false);

  // Drag and drop state for tabs
  const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
  const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
  const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
  const dragScale = useRef(new Animated.Value(1)).current;
  const tabPositions = useRef<
    {x: number; y: number; width: number; height: number}[]
  >([]);

  // GOLD: Tracking refs
  const pageStartTimeRef = useRef<number>(0);
  const sessionStartedRef = useRef<boolean>(false);
  const maxScrollDepthRef = useRef<number>(0);
  const previousUrlRef = useRef<string>('');
  const lastPageTextRef = useRef<string>('');

  // Debounce navigation state changes to prevent rapid URL toggling
  const navStateDebounceRef = useRef<NodeJS.Timeout | null>(null);
  const lastNavUrlRef = useRef<string>('');

  // GOLD #7 & #10: Track sizes and colors clicked on current page
  const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
  const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

  // Debug info display
  const [debugInfo, setDebugInfo] = useState<{
    price?: number;
    brand?: string;
    category?: string;
    pageTextLength?: number;
    pageTextPreview?: string;
    inputText?: string;
    timestamp?: number;
    sizesViewed?: string[];
    colorsViewed?: string[];
  } | null>(null);
  const [showDebugDetail, setShowDebugDetail] = useState(false);

  // Initialize with a tab if navigating with URL (wait for hydration)
  const initialUrlProcessedRef = useRef(false);
  useEffect(() => {
    if (_hasHydrated && initialUrl && !initialUrlProcessedRef.current) {
      initialUrlProcessedRef.current = true;
      // Check if this URL is already open in a tab
      const existingTab = tabs.find(t => t.url === initialUrl);
      if (existingTab) {
        // Switch to existing tab
        switchTab(existingTab.id);
      } else {
        // Add new tab with the URL
        addTab(initialUrl, 'New Tab');
      }
    }
  }, [_hasHydrated, initialUrl]);

  // Update input when tab changes (only when switching tabs, not during navigation)
  const lastTabIdRef = useRef(currentTabId);

  // Track last cart detection to prevent duplicates
  const lastCartDetectionRef = useRef<{url: string; timestamp: number} | null>(
    null,
  );
  // Track last purchase detection to prevent duplicates
  const lastPurchaseDetectionRef = useRef<{
    url: string;
    timestamp: number;
  } | null>(null);
  useEffect(() => {
    // Only update inputValue when we actually switch to a different tab
    if (currentTabId !== lastTabIdRef.current) {
      lastTabIdRef.current = currentTabId;
      if (currentTab?.url) {
        setInputValue(currentTab.url);
      }
    }
  }, [currentTabId]);

  // Tracking Consent Prompt - show styled modal when user first opens browser
  useEffect(() => {
    if (_hasHydrated && trackingConsent === 'pending') {
      // Small delay to let screen render first
      const timer = setTimeout(() => {
        setShowConsentModal(true);
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [_hasHydrated, trackingConsent]);

  const handleConsentAccept = useCallback(() => {
    setTrackingConsent('accepted');
    setShowConsentModal(false);
  }, [setTrackingConsent]);

  const handleConsentDecline = useCallback(() => {
    setTrackingConsent('declined');
    setShowConsentModal(false);
  }, [setTrackingConsent]);

  // GOLD #1, #3: Start session on first load (don't end it on unmount)
  useEffect(() => {
    if (!sessionStartedRef.current) {
      const currentSession = useShoppingStore.getState().currentSessionId;
      if (!currentSession) {
        useShoppingStore.getState().startSession();
      }
      sessionStartedRef.current = true;
    }
  }, []);

  // ðŸ›ï¸ Fetch AI Shopping Suggestions once per app session (or if stale after 24h)
  const fetchingRef = useRef(false);
  useEffect(() => {
    if (
      userId &&
      (!hasAiSuggestionsLoaded || isAiSuggestionsStale()) &&
      !fetchingRef.current
    ) {
      fetchingRef.current = true;
      fetchShoppingAssistantSuggestions().finally(() => {
        fetchingRef.current = false;
      });
    }
  }, [userId, hasAiSuggestionsLoaded]);

  // iOS Password AutoFill handles password injection automatically via iCloud Keychain
  // No JavaScript injection needed - iOS fills passwords directly into WebView forms

  // GOLD #1, #9: Track dwell time and scroll depth when page loads
  useEffect(() => {
    // Skip if no URL or if we've already tracked this URL (ignore www/trailing slash differences)
    if (!currentTab?.url) return;

    // Normalize for comparison to avoid www/trailing slash loops
    const normalizeForCompare = (url: string) => {
      try {
        const u = new URL(url);
        return (
          u.origin.replace('://www.', '://') +
          u.pathname.replace(/\/$/, '') +
          u.search
        );
      } catch {
        return url;
      }
    };

    if (
      previousUrlRef.current &&
      normalizeForCompare(currentTab.url) ===
        normalizeForCompare(previousUrlRef.current)
    ) {
      return;
    }

    // If we had a previous page, save its metrics before moving to new page
    if (previousUrlRef.current && pageStartTimeRef.current > 0) {
      const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
      useShoppingStore
        .getState()
        .updateHistoryMetadata(previousUrlRef.current, {
          dwellTime: dwell,
          scrollDepth: maxScrollDepthRef.current,
        });
    }

    // Now start tracking the new page
    pageStartTimeRef.current = Date.now();
    maxScrollDepthRef.current = 0; // Reset scroll depth for new page
    previousUrlRef.current = currentTab.url; // Store for next page transition
    const source = getDomain(currentTab.url);
    // Extract brand from URL/title for history tracking
    const brand = shoppingAnalytics.extractBrand(
      currentTab.title || '',
      currentTab.url,
    );
    useShoppingStore
      .getState()
      .addToHistory(
        sanitizeUrlForAnalytics(currentTab.url),
        currentTab.title || 'New Tab',
        source,
        brand,
      );

    // Record as a product view interaction
    useShoppingStore
      .getState()
      .recordProductInteraction(currentTab.url, 'view');
  }, [currentTab?.url]);

  // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
  useEffect(() => {
    if (speech && isHoldingMic === false) {
      setInputValue(speech);
    }
  }, [speech]);

  const getDomain = (url: string) => {
    try {
      const urlObj = new URL(url);
      return urlObj.hostname.replace('www.', '');
    } catch {
      return url || 'New Tab';
    }
  };

  // Normalize URLs for comparison (ignore www and trailing slash differences)
  const normalizeUrlForComparison = (url: string) => {
    try {
      const urlObj = new URL(url);
      // Remove www. and trailing slash for comparison
      return (
        urlObj.origin.replace('://www.', '://') +
        urlObj.pathname.replace(/\/$/, '') +
        urlObj.search
      );
    } catch {
      return url;
    }
  };

  // Check if two URLs are effectively the same (ignoring www and trailing slash)
  const isSameUrl = (url1: string, url2: string) => {
    return normalizeUrlForComparison(url1) === normalizeUrlForComparison(url2);
  };

  const extractImageFromPage = (url: string): string => {
    // Use DuckDuckGo favicon service (more reliable)
    try {
      const domain = new URL(url).hostname;
      // DuckDuckGo favicon service
      return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
    } catch {
      return '';
    }
  };

  const normalizeUrl = (text: string): string => {
    const normalized = text.trim();
    if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
      return normalized;
    }
    // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
    // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
    if (normalized.includes('.') && !normalized.includes(' ')) {
      // Check if it has a valid TLD or domain structure
      const parts = normalized.split('.');
      const lastPart = parts[parts.length - 1];
      // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
      if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
        // Looks like a valid domain
        return `https://${normalized}`;
      }
    }
    // Treat as search query
    return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
  };

  const handleSubmit = () => {
    if (inputValue.trim()) {
      const normalized = inputValue.trim();
      const newUrl = normalizeUrl(normalized);

      // Track search if user typed a search query (not a full URL)
      if (
        !normalized.startsWith('http://') &&
        !normalized.startsWith('https://') &&
        !normalized.includes('.')
      ) {
        // This is a plain search query
        addSearch(normalized);
      } else if (newUrl.includes('google.com/search?q=')) {
        // User typed a domain-like query that got converted to Google search
        try {
          const query = new URLSearchParams(new URL(newUrl).search).get('q');
          if (query) {
            addSearch(query);
          }
        } catch (e) {
          // URL parsing failed, skip search tracking
        }
      }

      if (currentTab) {
        updateTab(currentTab.id, newUrl, currentTab.title);
      } else {
        addTab(newUrl, 'New Tab');
      }
    }
    Keyboard.dismiss();
  };

  // Set URL and navigate - same flow as manual typing
  const handleQuickShop = useCallback(
    (url: string) => {
      const newUrl = normalizeUrl(url);
      setInputValue(newUrl);
      if (currentTab) {
        updateTab(currentTab.id, newUrl, getDomain(url));
      } else {
        addTab(newUrl, getDomain(url));
      }
    },
    [currentTab, updateTab, addTab],
  );

  // Autocomplete suggestions from history
  const autocompleteSuggestions = React.useMemo(() => {
    if (!isInputFocused || inputValue.length < 1) return [];
    const searchTerm = inputValue.toLowerCase();
    return history
      .filter(
        item =>
          item.url.toLowerCase().includes(searchTerm) ||
          item.title.toLowerCase().includes(searchTerm),
      )
      .sort((a, b) => b.visitCount - a.visitCount)
      .slice(0, 5);
  }, [history, inputValue, isInputFocused]);

  const handleAutocompleteSelect = (url: string) => {
    setInputValue(url);
    setShowAutocomplete(false);
    if (currentTab) {
      updateTab(currentTab.id, url, currentTab.title);
    } else {
      addTab(url, 'New Tab');
    }
    Keyboard.dismiss();
  };

  const handleSaveMenuOpen = () => {
    if (!currentTab || !currentTab.url) return;
    triggerHaptic('impactLight');
    setShowSaveMenu(true);
  };

  const handleAddToBookmarks = async () => {
    if (!currentTab) return;
    triggerHaptic('impactLight');
    if (bookmarked) {
      const bookmark = bookmarks.find(b => b.url === currentTab.url);
      if (bookmark) {
        removeBookmark(bookmark.id);
      }
    } else {
      // Capture screenshot for the bookmark preview
      let screenshot: string | undefined;
      if (containerRef.current) {
        try {
          screenshot = await captureRef(containerRef, {
            format: 'jpg',
            quality: 0.7,
            result: 'data-uri',
          });
        } catch (e) {
          console.log('Failed to capture bookmark screenshot:', e);
        }
      }

      // Try to extract page text right now via JavaScript injection
      // This provides fresh data at bookmark time
      if (webRef.current) {
        // Clear previous text to ensure we get fresh content
        lastPageTextRef.current = '';

        const extractScript = `
          (function() {
            try {
              const text = document.body.innerText.substring(0, 10000);
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'pageText',
                content: text,
                length: text.length,
                extracted: true
              }));
            } catch (e) {}
          })();
          true;
        `;
        webRef.current.injectJavaScript(extractScript);

        // Wait for message with timeout - poll until we get text or timeout
        const startTime = Date.now();
        while (!lastPageTextRef.current && Date.now() - startTime < 500) {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        console.log(
          '[Bookmark] Page text received:',
          lastPageTextRef.current?.length || 0,
          'chars',
        );
      }

      // GOLD: Enrich bookmark with gold data
      const bookmarkId = Date.now().toString();
      const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
      const category = shoppingAnalytics.extractCategory(
        currentTab.title || '',
        currentTab.url,
      );
      const brand = shoppingAnalytics.extractBrand(
        currentTab.title || '',
        currentTab.url,
      );

      // Extract price from title + URL + any cached page text
      let price = shoppingAnalytics.extractPrice(
        `${currentTab.title || ''} ${currentTab.url}`,
      );

      // If not found, try the page text we captured
      if (!price && lastPageTextRef.current) {
        price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
      }

      // GOLD #7 & #10: Extract unique sizes and colors clicked
      const sizesViewed = [
        ...new Set(sizesClickedRef.current.map(s => s.size)),
      ];
      const colorsViewed = [
        ...new Set(colorsClickedRef.current.map(c => c.color)),
      ];

      // DEBUG: Show what was extracted
      const inputText = `${currentTab.title || ''} ${currentTab.url}`;
      setDebugInfo({
        price,
        brand,
        category,
        pageTextLength: lastPageTextRef.current?.length || 0,
        pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
        inputText,
        timestamp: Date.now(),
        sizesViewed,
        colorsViewed,
      });

      addBookmark({
        id: bookmarkId,
        title: currentTab.title || getDomain(currentTab.url),
        url: currentTab.url,
        source: getDomain(currentTab.url),
        imageUrl: extractImageFromPage(currentTab.url),
        screenshot,
        addedAt: Date.now(),
        viewCount: 1,
        category, // GOLD #2
        brand, // GOLD #2b: Brand extracted from title/URL
        price, // GOLD #4: Initial price
        priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
        sizesViewed, // GOLD #7: Sizes clicked before bookmarking
        colorsViewed, // GOLD #10: Colors clicked before bookmarking
      });

      // Track as add-to-cart interaction if it's a cart page
      if (shoppingAnalytics.isCartUrl(currentTab.url)) {
        useShoppingStore
          .getState()
          .recordProductInteraction(currentTab.url, 'add_to_cart');

        // GOLD: Also record as a checkout_start event if on checkout page
        const isCheckout = /(checkout|payment|order)/.test(
          currentTab.url.toLowerCase(),
        );
        useShoppingStore.getState().recordCartEvent({
          type: isCheckout ? 'checkout_start' : 'add',
          timestamp: Date.now(),
          cartUrl: currentTab.url,
        });
      }

      // Record bookmark interaction
      useShoppingStore
        .getState()
        .recordProductInteraction(currentTab.url, 'bookmark');

      // DERIVED METRIC: Record time-to-action for bookmark
      useShoppingStore
        .getState()
        .recordTimeToAction(currentTab.url, 'bookmark', dwell);

      // GOLD #1, #9: Update history with dwell time and scroll depth
      useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
        dwellTime: dwell,
        scrollDepth: maxScrollDepthRef.current,
        isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
      });
    }
    setShowSaveMenu(false);
  };

  const handleAddToCollection = async (collectionId: string) => {
    if (!currentTab) return;
    triggerHaptic('impactLight');
    // Capture screenshot for the collection item preview
    let screenshot: string | undefined;
    if (containerRef.current) {
      try {
        screenshot = await captureRef(containerRef, {
          format: 'jpg',
          quality: 0.7,
          result: 'data-uri',
        });
      } catch (e) {
        console.log('Failed to capture collection item screenshot:', e);
      }
    }
    addItemToCollection(collectionId, {
      id: Date.now().toString(),
      title: currentTab.title || getDomain(currentTab.url),
      url: currentTab.url,
      source: getDomain(currentTab.url),
      imageUrl: extractImageFromPage(currentTab.url),
      screenshot,
      addedAt: Date.now(),
    });
    setShowCollectionPicker(false);
    setShowSaveMenu(false);
  };

  const handleShare = async () => {
    if (!currentTab || !currentTab.url) return;
    triggerHaptic('impactLight');
    try {
      await Share.share({
        url: currentTab.url,
        title: currentTab.title || getDomain(currentTab.url),
        message: `${currentTab.title || getDomain(currentTab.url)}\n${
          currentTab.url
        }`,
      });
      setShowSaveMenu(false);
      setShowShareMenu(false);
    } catch (error) {
      console.error('Error sharing:', error);
    }
  };

  const handleShareToNotes = () => {
    if (!currentTab || !currentTab.url) return;
    triggerHaptic('impactLight');
    setShowShareMenu(false);
    navigate('SaveNote', {
      url: currentTab.url,
      title: currentTab.title || getDomain(currentTab.url),
      content: '',
    });
  };

  const handleShareButtonPress = () => {
    if (!currentTab || !currentTab.url) return;
    triggerHaptic('impactLight');
    setShowShareMenu(true);
  };

  const handleOpenBookmarks = () => {
    triggerHaptic('impactLight');
    setShowSaveMenu(false);
    setShowBookmarksModal(true);
  };

  const handleBookmarkNavigation = (url: string, title: string) => {
    triggerHaptic('impactLight');
    if (currentTab) {
      updateTab(currentTab.id, url, title);
    } else {
      addTab(url, title);
    }
    setShowBookmarksModal(false);
  };

  // iOS Password AutoFill handles password saving automatically via iCloud Keychain
  // When user submits a login form, iOS prompts to save password to iCloud Keychain
  // No app-level password capture needed

  // Extract and cache page text when page loads, and inject size/color click listeners
  const handleWebViewLoadEnd = useCallback(() => {
    if (!webRef.current) return;

    // Security: Only inject scripts on HTTPS pages
    const currentUrl = currentTab?.url?.toLowerCase() || '';
    if (!currentUrl.startsWith('https://')) {
      console.log('[SECURITY] Skipping script injection on non-HTTPS page');
      return;
    }

    // Security: Skip injection on login/auth AND payment/checkout pages
    const sensitivePagePatterns = [
      // Auth pages
      '/login',
      '/signin',
      '/sign-in',
      '/auth',
      '/authenticate',
      '/password',
      '/account/login',
      '/oauth',
      '/sso',
      // Payment/checkout pages (PCI safety)
      '/checkout',
      '/payment',
      '/billing',
      '/pay/',
      '/order',
      '/confirm',
      '/purchase',
      '/cart/checkout',
      '/secure/',
    ];
    const isSensitivePage = sensitivePagePatterns.some(pattern =>
      currentUrl.includes(pattern),
    );
    if (isSensitivePage) {
      console.log('[SECURITY] Skipping script injection on sensitive page');
      return;
    }

    // Reset size/color tracking for new page
    sizesClickedRef.current = [];
    colorsClickedRef.current = [];

    const extractPageTextScript = `
      (function() {
        try {
          const text = document.body.innerText.substring(0, 5000);
          const data = {
            type: 'pageText',
            content: text,
            length: text.length,
            extracted: true
          };
          window.ReactNativeWebView.postMessage(JSON.stringify(data));
        } catch (err) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'pageText',
            content: '',
            error: err.message,
            extracted: false
          }));
        }
      })();
      true;
    `;

    // GOLD #7 & #10: Inject size/color click detection
    const sizeColorClickScript = `
      (function() {
        if (window.__styliqClickListenersAdded) return;
        window.__styliqClickListenersAdded = true;

        // Common size selector patterns across shopping sites
        const sizePatterns = [
          // Text patterns for sizes
          /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
          /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
          /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
          /^(One Size|OS|OSFA|Free Size)$/i,
          /^(Small|Medium|Large|Extra Large)$/i,
        ];

        // Common color patterns
        const colorPatterns = [
          /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
          /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
        ];

        const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

        function isSize(text) {
          const trimmed = text.trim();
          if (!trimmed || trimmed.length > 20) return false;
          return sizePatterns.some(pattern => pattern.test(trimmed));
        }

        function isColor(text) {
          const trimmed = text.trim().toLowerCase();
          if (!trimmed || trimmed.length > 30) return false;
          if (commonColors.includes(trimmed)) return true;
          return colorPatterns.some(pattern => pattern.test(trimmed));
        }

        function getColorFromElement(el) {
          // Check text content
          const text = el.textContent?.trim() || '';
          if (isColor(text)) return text;

          // Check aria-label
          const ariaLabel = el.getAttribute('aria-label') || '';
          if (isColor(ariaLabel)) return ariaLabel;

          // Check title
          const title = el.getAttribute('title') || '';
          if (isColor(title)) return title;

          // Check data attributes
          const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
          if (isColor(dataColor)) return dataColor;

          // Check background color (color swatches)
          const bgColor = window.getComputedStyle(el).backgroundColor;
          if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
            // Return a simplified color description
            return 'color-swatch';
          }

          return null;
        }

        // Add click listener to document
        document.addEventListener('click', function(e) {
          const target = e.target;
          if (!target) return;

          // Check clicked element and its parents (up to 3 levels)
          let el = target;
          for (let i = 0; i < 3 && el; i++) {
            const text = el.textContent?.trim() || '';

            // Check for size click
            if (isSize(text)) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'sizeClick',
                size: text.toUpperCase()
              }));
              return;
            }

            // Check for color click
            const color = getColorFromElement(el);
            if (color) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'colorClick',
                color: color
              }));
              return;
            }

            el = el.parentElement;
          }
        }, true);
      })();
      true;
    `;

    // GOLD: Cart detection script - extracts item count and estimated total
    const cartDetectionScript = `
      (function() {
        function detectCart() {
          try {
            // Look for common cart indicators
            const pageUrl = window.location.href;
            const isCartPage = /(cart|bag|basket|checkout|gp\\/cart)/.test(pageUrl.toLowerCase());

            if (!isCartPage) return false;

            // Extract item count from common patterns
            let itemCount = 0;

            // Pattern 1: Amazon-specific - look for cart count in various places
            const amazonCartCount = document.querySelector('#nav-cart-count, .nav-cart-count, [data-csa-c-type="widget"][data-csa-c-slot-id="nav-cart-count"]');
            if (amazonCartCount) {
              const count = parseInt(amazonCartCount.textContent.trim());
              if (!isNaN(count)) itemCount = count;
            }

            // Pattern 2: "Items in cart: X" or "Cart (X)"
            if (itemCount === 0) {
              const countMatch = document.body.innerText.match(/(?:cart|bag|basket)\\s*\\(?(\\d+)\\)?/i);
              if (countMatch) itemCount = parseInt(countMatch[1]);
            }

            // Pattern 3: Look for cart badge/counter elements
            if (itemCount === 0) {
              const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"], [class*="qty"]');
              for (const badge of badges) {
                const text = badge.textContent.trim();
                const match = text.match(/^\\d+$/);
                if (match) {
                  itemCount = parseInt(match[0]);
                  break;
                }
              }
            }

            // Extract estimated total - Amazon specific patterns first
            let estimatedTotal = 0;

            // Amazon subtotal patterns
            const amazonSubtotal = document.querySelector('#sc-subtotal-amount-activecart, .sc-subtotal-amount, [data-name="Subtotal"]');
            if (amazonSubtotal) {
              const priceMatch = amazonSubtotal.textContent.match(/[$Â£â‚¬Â¥]\\s*([\\d,]+\\.?\\d*)/);
              if (priceMatch) {
                estimatedTotal = parseFloat(priceMatch[1].replace(/,/g, ''));
              }
            }

            // Generic total patterns
            if (estimatedTotal === 0) {
              const totalMatch = document.body.innerText.match(/(?:subtotal|total|cart total)[:\\s]*[$Â£â‚¬Â¥]\\s*([\\d,]+\\.?\\d*)/i);
              if (totalMatch) {
                estimatedTotal = parseFloat(totalMatch[1].replace(/,/g, ''));
              }
            }

            // Only send if we found something meaningful
            if (itemCount > 0 || estimatedTotal > 0) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'cartDetected',
                itemCount: itemCount,
                estimatedTotal: estimatedTotal,
                cartUrl: pageUrl
              }));
              return true;
            }
            return false;
          } catch (e) {
            console.log('Cart detection error:', e);
            return false;
          }
        }

        // Try immediately
        if (!detectCart()) {
          // Retry after delays for dynamically loaded content
          setTimeout(detectCart, 500);
          setTimeout(detectCart, 1500);
          setTimeout(detectCart, 3000);
        }
      })();
      true;
    `;

    // GOLD: Purchase completion detection - detects order confirmation pages
    // IMPORTANT: Must be strict to avoid false positives on cart pages
    const purchaseDetectionScript = `
      (function() {
        try {
          const pageUrl = window.location.href.toLowerCase();
          const pageText = document.body.innerText.toLowerCase();
          const pageTitle = document.title.toLowerCase();

          // First, explicitly exclude cart/checkout pages that are NOT confirmations
          const isCartPage = /(cart|bag|basket|checkout|payment|shipping|billing)\\b/.test(pageUrl);
          const isCheckoutInProgress = /(enter.*address|payment.*method|select.*shipping|review.*order|place.*order|continue.*checkout|proceed.*checkout)/.test(pageText);

          if (isCartPage && isCheckoutInProgress) {
            // This is a checkout page in progress, not a confirmation
            return;
          }

          // Purchase completion indicators - must be VERY specific
          // Require order/confirmation number or specific completion language
          const hasOrderNumber = /(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+[A-Z0-9-]{4,}/i.test(pageText);
          const hasExplicitConfirmation = /(your order has been (placed|confirmed|received)|order successfully placed|purchase complete|thank you for your order|order confirmation|we've received your order)/.test(pageText);
          const isConfirmationUrl = /(order-confirmation|order-complete|order-success|checkout-success|thank-you.*order|confirmation.*complete)/.test(pageUrl);

          // Require at least 2 strong signals to confirm a purchase
          const signals = [hasOrderNumber, hasExplicitConfirmation, isConfirmationUrl].filter(Boolean).length;
          const isPurchaseConfirmation = signals >= 2 || (hasExplicitConfirmation && hasOrderNumber);

          if (isPurchaseConfirmation) {
            // Extract purchase details if available
            let orderNumber = '';
            let totalAmount = 0;

            // Try to find order number
            const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
            if (orderMatch) orderNumber = orderMatch[1];

            // Try to find total amount
            const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
            if (totalMatch) {
              const totalStr = totalMatch[1].replace(',', '.');
              totalAmount = parseFloat(totalStr);
            }

            // Count items (look for common patterns)
            let itemCount = 0;
            const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
            if (itemMatch) itemCount = parseInt(itemMatch[1]);

            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'purchaseComplete',
              orderNumber: orderNumber,
              totalAmount: totalAmount,
              itemCount: itemCount,
              purchaseUrl: pageUrl,
              timestamp: Date.now()
            }));
          }
        } catch (e) {}
      })();
      true;
    `;

    // Image long-press detection script
    const imageLongPressScript = `
      (function() {
        if (window.__styliqImageLongPressAdded) return;
        window.__styliqImageLongPressAdded = true;

        let longPressTimer = null;
        let touchedImage = null;

        document.addEventListener('touchstart', function(e) {
          const target = e.target;
          if (target.tagName === 'IMG' && target.src) {
            touchedImage = target;
            longPressTimer = setTimeout(function() {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'imageLongPress',
                imageUrl: touchedImage.src,
                alt: touchedImage.alt || ''
              }));
            }, 500);
          }
        }, {passive: true});

        document.addEventListener('touchend', function() {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          touchedImage = null;
        });

        document.addEventListener('touchmove', function() {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        });
      })();
      true;
    `;

    // iOS Password AutoFill handles password detection and saving automatically
    // No JavaScript injection needed - iOS manages passwords via iCloud Keychain

    webRef.current.injectJavaScript(extractPageTextScript);
    webRef.current.injectJavaScript(sizeColorClickScript);
    webRef.current.injectJavaScript(cartDetectionScript);
    webRef.current.injectJavaScript(purchaseDetectionScript);
    webRef.current.injectJavaScript(imageLongPressScript);
  }, [currentTab?.url]);

  // Allowed message types from WebView (security allowlist)
  const ALLOWED_MESSAGE_TYPES = [
    'pageText',
    'sizeClick',
    'colorClick',
    'cartDetected',
    'purchaseComplete',
    'imageLongPress',
  ] as const;
  const MAX_MESSAGE_SIZE = 200 * 1024; // 200KB limit

  // Handle messages from WebView
  const handleWebViewMessage = useCallback(
    (event: any) => {
      try {
        // SECURITY: Rate limiting - max 100 messages per second
        const now = Date.now();
        if (now - messageRateLimiter.current.lastReset > 1000) {
          messageRateLimiter.current = {count: 0, lastReset: now};
        }
        messageRateLimiter.current.count++;
        if (messageRateLimiter.current.count > 100) {
          // Only log once per second to avoid log spam
          if (messageRateLimiter.current.count === 101) {
            console.warn('[SECURITY] Message rate limit exceeded - dropping messages');
          }
          return;
        }

        // Security: Payload size limit
        const rawData = event.nativeEvent.data;
        if (typeof rawData !== 'string' || rawData.length > MAX_MESSAGE_SIZE) {
          console.log('[SECURITY] Blocked oversized message:', rawData?.length);
          return;
        }

        const data = JSON.parse(rawData);

        // Security: Type allowlist check
        if (
          !data.type ||
          !ALLOWED_MESSAGE_TYPES.includes(
            data.type as (typeof ALLOWED_MESSAGE_TYPES)[number],
          )
        ) {
          console.log('[SECURITY] Blocked unknown message type:', data.type);
          return;
        }

        if (data.type === 'pageText') {
          lastPageTextRef.current = data.content || '';
          console.log(
            '[MSG] Page text received:',
            data.length,
            'chars, extracted:',
            data.extracted,
          );
        } else if (data.type === 'sizeClick') {
          // GOLD #7: Track size clicks with timestamp
          const sizeEntry = {size: data.size, timestamp: Date.now()};
          sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
          console.log(
            '[MSG] Size clicked:',
            data.size,
            'Total:',
            sizesClickedRef.current.length,
          );
        } else if (data.type === 'colorClick') {
          // GOLD #10: Track color clicks with timestamp
          const colorEntry = {color: data.color, timestamp: Date.now()};
          colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
          console.log(
            '[MSG] Color clicked:',
            data.color,
            'Total:',
            colorsClickedRef.current.length,
          );
        } else if (data.type === 'cartDetected') {
          // GOLD: Cart detection with item count and total
          console.log('[MSG] Cart detected:', {
            itemCount: data.itemCount,
            estimatedTotal: data.estimatedTotal,
          });

          // Deduplicate: skip if same cart detected within 10 seconds
          const now = Date.now();
          const lastDetection = lastCartDetectionRef.current;
          if (
            lastDetection &&
            lastDetection.url === data.cartUrl &&
            now - lastDetection.timestamp < 10000
          ) {
            console.log('[MSG] Skipping duplicate cart detection');
            return;
          }
          lastCartDetectionRef.current = {url: data.cartUrl, timestamp: now};

          // Record cart view event
          useShoppingStore.getState().recordCartEvent({
            type: 'cart_view',
            timestamp: now,
            cartUrl: data.cartUrl,
            itemCount: data.itemCount,
            cartValue: data.estimatedTotal,
          });

          // DERIVED METRIC: Record time-to-action for cart
          const cartDwell = Math.round(
            (Date.now() - pageStartTimeRef.current) / 1000,
          );
          useShoppingStore
            .getState()
            .recordTimeToAction(data.cartUrl, 'cart', cartDwell);
        } else if (data.type === 'purchaseComplete') {
          // GOLD: Purchase completion detected on order confirmation page
          console.log('[MSG] Purchase complete detected:', {
            orderNumber: data.orderNumber,
            totalAmount: data.totalAmount,
            itemCount: data.itemCount,
          });

          // Deduplicate: skip if same purchase URL detected within 60 seconds
          // (purchase confirmation pages often reload/re-render)
          const now = Date.now();
          const lastPurchase = lastPurchaseDetectionRef.current;
          if (
            lastPurchase &&
            lastPurchase.url === data.purchaseUrl &&
            now - lastPurchase.timestamp < 60000
          ) {
            console.log('[MSG] Skipping duplicate purchase detection');
            return;
          }
          lastPurchaseDetectionRef.current = {
            url: data.purchaseUrl,
            timestamp: now,
          };

          // Record purchase completion event
          useShoppingStore.getState().recordCartEvent({
            type: 'checkout_complete',
            timestamp: data.timestamp || Date.now(),
            cartUrl: data.purchaseUrl,
            itemCount: data.itemCount,
            cartValue: data.totalAmount,
          });
        } else if (data.type === 'imageLongPress') {
          // Handle image long-press - show save options
          console.log('[MSG] Image long-pressed:', data.imageUrl);
          setLongPressedImageUrl(data.imageUrl);
          setShowImageSaveModal(true);
          triggerHaptic('impactMedium');
        }
        // iOS Password AutoFill handles password saving automatically via iCloud Keychain
        // No app-level password handling needed
      } catch (e) {
        console.log('[MSG] Error parsing message:', e);
      }
    },
    [],
  );

  // Track last scroll Y for nav bar hide/show
  const lastNavScrollY = useRef(0);
  const bottomNavTranslateY = useRef(new Animated.Value(0)).current;
  const isBottomNavHidden = useRef(false);
  const NAV_HEIGHT = 100;
  const SCROLL_THRESHOLD = 3;

  // GOLD #9: Track scroll depth in WebView + nav bar hide/show
  const handleWebViewScroll = useCallback(
    (event: any) => {
      try {
        const {contentOffset, contentSize, layoutMeasurement} =
          event.nativeEvent;
        const diff = contentOffset.y - lastNavScrollY.current;

        // Scrolling down (up on screen) - hide nav
        if (
          diff > SCROLL_THRESHOLD &&
          !isBottomNavHidden.current &&
          contentOffset.y > 10
        ) {
          isBottomNavHidden.current = true;
          Animated.timing(bottomNavTranslateY, {
            toValue: NAV_HEIGHT + insets.bottom,
            duration: 300,
            easing: Easing.out(Easing.cubic),
            useNativeDriver: true,
          }).start();
        }
        // Scrolling up (down on screen) - show nav
        else if (diff < -SCROLL_THRESHOLD && isBottomNavHidden.current) {
          isBottomNavHidden.current = false;
          Animated.timing(bottomNavTranslateY, {
            toValue: 0,
            duration: 300,
            easing: Easing.out(Easing.cubic),
            useNativeDriver: true,
          }).start();
        }

        lastNavScrollY.current = contentOffset.y;

        if (contentSize.height > 0) {
          const scrollPosition = contentOffset.y;
          const viewportHeight = layoutMeasurement.height;
          const contentHeight = contentSize.height;
          // Calculate scroll depth as percentage (0-100)
          const scrollDepth = Math.min(
            100,
            Math.round(
              ((scrollPosition + viewportHeight) / contentHeight) * 100,
            ),
          );
          // Update max scroll depth reached
          if (scrollDepth > maxScrollDepthRef.current) {
            maxScrollDepthRef.current = scrollDepth;
          }
        }
      } catch (e) {
        // Silently fail if scroll metrics unavailable
      }
    },
    [bottomNavTranslateY, insets.bottom],
  );

  const captureCurrentTabScreenshot = useCallback(async () => {
    if (!containerRef.current || !currentTab || !currentTab.url) {
      console.log('Screenshot skipped - no containerRef or currentTab');
      return;
    }
    try {
      console.log('Capturing screenshot for tab:', currentTab.id);
      const uri = await captureRef(containerRef, {
        format: 'jpg',
        quality: 0.7,
        result: 'data-uri',
      });
      console.log('Screenshot captured, length:', uri?.length);
      if (uri) {
        updateTabScreenshot(currentTab.id, uri);
        console.log('Screenshot saved to tab');
      }
    } catch (error) {
      console.log('Screenshot capture error:', error);
    }
  }, [currentTab, updateTabScreenshot]);

  const openTabsView = async () => {
    triggerHaptic('impactLight');
    // Capture screenshot of current tab before showing tabs view
    await captureCurrentTabScreenshot();
    setShowTabsView(true);
    Animated.spring(tabsViewScale, {
      toValue: 1,
      useNativeDriver: true,
      tension: 50,
      friction: 8,
    }).start();
  };

  const closeTabsView = () => {
    Animated.timing(tabsViewScale, {
      toValue: 0,
      duration: 200,
      useNativeDriver: true,
    }).start(() => setShowTabsView(false));
  };

  const handleSelectTab = (tabId: string) => {
    if (draggingIndex !== null) return; // Don't select while dragging
    triggerHaptic('impactLight');
    switchTab(tabId);
    closeTabsView();
  };

  const handleCloseTab = (tabId: string) => {
    triggerHaptic('impactMedium');
    removeTab(tabId);
  };

  const handleNewTab = () => {
    triggerHaptic('impactLight');
    addTab('', 'New Tab');
    closeTabsView();
  };

  // Drag and drop handlers for tab reordering
  const handleLongPress = (index: number) => {
    triggerHaptic('impactHeavy');
    setDraggingIndex(index);
    // Scale up the dragged item
    Animated.spring(dragScale, {
      toValue: 1.05,
      useNativeDriver: true,
    }).start();
  };

  const handleDragMove = (
    index: number,
    gestureState: {dx: number; dy: number},
  ) => {
    if (draggingIndex === null) return;

    dragAnimatedValue.setValue({
      x: gestureState.dx,
      y: gestureState.dy,
    });

    // Calculate which tab we're hovering over
    const currentPos = tabPositions.current[draggingIndex];
    if (!currentPos) return;

    const newX = currentPos.x + gestureState.dx;
    const newY = currentPos.y + gestureState.dy;

    // Find the target index based on position
    let targetIndex = draggingIndex;
    for (let i = 0; i < tabPositions.current.length; i++) {
      const pos = tabPositions.current[i];
      if (
        newX >= pos.x - pos.width / 2 &&
        newX <= pos.x + pos.width * 1.5 &&
        newY >= pos.y - pos.height / 2 &&
        newY <= pos.y + pos.height * 1.5
      ) {
        targetIndex = i;
        break;
      }
    }

    if (targetIndex !== draggedOverIndex) {
      setDraggedOverIndex(targetIndex);
      if (targetIndex !== draggingIndex) {
        triggerHaptic('impactLight');
      }
    }
  };

  const handleDragEnd = () => {
    if (
      draggingIndex !== null &&
      draggedOverIndex !== null &&
      draggingIndex !== draggedOverIndex
    ) {
      reorderTabs(draggingIndex, draggedOverIndex);
      triggerHaptic('impactMedium');
    }

    // Reset animations
    Animated.parallel([
      Animated.spring(dragScale, {
        toValue: 1,
        useNativeDriver: true,
      }),
      Animated.spring(dragAnimatedValue, {
        toValue: {x: 0, y: 0},
        useNativeDriver: true,
      }),
    ]).start();

    setDraggingIndex(null);
    setDraggedOverIndex(null);
  };

  const createPanResponder = (index: number) => {
    return PanResponder.create({
      onStartShouldSetPanResponder: () => false,
      onMoveShouldSetPanResponder: () => draggingIndex === index,
      onPanResponderMove: (_, gestureState) => {
        handleDragMove(index, gestureState);
      },
      onPanResponderRelease: () => {
        handleDragEnd();
      },
      onPanResponderTerminate: () => {
        handleDragEnd();
      },
    });
  };

  const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
    const {x, y, width, height} = event.nativeEvent.layout;
    tabPositions.current[index] = {x, y, width, height};
  };

  const styles = StyleSheet.create({
    container: {
      flex: 1,
      backgroundColor: theme.colors.background,
    },
    headerTint: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      // height: insets.top + 55,
      // backgroundColor: 'rgba(0, 0, 0, 0.26)',
      zIndex: 998,
    },
    header: {
      position: 'absolute',
      top: insets.top + 53,
      left: 0,
      right: 0,
      zIndex: 999,
      paddingHorizontal: 12,
      paddingVertical: 2,
      // backgroundColor: 'red',
    },
    urlBar: {
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: 'rgba(0, 0, 0, 0.65)',
      borderRadius: 25,
      borderWidth: tokens.borderWidth.md,
      borderColor: theme.colors.foreground,
      paddingHorizontal: 14,
      height: 50,
    },
    urlInput: {
      flex: 1,
      fontSize: 15,
      color: theme.colors.foreground,
      padding: 0,
    },
    iconButton: {
      padding: 4,
      marginLeft: 8,
    },
    tabsButton: {
      marginLeft: 8,
      width: 28,
      height: 24,
      borderRadius: 6,
      borderWidth: 2,
      borderColor: theme.colors.foreground2,
      justifyContent: 'center',
      alignItems: 'center',
    },
    tabsCount: {
      fontSize: 12,
    },
    // Bottom navbar styles - pill shaped like main BottomNavigation
    bottomNavContainer: {
      position: 'absolute',
      bottom: 0,
      left: 0,
      right: 0,
      zIndex: 1000,
      paddingBottom: insets.bottom < 20 ? 10 : 0,
    },
    bottomNavPill: {
      flexDirection: 'row',
      justifyContent: 'space-around',
      alignItems: 'center',
      width: '90%',
      alignSelf: 'center',
      borderRadius: 50,
      height: 55,
      borderWidth: tokens.borderWidth.md,
      borderColor: theme.colors.muted,
      overflow: 'hidden',
      shadowColor: '#000',
      shadowOpacity: 0.2,
      shadowRadius: 12,
      shadowOffset: {width: 0, height: 4},
      backgroundColor: 'rgba(0, 0, 0, 0.35)',
      marginBottom: insets.bottom < 20 ? 10 : 25,
    },
    bottomNavPillFallback: {
      flexDirection: 'row',
      justifyContent: 'space-around',
      alignItems: 'center',
      width: '90%',
      alignSelf: 'center',
      borderRadius: 50,
      height: 55,
      borderWidth: tokens.borderWidth.md,
      borderColor: theme.colors.muted,
      overflow: 'hidden',
      shadowColor: '#000',
      shadowOpacity: 0.2,
      shadowRadius: 12,
      shadowOffset: {width: 0, height: 4},
      backgroundColor: 'rgba(0, 0, 0, 0.7)',
      marginBottom: insets.bottom < 20 ? 10 : 25,
    },
    bottomNavItem: {
      flex: 1,
      alignItems: 'center',
      justifyContent: 'center',
      paddingVertical: 8,
    },
    tabsButtonNav: {
      width: 28,
      height: 24,
      borderRadius: 6,
      borderWidth: 2,
      borderColor: theme.colors.foreground2,
      justifyContent: 'center',
      alignItems: 'center',
    },
    tabsCountNav: {
      fontSize: 12,
      fontWeight: '700',
      color: theme.colors.foreground2,
    },
    autocompleteContainer: {
      backgroundColor: theme.colors.surface,
      borderRadius: 10,
      marginTop: 8,
      borderWidth: 1,
      borderColor: theme.colors.surfaceBorder,
      overflow: 'hidden',
    },
    autocompleteItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 10,
      paddingHorizontal: 12,
      borderBottomWidth: 1,
      borderBottomColor: theme.colors.surfaceBorder,
    },
    autocompleteIcon: {
      marginRight: 10,
    },
    autocompleteTextContainer: {
      flex: 1,
    },
    autocompleteTitle: {
      fontSize: 14,
      fontWeight: '500',
      color: theme.colors.foreground,
      marginBottom: 2,
    },
    autocompleteUrl: {
      fontSize: 12,
      color: theme.colors.foreground3,
    },
    landingTitle: {
      fontSize: 18,
      fontWeight: '600',
      color: theme.colors.foreground,
      marginHorizontal: 16,
      marginTop: 24,
      marginBottom: 16,
    },
    shoppingGrid: {
      flexDirection: 'row',
      flexWrap: 'wrap',
      paddingHorizontal: 8,
    },
    shoppingButton: {
      alignItems: 'center',
      justifyContent: 'center',
      margin: 8,
      padding: 16,
      borderRadius: 12,
      backgroundColor: theme.colors.surface,
      borderWidth: 1,
      borderColor: theme.colors.surfaceBorder,
      width: (screenWidth - 48) / 2,
    },
    shoppingButtonText: {
      color: theme.colors.foreground,
      fontSize: 14,
      fontWeight: '500',
      marginTop: 8,
    },
    // Tabs View Overlay
    tabsOverlay: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: theme.colors.background,
      zIndex: 1000,
    },
    tabsHeader: {
      paddingTop: insets.top + 4,
      paddingHorizontal: 16,
      paddingBottom: 6,
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginTop: 60,
    },
    tabsHeaderTitle: {
      fontSize: 17,
      fontWeight: '600',
      color: theme.colors.foreground,
    },
    tabsHeaderButton: {
      padding: 8,
    },
    tabsHeaderButtonText: {
      fontSize: 17,
      color: theme.colors.primary,
    },
    tabsGrid: {
      flexDirection: 'row',
      flexWrap: 'wrap',
      paddingHorizontal: 12,
      paddingTop: 4,
    },
    tabCard: {
      width: TAB_CARD_WIDTH,
      height: TAB_CARD_HEIGHT,
      margin: 6,
      borderRadius: 20,
      backgroundColor: theme.colors.surface,
      overflow: 'hidden',
      borderWidth: 2,
      borderColor: 'transparent',
    },
    tabCardActive: {
      borderColor: theme.colors.primary,
    },
    tabCardDragging: {
      shadowColor: '#000',
      shadowOffset: {width: 0, height: 8},
      shadowOpacity: 0.4,
      shadowRadius: 12,
      borderColor: theme.colors.primary,
    },
    tabCardHeader: {
      flexDirection: 'row',
      alignItems: 'center',
      justifyContent: 'space-between',
      paddingHorizontal: 10,
      paddingVertical: 8,
      backgroundColor: 'transparent',
    },
    tabCardTitle: {
      flex: 1,
      fontSize: 12,
      fontWeight: '500',
      color: '#fff',
    },
    tabCardClose: {
      padding: 2,
    },
    tabCardContent: {
      flex: 1,
      backgroundColor: 'transparent',
      justifyContent: 'flex-end',
      alignItems: 'center',
      paddingBottom: 8,
    },
    tabCardDomain: {
      fontSize: 13,
      fontWeight: '500',
      color: 'rgba(255, 255, 255, 0.9)',
      marginTop: 0,
    },
    newTabCard: {
      width: TAB_CARD_WIDTH,
      height: TAB_CARD_HEIGHT,
      margin: 6,
      borderRadius: 12,
      backgroundColor: theme.colors.surface,
      justifyContent: 'center',
      alignItems: 'center',
      borderWidth: 2,
      borderColor: theme.colors.surfaceBorder,
      borderStyle: 'dashed',
    },
    newTabText: {
      fontSize: 14,
      fontWeight: '500',
      color: theme.colors.foreground3,
      marginTop: 8,
    },
    bottomBar: {
      flexDirection: 'row',
      justifyContent: 'space-around',
      alignItems: 'center',
      paddingVertical: 12,
      paddingBottom: insets.bottom + 12,
      backgroundColor: theme.colors.surface,
      borderTopWidth: 1,
      borderTopColor: theme.colors.surfaceBorder,
    },
    // Save Menu Styles
    saveMenuOverlay: {
      flex: 1,
      backgroundColor: 'rgba(0,0,0,0.5)',
      justifyContent: 'flex-end',
    },
    saveMenuContent: {
      backgroundColor: theme.colors.surface,
      borderTopLeftRadius: 20,
      borderTopRightRadius: 20,
      paddingTop: 12,
      paddingBottom: insets.bottom + 20,
    },
    saveMenuHandle: {
      width: 36,
      height: 4,
      backgroundColor: theme.colors.foreground3,
      borderRadius: 2,
      alignSelf: 'center',
      marginBottom: 16,
    },
    saveMenuTitle: {
      fontSize: 16,
      fontWeight: '600',
      color: theme.colors.foreground,
      paddingHorizontal: 20,
      marginBottom: 12,
    },
    saveMenuItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 14,
      paddingHorizontal: 20,
    },
    saveMenuItemIcon: {
      width: 40,
      height: 40,
      borderRadius: 10,
      backgroundColor: theme.colors.background,
      justifyContent: 'center',
      alignItems: 'center',
      marginRight: 12,
    },
    saveMenuItemText: {
      flex: 1,
      fontSize: 16,
      color: theme.colors.foreground,
    },
    saveMenuItemCheck: {
      marginLeft: 8,
    },
    collectionItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 12,
      paddingHorizontal: 20,
    },
    collectionColor: {
      width: 32,
      height: 32,
      borderRadius: 8,
      marginRight: 12,
      justifyContent: 'center',
      alignItems: 'center',
    },
    collectionName: {
      flex: 1,
      fontSize: 15,
      color: theme.colors.foreground,
    },
    collectionCount: {
      fontSize: 13,
      color: theme.colors.foreground3,
    },
    // Bookmarks Modal Styles
    bookmarksModalContainer: {
      flex: 1,
      backgroundColor: theme.colors.background,
    },
    bookmarksModalHeader: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      paddingHorizontal: 16,
      paddingTop: 16,
      paddingBottom: 8,
      marginTop: 60,
    },
    bookmarksCloseButton: {
      padding: 8,
    },
    bookmarksMenuButton: {
      padding: 8,
    },
    bookmarksSearchContainer: {
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: theme.colors.surface,
      borderRadius: 10,
      marginHorizontal: 16,
      marginBottom: 16,
      paddingHorizontal: 12,
      height: 40,
    },
    bookmarksSearchIcon: {
      marginRight: 8,
    },
    bookmarksSearchInput: {
      flex: 1,
      fontSize: 15,
      color: theme.colors.foreground,
      padding: 0,
    },
    bookmarksSearchMic: {
      marginLeft: 8,
    },
    bookmarksModalContent: {
      flex: 1,
    },
    // Recently Saved Section
    recentlySavedSection: {
      marginBottom: 24,
    },
    sectionHeaderText: {
      fontSize: 16,
      fontWeight: '600',
      color: theme.colors.foreground,
      paddingHorizontal: 16,
      marginBottom: 12,
    },
    recentlySavedScroll: {
      paddingLeft: 16,
    },
    recentlySavedCard: {
      width: 160,
      marginRight: 12,
      backgroundColor: theme.colors.surface,
      borderRadius: 12,
      padding: 12,
    },
    recentlySavedPreview: {
      width: '100%',
      height: 100,
      backgroundColor: theme.colors.background,
      borderRadius: 8,
      justifyContent: 'center',
      alignItems: 'center',
      marginBottom: 8,
    },
    recentlySavedTitle: {
      fontSize: 13,
      fontWeight: '500',
      color: theme.colors.foreground,
      marginBottom: 4,
    },
    recentlySavedUrl: {
      fontSize: 11,
      color: theme.colors.foreground3,
      marginBottom: 6,
    },
    recentlySavedBadge: {
      flexDirection: 'row',
      alignItems: 'center',
      backgroundColor: theme.colors.background,
      alignSelf: 'flex-start',
      paddingHorizontal: 6,
      paddingVertical: 2,
      borderRadius: 4,
    },
    recentlySavedBadgeText: {
      fontSize: 9,
      color: theme.colors.foreground3,
      marginLeft: 2,
    },
    // Folders Section
    foldersSection: {
      marginBottom: 24,
    },
    folderItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 12,
      paddingHorizontal: 16,
      backgroundColor: theme.colors.surface,
    },
    folderIcon: {
      width: 32,
      height: 32,
      borderRadius: 8,
      justifyContent: 'center',
      alignItems: 'center',
      marginRight: 12,
    },
    folderName: {
      flex: 1,
      fontSize: 15,
      fontWeight: '500',
      color: theme.colors.foreground,
    },
    folderCount: {
      fontSize: 14,
      color: theme.colors.foreground3,
      marginRight: 8,
    },
    // Bookmarks Section
    bookmarksSection: {
      marginBottom: 24,
    },
    bookmarkListItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 10,
      paddingHorizontal: 16,
      backgroundColor: theme.colors.surface,
    },
    bookmarkListIcon: {
      width: 24,
      height: 24,
      borderRadius: 6,
      backgroundColor: theme.colors.background,
      justifyContent: 'center',
      alignItems: 'center',
      marginRight: 12,
    },
    bookmarkListTitle: {
      flex: 1,
      fontSize: 14,
      color: theme.colors.foreground,
    },
    // Empty State
    bookmarksEmptyState: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
      paddingVertical: 60,
    },
    bookmarksEmptyText: {
      fontSize: 16,
      color: theme.colors.foreground3,
      marginTop: 16,
    },
    // Tab Bar
    bookmarksTabBar: {
      flexDirection: 'row',
      justifyContent: 'space-around',
      alignItems: 'center',
      paddingVertical: 12,
      paddingBottom: insets.bottom + 12,
      backgroundColor: theme.colors.surface,
      borderTopWidth: 1,
      borderTopColor: theme.colors.surfaceBorder,
    },
    bookmarksTab: {
      padding: 8,
    },
    // Legacy styles (for compatibility)
    bookmarkModalItem: {
      flexDirection: 'row',
      alignItems: 'center',
      paddingVertical: 14,
      paddingHorizontal: 16,
      backgroundColor: theme.colors.surface,
      borderBottomWidth: 1,
      borderBottomColor: theme.colors.surfaceBorder,
    },
    bookmarkModalIcon: {
      width: 36,
      height: 36,
      borderRadius: 8,
      backgroundColor: theme.colors.background,
      justifyContent: 'center',
      alignItems: 'center',
      marginRight: 12,
    },
    bookmarkModalInfo: {
      flex: 1,
      marginRight: 8,
    },
    bookmarkModalTitle: {
      fontSize: 15,
      fontWeight: '500',
      color: theme.colors.foreground,
      marginBottom: 4,
    },
    bookmarkModalUrl: {
      fontSize: 13,
      color: theme.colors.foreground3,
    },
    // Tab Card Preview Image
    tabCardPreview: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      width: '100%',
      height: '100%',
      resizeMode: 'cover',
    },
    tabCardPreviewContainer: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      width: '100%',
      height: '100%',
      justifyContent: 'center',
      alignItems: 'center',
      overflow: 'hidden',
    },
    tabCardScreenshot: {
      width: '100%',
      height: '100%',
      resizeMode: 'cover',
    },
    tabCardPlaceholder: {
      position: 'absolute',
      width: '100%',
      height: '100%',
      top: 0,
      left: 0,
    },
    tabCardFavicon: {
      width: 64,
      height: 64,
      borderRadius: 8,
    },
    tabCardOverlay: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.4)',
      justifyContent: 'space-between',
      padding: 0,
    },
    // DEBUG: Price Extraction Panel
    debugPanel: {
      position: 'absolute',
      bottom: insets.bottom + 80,
      left: 16,
      right: 16,
      backgroundColor: theme.colors.surface,
      borderRadius: 12,
      padding: 12,
      borderWidth: 2,
      borderColor: theme.colors.primary,
      shadowColor: '#000',
      shadowOffset: {width: 0, height: 2},
      shadowOpacity: 0.3,
      shadowRadius: 8,
      elevation: 5,
      zIndex: 1000,
    },
    debugTitle: {
      fontSize: 13,
      fontWeight: '700',
      color: theme.colors.primary,
      marginBottom: 8,
    },
    debugText: {
      fontSize: 12,
      color: theme.colors.foreground2,
      marginBottom: 4,
      fontFamily: 'Menlo',
    },
    debugDismiss: {
      fontSize: 12,
      color: theme.colors.primary,
      marginTop: 8,
      fontWeight: '600',
      textAlign: 'center',
    },
    debugHeader: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 8,
    },
    debugToggle: {
      fontSize: 14,
      color: theme.colors.primary,
      fontWeight: '600',
    },
    debugDetail: {
      marginTop: 8,
      paddingTop: 8,
      borderTopWidth: 1,
      borderTopColor: theme.colors.surfaceBorder,
    },
    debugDetailTitle: {
      fontSize: 11,
      fontWeight: '600',
      color: theme.colors.primary,
      marginTop: 6,
      marginBottom: 2,
    },
    debugDetailText: {
      fontSize: 10,
      color: theme.colors.foreground3,
      fontFamily: 'Menlo',
      lineHeight: 14,
    },
  });

  const showLanding = !currentTab || !currentTab.url;

  // ðŸ”¥ VOICE ADD
  const handleMicPressIn = async () => {
    const ok = await prepareAudio();
    if (!ok) return;
    ReactNativeHapticFeedback.trigger('impactLight');
    setIsHoldingMic(true);
    startListening();
  };

  // Ref to track if we should auto-submit after voice input
  const shouldAutoSubmitVoice = useRef(false);
  const wasRecording = useRef(false);

  const handleMicPressOut = () => {
    setIsHoldingMic(false);
    stopListening();
    ReactNativeHapticFeedback.trigger('selection');
    // Flag to auto-submit after voice input ends (WebBrowser address bar only)
    shouldAutoSubmitVoice.current = true;
  };

  // Auto-submit when recording stops after mic release (voice input only)
  useEffect(() => {
    // Detect transition from recording to not recording
    if (wasRecording.current && !isRecording && shouldAutoSubmitVoice.current) {
      shouldAutoSubmitVoice.current = false;
      // Delay to ensure inputValue is updated from speech, then submit
      setTimeout(() => {
        handleSubmit();
      }, 400);
    }
    wasRecording.current = isRecording;
  }, [isRecording]); // Only trigger on recording state change, not inputValue

  // Calculate address bar header height for content padding (like HomeScreen's HEADER_HEIGHT)
  const ADDRESS_BAR_HEIGHT = 45; // urlBar height (40) + paddingBottom (12)

  return (
    <View style={styles.container}>
      <StatusBar barStyle="light-content" />

      {/* Full-screen scrollable content - exactly like HomeScreen */}
      {showLanding ? (
        <ScrollView
          contentContainerStyle={{
            paddingTop: insets.top + 55 + ADDRESS_BAR_HEIGHT, // space for global header + address bar
            paddingBottom: insets.bottom + 90, // space for bottom nav
            minHeight: '100%',
          }}
          scrollEventThrottle={16}
          onScroll={event => {
            const y = event.nativeEvent.contentOffset.y;
            const diff = y - lastNavScrollY.current;

            // Scrolling down - hide nav
            if (
              diff > SCROLL_THRESHOLD &&
              !isBottomNavHidden.current &&
              y > 10
            ) {
              isBottomNavHidden.current = true;
              Animated.timing(bottomNavTranslateY, {
                toValue: NAV_HEIGHT + insets.bottom,
                duration: 300,
                easing: Easing.out(Easing.cubic),
                useNativeDriver: true,
              }).start();
            }
            // Scrolling up - show nav
            else if (diff < -SCROLL_THRESHOLD && isBottomNavHidden.current) {
              isBottomNavHidden.current = false;
              Animated.timing(bottomNavTranslateY, {
                toValue: 0,
                duration: 300,
                easing: Easing.out(Easing.cubic),
                useNativeDriver: true,
              }).start();
            }

            lastNavScrollY.current = y;
          }}
          showsVerticalScrollIndicator={false}>
          <Text style={styles.landingTitle}>Start Shopping</Text>
          <View style={styles.shoppingGrid}>
            {SHOPPING_SITES.map(site => (
              <TouchableOpacity
                key={site.name}
                style={styles.shoppingButton}
                onPress={() => handleQuickShop(site.url)}>
                <MaterialIcons
                  name="shopping-bag"
                  size={28}
                  color={theme.colors.primary}
                />
                <Text style={styles.shoppingButtonText}>{site.name}</Text>
              </TouchableOpacity>
            ))}
          </View>
        </ScrollView>
      ) : (
        <View
          ref={containerRef}
          style={{
            flex: 1,
            marginTop: insets.top + 55 + ADDRESS_BAR_HEIGHT + 12,
          }}
          collapsable={false}>
          <WebView
            ref={webRef}
            source={{uri: currentTab?.url || ''}}
            style={{flex: 1}}
            // === SECURITY: Apply secure defaults ===
            {...SECURE_WEBVIEW_DEFAULTS}
            // Allow HTTP for compatibility with some fashion sites
            originWhitelist={['https://*', 'http://*']}
            onShouldStartLoadWithRequest={createOnShouldStartLoadWithRequest({
              allowHttp: true,
            })}
            onContentProcessDidTerminate={createCrashRecoveryHandler(webRef)}
            // === END SECURITY ===
            contentInset={{
              bottom: insets.bottom + 90,
            }}
            contentInsetAdjustmentBehavior="never"
            automaticallyAdjustContentInsets={false}
            // ðŸ‘‡ Inertia / momentum scrolling
            decelerationRate="normal" // gives Safari-style glide
            bounces={true} // iOS bounce effect
            scrollEnabled={true} // ensure scroll isn't locked
            showsVerticalScrollIndicator={false}
            showsHorizontalScrollIndicator={false}
            overScrollMode="never" // keeps Android smooth too
            androidLayerType="hardware" // helps performance
            onNavigationStateChange={navState => {
              // Debounce navigation state changes to prevent rapid URL toggling
              if (!navState.url || !currentTab) return;

              // Skip if same URL (ignore www/trailing slash differences)
              if (
                isSameUrl(navState.url, currentTab.url) &&
                isSameUrl(navState.url, lastNavUrlRef.current)
              ) {
                return;
              }

              // Clear any pending debounce
              if (navStateDebounceRef.current) {
                clearTimeout(navStateDebounceRef.current);
              }

              // Store the latest URL
              lastNavUrlRef.current = navState.url;

              // Debounce the update - only apply after URL is stable for 300ms
              navStateDebounceRef.current = setTimeout(() => {
                // Double-check the URL is still the same after debounce
                if (
                  navState.url === lastNavUrlRef.current &&
                  !isSameUrl(navState.url, currentTab.url)
                ) {
                  updateTab(
                    currentTab.id,
                    navState.url,
                    navState.title || currentTab.title,
                  );
                  setInputValue(navState.url);
                  // Track visit history with brand
                  // SECURITY: Sanitize URL to strip sensitive query params before analytics
                  const sanitizedUrl = sanitizeUrlForAnalytics(navState.url);
                  const safeTitle = sanitizeTitle(navState.title, 200);
                  const navBrand = shoppingAnalytics.extractBrand(
                    safeTitle,
                    sanitizedUrl,
                  );
                  addToHistory(
                    sanitizedUrl,
                    safeTitle || getDomain(sanitizedUrl),
                    getDomain(sanitizedUrl),
                    navBrand,
                  );
                }
              }, 300);
            }}
            onScroll={handleWebViewScroll}
            onLoadEnd={handleWebViewLoadEnd}
            onMessage={handleWebViewMessage}
            userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
            pullToRefreshEnabled={true}
            allowsBackForwardNavigationGestures={true}
          />
        </View>
      )}

      {/* Light tint overlay for global header area */}
      <View style={styles.headerTint} pointerEvents="none" />

      {/* Floating Address Bar Header - renders after content to appear on top */}
      <View style={styles.header}>
        <View style={styles.urlBar}>
          <TextInput
            style={styles.urlInput}
            value={inputValue}
            onChangeText={text => {
              setInputValue(text);
              setShowAutocomplete(text.length > 0);
            }}
            onSubmitEditing={handleSubmit}
            onFocus={() => {
              triggerHaptic('impactLight');
              setIsInputFocused(true);
              setShowAutocomplete(inputValue.length > 0);
            }}
            onBlur={() => {
              setTimeout(() => {
                setIsInputFocused(false);
                setShowAutocomplete(false);
              }, 150);
            }}
            placeholder="Search or enter URL"
            placeholderTextColor={theme.colors.foreground3}
            autoCapitalize="none"
            autoCorrect={false}
            keyboardType="ascii-capable"
            returnKeyType="go"
            selectTextOnFocus
          />
          {inputValue.length > 0 && (
            <TouchableOpacity
              style={styles.iconButton}
              onPress={() => setInputValue('')}>
              <MaterialIcons
                name="close"
                size={18}
                color={theme.colors.foreground3}
              />
            </TouchableOpacity>
          )}

          {/* Refresh button */}
          {currentTab?.url && (
            <TouchableOpacity
              style={styles.iconButton}
              onPress={() => webRef.current?.reload()}>
              <MaterialIcons
                name="refresh"
                size={22}
                color={theme.colors.foreground3}
              />
            </TouchableOpacity>
          )}

          {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
          <TouchableOpacity
            onPressIn={handleMicPressIn}
            onPressOut={handleMicPressOut}
            style={styles.iconButton}>
            <MaterialIcons
              name={isRecording ? 'mic' : 'mic-none'}
              size={22}
              color={
                isRecording ? theme.colors.primary : theme.colors.foreground3
              }
            />
          </TouchableOpacity>
        </View>
        {showAutocomplete && autocompleteSuggestions.length > 0 && (
          <View style={styles.autocompleteContainer}>
            {autocompleteSuggestions.map((item, index) => (
              <TouchableOpacity
                key={`${item.url}-${index}`}
                style={styles.autocompleteItem}
                onPress={() => handleAutocompleteSelect(item.url)}>
                <MaterialIcons
                  name="history"
                  size={18}
                  color={theme.colors.foreground3}
                  style={styles.autocompleteIcon}
                />
                <View style={styles.autocompleteTextContainer}>
                  <Text
                    style={styles.autocompleteTitle}
                    numberOfLines={1}
                    ellipsizeMode="tail">
                    {item.title || getDomain(item.url)}
                  </Text>
                  <Text
                    style={styles.autocompleteUrl}
                    numberOfLines={1}
                    ellipsizeMode="middle">
                    {item.url}
                  </Text>
                </View>
              </TouchableOpacity>
            ))}
          </View>
        )}
      </View>

      {/* Browsers Bottom Navbar - Pill shaped with hide on scroll */}
      {!showTabsView && (
        <Animated.View
          style={[
            styles.bottomNavContainer,
            {transform: [{translateY: bottomNavTranslateY}]},
          ]}>
          {isLiquidGlassSupported ? (
            <LiquidGlassView
              style={styles.bottomNavPill}
              effect="clear"
              tintColor="rgba(0, 0, 0, 0.48)"
              colorScheme="system">
              <AppleTouchFeedback
                onPress={() => navigate('Home')}
                hapticStyle="impactLight"
                style={{
                  padding: moderateScale(tokens.spacing.xxs),
                  marginLeft: moderateScale(tokens.spacing.xsm),
                }}>
                <Icon name="home" size={26} color={theme.colors.foreground} />
              </AppleTouchFeedback>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={() => webRef.current?.goBack()}>
                <MaterialIcons
                  name="arrow-back-ios"
                  size={22}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={() => webRef.current?.goForward()}>
                <MaterialIcons
                  name="arrow-forward-ios"
                  size={22}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              {/* Bookmark button - commented out
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleAddToBookmarks}>
                <MaterialIcons
                  name={bookmarked ? 'bookmark' : 'bookmark-border'}
                  size={24}
                  color={
                    bookmarked ? theme.colors.button1 : theme.colors.buttonText1
                  }
                />
              </TouchableOpacity>
              */}
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleShareButtonPress}>
                <MaterialIcons
                  name="ios-share"
                  size={24}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={openTabsView}>
                <View style={styles.tabsButtonNav}>
                  <Text style={styles.tabsCountNav}>{tabs.length || 1}</Text>
                </View>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleSaveMenuOpen}>
                <MaterialIcons
                  name="add-circle-outline"
                  size={28}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
            </LiquidGlassView>
          ) : (
            <View style={styles.bottomNavPillFallback}>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={() => webRef.current?.goBack()}>
                <MaterialIcons
                  name="arrow-back-ios"
                  size={22}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={() => webRef.current?.goForward()}>
                <MaterialIcons
                  name="arrow-forward-ios"
                  size={22}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              {/* Bookmark button - commented out
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleAddToBookmarks}>
                <MaterialIcons
                  name={bookmarked ? 'bookmark' : 'bookmark-border'}
                  size={24}
                  color={
                    bookmarked ? theme.colors.button1 : theme.colors.buttonText1
                  }
                />
              </TouchableOpacity>
              */}
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleShareButtonPress}>
                <MaterialIcons
                  name="ios-share"
                  size={24}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={openTabsView}>
                <View style={styles.tabsButtonNav}>
                  <Text style={styles.tabsCountNav}>{tabs.length || 1}</Text>
                </View>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.bottomNavItem}
                onPress={handleSaveMenuOpen}>
                <MaterialIcons
                  name="add-circle-outline"
                  size={28}
                  color={theme.colors.buttonText1}
                />
              </TouchableOpacity>
            </View>
          )}
        </Animated.View>
      )}

      {/* Shopping Assistant */}
      {!showTabsView && (
        <ShoppingAssistant
          onSuggestionPress={url => {
            if (currentTab) {
              updateTab(currentTab.id, url, currentTab.title);
            } else {
              addTab(url, 'New Tab');
            }
          }}
          isVisible={!showTabsView}
          userId={userId}
          aiSuggestions={aiShoppingAssistantSuggestions}
        />
      )}

      {/* Safari-style Tabs View */}
      {showTabsView && (
        <TouchableOpacity
          activeOpacity={1}
          onPress={closeTabsView}
          style={styles.tabsOverlay}>
          <Animated.View
            style={[
              {flex: 1},
              {
                opacity: tabsViewScale,
                transform: [
                  {
                    scale: tabsViewScale.interpolate({
                      inputRange: [0, 1],
                      outputRange: [0.9, 1],
                    }),
                  },
                ],
              },
            ]}>
            <TouchableOpacity
              activeOpacity={1}
              onPress={e => e.stopPropagation()}>
              <View style={styles.tabsHeader}>
                {/* <TouchableOpacity
                  style={styles.tabsHeaderButton}
                  onPress={handleNewTab}>
                  <Text style={styles.tabsHeaderButtonText}>+</Text>
                </TouchableOpacity> */}
                <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
                <TouchableOpacity
                  style={styles.tabsHeaderButton}
                  onPress={closeTabsView}>
                  <Text style={styles.tabsHeaderButtonText}>Done</Text>
                </TouchableOpacity>
              </View>
            </TouchableOpacity>

            <ScrollView
              contentContainerStyle={styles.tabsGrid}
              scrollEnabled={draggingIndex === null}>
              {tabs
                .filter(tab => tab.url)
                .map((tab, index) => {
                  const isDragging = draggingIndex === index;
                  const isDropTarget =
                    draggedOverIndex === index && draggingIndex !== index;
                  const panResponder = createPanResponder(index);

                  return (
                    <Animated.View
                      key={tab.id}
                      onLayout={e => handleTabLayout(index, e)}
                      style={[
                        isDragging && {
                          transform: [
                            {translateX: dragAnimatedValue.x},
                            {translateY: dragAnimatedValue.y},
                            {scale: dragScale},
                          ],
                          zIndex: 1000,
                          elevation: 10,
                        },
                        isDropTarget && {
                          opacity: 0.5,
                        },
                      ]}
                      {...panResponder.panHandlers}>
                      <TouchableOpacity
                        style={[
                          styles.tabCard,
                          tab.id === currentTabId && styles.tabCardActive,
                          isDragging && styles.tabCardDragging,
                        ]}
                        onPress={() => handleSelectTab(tab.id)}
                        onLongPress={() => handleLongPress(index)}
                        delayLongPress={300}
                        activeOpacity={0.8}>
                        {/* Tab Preview Background */}
                        <View style={styles.tabCardPreviewContainer}>
                          {tab.screenshot ? (
                            <Image
                              source={{uri: tab.screenshot}}
                              style={styles.tabCardScreenshot}
                              resizeMode="cover"
                            />
                          ) : (
                            <>
                              {/* Gradient/colored background when no screenshot */}
                              <View
                                style={[
                                  styles.tabCardPlaceholder,
                                  {backgroundColor: theme.colors.surface},
                                ]}
                              />
                              <Image
                                source={{
                                  uri: `https://icons.duckduckgo.com/ip3/${getDomain(
                                    tab.url,
                                  )}.ico`,
                                }}
                                style={styles.tabCardFavicon}
                                defaultSource={require('../assets/images/desktop-2.jpg')}
                              />
                            </>
                          )}
                        </View>

                        {/* Overlay with text content */}
                        <View style={styles.tabCardOverlay}>
                          <View style={styles.tabCardHeader}>
                            <Text style={styles.tabCardTitle} numberOfLines={2}>
                              {tab.title || getDomain(tab.url)}
                            </Text>
                            <TouchableOpacity
                              style={styles.tabCardClose}
                              onPress={() => handleCloseTab(tab.id)}
                              hitSlop={{
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10,
                              }}>
                              <MaterialIcons
                                name="close"
                                size={16}
                                color="#fff"
                              />
                            </TouchableOpacity>
                          </View>
                          <View style={styles.tabCardContent}>
                            <Text style={styles.tabCardDomain}>
                              {getDomain(tab.url)}
                            </Text>
                          </View>
                        </View>
                      </TouchableOpacity>
                    </Animated.View>
                  );
                })}
              <TouchableOpacity
                style={styles.newTabCard}
                onPress={handleNewTab}>
                <MaterialIcons
                  name="add"
                  size={2}
                  color={theme.colors.foreground3}
                />
                <Text style={styles.newTabText}>New Tab</Text>
              </TouchableOpacity>
            </ScrollView>
          </Animated.View>
        </TouchableOpacity>
      )}

      {/* Share Menu Modal */}
      <Modal
        visible={showShareMenu}
        transparent
        animationType="slide"
        onRequestClose={() => setShowShareMenu(false)}>
        <TouchableOpacity
          style={styles.saveMenuOverlay}
          activeOpacity={1}
          onPress={() => setShowShareMenu(false)}>
          <TouchableOpacity
            activeOpacity={1}
            onPress={e => e.stopPropagation()}
            style={styles.saveMenuContent}>
            <View style={styles.saveMenuHandle} />
            <Text style={styles.saveMenuTitle}>Share</Text>
            {/* Save to My Notes */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={handleShareToNotes}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="note-add" size={22} color="#10b981" />
              </View>
              <Text style={styles.saveMenuItemText}>Save to My Notes</Text>
              <MaterialIcons
                name="arrow-forward-ios"
                size={16}
                color={theme.colors.foreground3}
                style={styles.saveMenuItemCheck}
              />
            </TouchableOpacity>
            {/* Share via iOS */}
            <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="ios-share" size={22} color="#3b82f6" />
              </View>
              <Text style={styles.saveMenuItemText}>Share via...</Text>
              <MaterialIcons
                name="arrow-forward-ios"
                size={16}
                color={theme.colors.foreground3}
                style={styles.saveMenuItemCheck}
              />
            </TouchableOpacity>
          </TouchableOpacity>
        </TouchableOpacity>
      </Modal>

      {/* Image Save Modal */}
      <Modal
        visible={showImageSaveModal}
        transparent
        animationType="slide"
        onRequestClose={() => setShowImageSaveModal(false)}>
        <TouchableOpacity
          style={styles.saveMenuOverlay}
          activeOpacity={1}
          onPress={() => setShowImageSaveModal(false)}>
          <TouchableOpacity
            activeOpacity={1}
            onPress={e => e.stopPropagation()}
            style={styles.saveMenuContent}>
            <View style={styles.saveMenuHandle} />
            <Text style={styles.saveMenuTitle}>Save Image</Text>
            {/* Save to Photos */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={async () => {
                if (longPressedImageUrl) {
                  setShowImageSaveModal(false);
                  try {
                    await ImageSaverModule.saveImageFromUrl(
                      longPressedImageUrl,
                    );
                    triggerHaptic('notificationSuccess');
                  } catch (error) {
                    console.log('Image save error:', error);
                    triggerHaptic('notificationError');
                  }
                } else {
                  setShowImageSaveModal(false);
                }
              }}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="photo-library" size={22} color="#10b981" />
              </View>
              <Text style={styles.saveMenuItemText}>Save to Photos</Text>
              <MaterialIcons
                name="arrow-forward-ios"
                size={16}
                color={theme.colors.foreground3}
                style={styles.saveMenuItemCheck}
              />
            </TouchableOpacity>
            {/* Add to Wardrobe */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={() => {
                if (longPressedImageUrl) {
                  navigate('AddItem', {imageUrl: longPressedImageUrl});
                }
                setShowImageSaveModal(false);
              }}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="checkroom" size={22} color="#8b5cf6" />
              </View>
              <Text style={styles.saveMenuItemText}>Add to Wardrobe</Text>
              <MaterialIcons
                name="arrow-forward-ios"
                size={16}
                color={theme.colors.foreground3}
                style={styles.saveMenuItemCheck}
              />
            </TouchableOpacity>
            {/* Save to Inspired Looks */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={async () => {
                if (longPressedImageUrl && userId) {
                  setShowImageSaveModal(false);
                  try {
                    const response = await fetch(
                      `${API_BASE_URL}/saved-looks`,
                      {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                          user_id: userId,
                          image_url: longPressedImageUrl,
                          name: 'Web Inspiration',
                        }),
                      },
                    );
                    if (response.ok) {
                      triggerHaptic('notificationSuccess');
                    } else {
                      triggerHaptic('notificationError');
                    }
                  } catch (error) {
                    console.log('Save to Inspired Looks error:', error);
                    triggerHaptic('notificationError');
                  }
                } else {
                  setShowImageSaveModal(false);
                }
              }}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="auto-awesome" size={22} color="#f59e0b" />
              </View>
              <Text style={styles.saveMenuItemText}>
                Save to Inspired Looks
              </Text>
              <MaterialIcons
                name="arrow-forward-ios"
                size={16}
                color={theme.colors.foreground3}
                style={styles.saveMenuItemCheck}
              />
            </TouchableOpacity>
          </TouchableOpacity>
        </TouchableOpacity>
      </Modal>

      {/* iOS Password AutoFill - passwords are managed by iOS/iCloud Keychain automatically */}
      {/* No custom password save modal needed - iOS handles password saving via system prompts */}

      {/* Save Menu Modal */}
      <Modal
        visible={showSaveMenu}
        transparent
        animationType="slide"
        onRequestClose={() => setShowSaveMenu(false)}>
        <TouchableOpacity
          style={styles.saveMenuOverlay}
          activeOpacity={1}
          onPress={() => {
            setShowSaveMenu(false);
            setShowCollectionPicker(false);
          }}>
          <TouchableOpacity
            activeOpacity={1}
            onPress={e => e.stopPropagation()}
            style={styles.saveMenuContent}>
            <View style={styles.saveMenuHandle} />
            <Text style={styles.saveMenuTitle}>Save Page</Text>

            {/* Add to Bookmarks */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={handleAddToBookmarks}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons
                  name="bookmark"
                  size={22}
                  color={theme.colors.primary}
                />
              </View>
              <Text style={styles.saveMenuItemText}>
                {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
              </Text>
              {bookmarked && (
                <MaterialIcons
                  name="check"
                  size={20}
                  color={theme.colors.primary}
                  style={styles.saveMenuItemCheck}
                />
              )}
            </TouchableOpacity>

            {/* Add to Collection */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons
                  name="folder-special"
                  size={22}
                  color={theme.colors.secondary || '#f59e0b'}
                />
              </View>
              <Text style={styles.saveMenuItemText}>Add to Collections</Text>
              <MaterialIcons
                name={showCollectionPicker ? 'expand-less' : 'expand-more'}
                size={24}
                color={theme.colors.foreground3}
              />
            </TouchableOpacity>

            {/* Collection Picker */}
            {showCollectionPicker && (
              <View>
                {collections.length === 0 ? (
                  <Text
                    style={[
                      styles.collectionName,
                      {paddingHorizontal: 20, paddingVertical: 12},
                    ]}>
                    No collections yet
                  </Text>
                ) : (
                  collections.map(collection => (
                    <TouchableOpacity
                      key={collection.id}
                      style={styles.collectionItem}
                      onPress={() => handleAddToCollection(collection.id)}>
                      <View
                        style={[
                          styles.collectionColor,
                          {backgroundColor: collection.color},
                        ]}>
                        <MaterialIcons name="folder" size={18} color="#fff" />
                      </View>
                      <Text style={styles.collectionName}>
                        {collection.name}
                      </Text>
                      <Text style={styles.collectionCount}>
                        {collection.items.length} items
                      </Text>
                    </TouchableOpacity>
                  ))
                )}
              </View>
            )}

            {/* Share Link */}
            {/* <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="share" size={22} color="#3b82f6" />
              </View>
              <Text style={styles.saveMenuItemText}>Share Link</Text>
              <MaterialIcons
                name="ios-share"
                size={20}
                color={theme.colors.foreground3}
              />
            </TouchableOpacity> */}

            {/* View Bookmarks */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={handleOpenBookmarks}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons
                  name="bookmarks"
                  size={22}
                  color={theme.colors.primary}
                />
              </View>
              <Text style={styles.saveMenuItemText}>Bookmarks</Text>
              <Text style={styles.collectionCount}>{bookmarks.length}</Text>
            </TouchableOpacity>

            {/* Auto-fill Settings */}
            <TouchableOpacity
              style={styles.saveMenuItem}
              onPress={() => {
                setShowSaveMenu(false);
                setShowAutofillSettings(true);
              }}>
              <View style={styles.saveMenuItemIcon}>
                <MaterialIcons name="lock" size={22} color="#10b981" />
              </View>
              <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
              <MaterialIcons
                name="chevron-right"
                size={20}
                color={theme.colors.foreground3}
              />
            </TouchableOpacity>
          </TouchableOpacity>
        </TouchableOpacity>
      </Modal>

      {/* DEBUG: Price Extraction Display */}
      {debugInfo && (
        <View style={styles.debugPanel}>
          <View style={styles.debugHeader}>
            <Text style={styles.debugTitle}>Last Extraction:</Text>
            <TouchableOpacity
              onPress={() => setShowDebugDetail(!showDebugDetail)}>
              <Text style={styles.debugToggle}>
                {showDebugDetail ? 'â–¼' : 'â–¶'}
              </Text>
            </TouchableOpacity>
          </View>

          <Text style={styles.debugText}>
            ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
          </Text>
          <Text style={styles.debugText}>
            ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
          </Text>
          <Text style={styles.debugText}>
            ðŸ‘• Category: {debugInfo.category || 'â€”'}
          </Text>
          <Text style={styles.debugText}>
            ðŸ“ Sizes:{' '}
            {debugInfo.sizesViewed?.length
              ? debugInfo.sizesViewed.join(', ')
              : 'â€”'}
          </Text>
          <Text style={styles.debugText}>
            ðŸŽ¨ Colors:{' '}
            {debugInfo.colorsViewed?.length
              ? debugInfo.colorsViewed.join(', ')
              : 'â€”'}
          </Text>
          <Text style={styles.debugText}>
            ðŸ“„ Page text:{' '}
            {debugInfo.pageTextLength
              ? `${debugInfo.pageTextLength} chars`
              : '0 chars'}
          </Text>

          {showDebugDetail && (
            <View style={styles.debugDetail}>
              <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
              <Text style={styles.debugDetailText} numberOfLines={3}>
                {debugInfo.inputText?.substring(0, 150) || '(empty)'}
              </Text>

              {debugInfo.pageTextPreview && (
                <>
                  <Text style={styles.debugDetailTitle}>
                    Page Text Preview:
                  </Text>
                  <Text style={styles.debugDetailText} numberOfLines={4}>
                    {debugInfo.pageTextPreview}
                  </Text>
                </>
              )}
            </View>
          )}

          <TouchableOpacity onPress={() => setDebugInfo(null)}>
            <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
          </TouchableOpacity>
        </View>
      )}

      {/* Bookmarks Modal */}
      <Modal
        visible={showBookmarksModal}
        transparent
        animationType="slide"
        onRequestClose={() => setShowBookmarksModal(false)}>
        <View style={styles.bookmarksModalContainer}>
          {/* Header */}
          <View style={styles.bookmarksModalHeader}>
            <TouchableOpacity
              onPress={() => setShowBookmarksModal(false)}
              style={styles.bookmarksCloseButton}>
              <MaterialIcons
                name="close"
                size={24}
                color={theme.colors.foreground}
              />
            </TouchableOpacity>
            <TouchableOpacity style={styles.bookmarksMenuButton}>
              <MaterialIcons
                name="more-horiz"
                size={24}
                color={theme.colors.foreground}
              />
            </TouchableOpacity>
          </View>

          {/* Search Bar */}
          <View style={styles.bookmarksSearchContainer}>
            <MaterialIcons
              name="search"
              size={20}
              color={theme.colors.foreground3}
              style={styles.bookmarksSearchIcon}
            />
            <TextInput
              style={styles.bookmarksSearchInput}
              placeholder="Search Bookmarks"
              placeholderTextColor={theme.colors.foreground3}
            />
            {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
            <TouchableOpacity
              onPressIn={handleMicPressIn}
              onPressOut={handleMicPressOut}>
              <MaterialIcons
                name={isRecording ? 'mic' : 'mic-none'}
                size={20}
                color={
                  isRecording ? theme.colors.primary : theme.colors.foreground3
                }
                style={styles.bookmarksSearchMic}
              />
            </TouchableOpacity>
          </View>

          <ScrollView style={styles.bookmarksModalContent}>
            {activeBookmarksTab === 'bookmarks' ? (
              <>
                {/* Recently Saved */}
                {bookmarks.length > 0 && (
                  <View style={styles.recentlySavedSection}>
                    <Text style={styles.sectionHeaderText}>
                      Recently Saved
                      <MaterialIcons
                        name="chevron-right"
                        size={18}
                        color={theme.colors.foreground3}
                      />
                    </Text>
                    <ScrollView
                      horizontal
                      showsHorizontalScrollIndicator={false}
                      style={styles.recentlySavedScroll}>
                      {bookmarks.slice(0, 5).map(bookmark => (
                        <TouchableOpacity
                          key={bookmark.id}
                          style={styles.recentlySavedCard}
                          onPress={() =>
                            handleBookmarkNavigation(
                              bookmark.url,
                              bookmark.title,
                            )
                          }>
                          <View style={styles.recentlySavedPreview}>
                            <MaterialIcons
                              name="language"
                              size={32}
                              color={theme.colors.foreground3}
                            />
                          </View>
                          <Text
                            style={styles.recentlySavedTitle}
                            numberOfLines={2}>
                            {bookmark.title}
                          </Text>
                          <Text
                            style={styles.recentlySavedUrl}
                            numberOfLines={1}>
                            {bookmark.source}
                          </Text>
                          <View style={styles.recentlySavedBadge}>
                            <MaterialIcons
                              name="schedule"
                              size={10}
                              color={theme.colors.foreground3}
                            />
                            <Text style={styles.recentlySavedBadgeText}>
                              Bookmarks
                            </Text>
                          </View>
                        </TouchableOpacity>
                      ))}
                    </ScrollView>
                  </View>
                )}

                {/* Collections Folders */}
                {collections.length > 0 && (
                  <View style={styles.foldersSection}>
                    <Text style={styles.sectionHeaderText}>Collections</Text>
                    {collections.map(collection => (
                      <TouchableOpacity
                        key={collection.id}
                        style={styles.folderItem}>
                        <View
                          style={[
                            styles.folderIcon,
                            {backgroundColor: collection.color + '33'},
                          ]}>
                          <MaterialIcons
                            name="folder"
                            size={20}
                            color={collection.color}
                          />
                        </View>
                        <Text style={styles.folderName}>{collection.name}</Text>
                        <Text style={styles.folderCount}>
                          {collection.items.length}
                        </Text>
                        <MaterialIcons
                          name="chevron-right"
                          size={20}
                          color={theme.colors.foreground3}
                        />
                      </TouchableOpacity>
                    ))}
                  </View>
                )}

                {/* All Bookmarks */}
                {bookmarks.length > 0 && (
                  <View style={styles.bookmarksSection}>
                    <Text style={styles.sectionHeaderText}>Bookmarks</Text>
                    {bookmarks.map(bookmark => (
                      <TouchableOpacity
                        key={bookmark.id}
                        style={styles.bookmarkListItem}
                        onPress={() =>
                          handleBookmarkNavigation(bookmark.url, bookmark.title)
                        }>
                        <View style={styles.bookmarkListIcon}>
                          <MaterialIcons
                            name="language"
                            size={16}
                            color={theme.colors.foreground3}
                          />
                        </View>
                        <Text
                          style={styles.bookmarkListTitle}
                          numberOfLines={1}>
                          {bookmark.title}
                        </Text>
                      </TouchableOpacity>
                    ))}
                  </View>
                )}

                {/* Empty State */}
                {bookmarks.length === 0 && collections.length === 0 && (
                  <View style={styles.bookmarksEmptyState}>
                    <MaterialIcons
                      name="bookmark-border"
                      size={48}
                      color={theme.colors.foreground3}
                    />
                    <Text style={styles.bookmarksEmptyText}>
                      No bookmarks yet
                    </Text>
                  </View>
                )}
              </>
            ) : (
              <>
                {/* Browsing History */}
                {history.length > 0 ? (
                  <View style={styles.bookmarksSection}>
                    <Text style={styles.sectionHeaderText}>
                      Browsing History
                    </Text>
                    {history.map((item, index) => (
                      <TouchableOpacity
                        key={`${item.url}-${index}`}
                        style={styles.bookmarkListItem}
                        onPress={() =>
                          handleBookmarkNavigation(item.url, item.title)
                        }>
                        <View style={styles.bookmarkListIcon}>
                          <MaterialIcons
                            name="history"
                            size={16}
                            color={theme.colors.foreground3}
                          />
                        </View>
                        <View style={{flex: 1}}>
                          <Text
                            style={styles.bookmarkListTitle}
                            numberOfLines={1}>
                            {item.title}
                          </Text>
                          <Text
                            style={styles.recentlySavedUrl}
                            numberOfLines={1}>
                            {item.source}
                          </Text>
                        </View>
                        {item.visitCount > 1 && (
                          <Text style={styles.folderCount}>
                            {item.visitCount}x
                          </Text>
                        )}
                      </TouchableOpacity>
                    ))}
                  </View>
                ) : (
                  <View style={styles.bookmarksEmptyState}>
                    <MaterialIcons
                      name="history"
                      size={48}
                      color={theme.colors.foreground3}
                    />
                    <Text style={styles.bookmarksEmptyText}>
                      No browsing history
                    </Text>
                  </View>
                )}
              </>
            )}
          </ScrollView>

          {/* Bottom Tab Bar */}
          <View style={styles.bookmarksTabBar}>
            <TouchableOpacity
              style={styles.bookmarksTab}
              onPress={() => {
                triggerHaptic('impactLight');
                setActiveBookmarksTab('bookmarks');
              }}>
              <MaterialIcons
                name="bookmark"
                size={22}
                color={
                  activeBookmarksTab === 'bookmarks'
                    ? theme.colors.primary
                    : theme.colors.foreground3
                }
              />
            </TouchableOpacity>
            <TouchableOpacity
              style={styles.bookmarksTab}
              onPress={() => {
                triggerHaptic('impactLight');
                setActiveBookmarksTab('history');
              }}>
              <MaterialIcons
                name="history"
                size={22}
                color={
                  activeBookmarksTab === 'history'
                    ? theme.colors.primary
                    : theme.colors.foreground3
                }
              />
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      {/* Auto-fill Settings Modal */}
      <AutofillSettings
        visible={showAutofillSettings}
        onClose={() => setShowAutofillSettings(false)}
      />

      {/* Tracking Consent Modal */}
      <TrackingConsentModal
        visible={showConsentModal}
        onAccept={handleConsentAccept}
        onDecline={handleConsentDecline}
      />
    </View>
  );
}

/////////////////////////

// import React, {useRef, useState, useEffect, useCallback, useMemo} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Easing,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
//   Alert,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import {tokens} from '../styles/tokens/tokens';
// import {LiquidGlassView, isLiquidGlassSupported} from '@callstack/liquid-glass';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {fontScale, moderateScale} from '../utils/scale';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';
// // ðŸ”¥ VOICE ADD/
// import {useVoiceControl} from '../hooks/useVoiceControl';
// import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
// import {PermissionsAndroid, Platform} from 'react-native';
// import ImageSaverModule from '../native/ImageSaverModule';
// import {API_BASE_URL} from '../config/api';
// import AppleTouchFeedback from '../components/AppleTouchFeedback/AppleTouchFeedback';
// import Icon from 'react-native-vector-icons/MaterialIcons';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://www.google.com'},
//   {name: 'Amazon', url: 'https://www.amazon.com'},
//   {name: 'ASOS', url: 'https://www.asos.com'},
//   {name: 'H&M', url: 'https://www.hm.com'},
//   {name: 'Zara', url: 'https://www.zara.com'},
//   {name: 'Shein', url: 'https://www.shein.com'},
//   {name: 'SSENSE', url: 'https://www.ssense.com'},
//   {name: 'Farfetch', url: 'https://www.farfetch.com'},
//   {name: 'Nordstrom', url: 'https://www.nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
//   navigate: (screen: string, params?: any) => void;
//   wardrobe: any[];
// };

// export default function WebBrowserScreen({navigate, route}: Props) {
//   // ðŸ”¥ VOICE ADD
//   const {speech, isRecording, startListening, stopListening} =
//     useVoiceControl();
//   const [isHoldingMic, setIsHoldingMic] = useState(false);
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   // Debug: Log only on actual mount, not every render
//   useEffect(() => {
//     console.log('WebBrowserScreen mounted, userId:', userId);
//   }, []);
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//     aiShoppingAssistantSuggestions,
//     setAiShoppingAssistantSuggestions,
//     hasAiSuggestionsLoaded,
//     setHasAiSuggestionsLoaded,
//     isAiSuggestionsStale,
//     trackingConsent,
//     setTrackingConsent,
//   } = useShoppingStore();

//   // ðŸ”¥ VOICE ADD
//   async function prepareAudio() {
//     try {
//       if (Platform.OS === 'android') {
//         const granted = await PermissionsAndroid.request(
//           PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
//         );
//         if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
//       } else {
//         const AV = require('react-native').NativeModules.AVAudioSession;
//         if (AV?.setCategory) {
//           await AV.setCategory('PlayAndRecord');
//           await AV.setActive(true);
//         }
//       }
//       return true;
//     } catch {
//       return false;
//     }
//   }

//   // ðŸ›ï¸ Fetch shopping suggestions with smart context classification
//   async function fetchShoppingAssistantSuggestions() {
//     if (!userId || (hasAiSuggestionsLoaded && !isAiSuggestionsStale())) {
//       return;
//     }

//     const SHOPPING_PROMPT = `SHOPPING ASSISTANT MODE: Analyze the user's wardrobe, style profile, and calendar to generate 5 HIGHLY SPECIFIC personalized shopping recommendations.

// ðŸŽ¯ CRITICAL REQUIREMENTS:
// 1. Access user's wardrobe inventory to identify SPECIFIC gaps (colors owned, categories missing, fit preferences)
// 2. Reference style profile: body type, preferred colors, disliked styles, climate
// 3. Check calendar for upcoming events needing specific pieces
// 4. NO GENERIC SUGGESTIONS - every recommendation must PROVE you know their wardrobe
// 5. EVERY recommendation MUST explicitly name SPECIFIC items they already own

// â­ MANDATORY WARDROBE REFERENCING (you MUST do this):
// - Use language patterns like "pair with your [COLOR] [ITEM] you own"
// - Examples of GOOD recommendations:
//   â€¢ "Navy blazer - pairs perfectly with your sleek white pants and complements your gray cardigans"
//   â€¢ "Camel belt - fills your warm-neutral gap; works with your dark bottoms and existing brown shoes"
//   â€¢ "Black tailored trousers - adds formality; you have 8 tops (mostly navy/gray) but only 2 bottoms"
//   â€¢ "Cream linen shirt - bridges your white and navy pieces; works for your business casual events next month"
//   â€¢ "Burgundy wool sweater - complements your warm undertones and pairs with the cream chinos you own"

// - Examples of BAD recommendations (NEVER do these):
//   â€¢ âŒ "Elevate your look with a premium leather belt"
//   â€¢ âŒ "Fill the gap with classic black trousers"
//   â€¢ âŒ "Add a stylish blazer to complete your wardrobe"

// Use strategies:
// 1. **CALENDAR**: Reference specific events and what they NEED
// 2. **WARDROBE_GAP**: Name specific missing colors or categories (e.g., "you lack warm-toned bottoms") AND list similar items they own
// 3. **STYLE_UPGRADE**: Reference existing pieces BY NAME and suggest exact complementary items
// 4. **TRENDING**: Name trending style AND explain why THEIR specific aesthetic needs it
// 5. **COMPLETE_LOOK**: Reference saved outfits and name SPECIFIC pieces missing

// Respond with JSON array of exactly 5 objects with SPECIFIC recommendations:
// [
//   {"text": "[Color] [fit] [garment] - [concrete reason naming specific items they own]", "site": "https://nordstrom.com", "search": "[specific search]", "strategy": "calendar"},
//   ...
// ]`;

//     try {
//       const response = await fetch(`${API_BASE_URL}/ai/chat`, {
//         method: 'POST',
//         headers: {'Content-Type': 'application/json'},
//         body: JSON.stringify({
//           user_id: userId,
//           messages: [{role: 'user', content: SHOPPING_PROMPT}],
//         }),
//       });

//       if (!response.ok) throw new Error('AI request failed');

//       const data = await response.json();
//       const aiText = data.reply || data.text || data.response || '';

//       try {
//         const parsed = JSON.parse(aiText.match(/\[[\s\S]*\]/)?.[0] || '[]');
//         if (Array.isArray(parsed) && parsed.length > 0) {
//           setAiShoppingAssistantSuggestions(parsed);
//           setHasAiSuggestionsLoaded(true);
//         }
//       } catch {
//         // Failed to parse shopping suggestions
//       }
//     } catch (err) {
//       // Shopping suggestions fetch failed
//     }
//   }

//   // Memoize currentTab to prevent unnecessary recalculations
//   const currentTab = useMemo(
//     () => tabs.find(t => t.id === currentTabId),
//     [tabs, currentTabId],
//   );
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [showShareMenu, setShowShareMenu] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Image long-press save state
//   const [longPressedImageUrl, setLongPressedImageUrl] = useState<string | null>(
//     null,
//   );
//   const [showImageSaveModal, setShowImageSaveModal] = useState(false);

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // Debounce navigation state changes to prevent rapid URL toggling
//   const navStateDebounceRef = useRef<NodeJS.Timeout | null>(null);
//   const lastNavUrlRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   const initialUrlProcessedRef = useRef(false);
//   useEffect(() => {
//     if (_hasHydrated && initialUrl && !initialUrlProcessedRef.current) {
//       initialUrlProcessedRef.current = true;
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes (only when switching tabs, not during navigation)
//   const lastTabIdRef = useRef(currentTabId);

//   // Track last cart detection to prevent duplicates
//   const lastCartDetectionRef = useRef<{url: string; timestamp: number} | null>(
//     null,
//   );
//   // Track last purchase detection to prevent duplicates
//   const lastPurchaseDetectionRef = useRef<{
//     url: string;
//     timestamp: number;
//   } | null>(null);
//   useEffect(() => {
//     // Only update inputValue when we actually switch to a different tab
//     if (currentTabId !== lastTabIdRef.current) {
//       lastTabIdRef.current = currentTabId;
//       if (currentTab?.url) {
//         setInputValue(currentTab.url);
//       }
//     }
//   }, [currentTabId]);

//   // Tracking Consent Prompt - show once when user first opens browser
//   useEffect(() => {
//     if (_hasHydrated && trackingConsent === 'pending') {
//       // Small delay to let screen render first
//       const timer = setTimeout(() => {
//         Alert.alert(
//           'Improve Your Experience',
//           'Allow StylIQ to collect browsing analytics to personalize your shopping recommendations? This includes tracking pages visited, items saved, and shopping patterns.\n\nYou can change this anytime in settings.',
//           [
//             {
//               text: 'No Thanks',
//               style: 'cancel',
//               onPress: () => setTrackingConsent('declined'),
//             },
//             {
//               text: 'Allow',
//               onPress: () => setTrackingConsent('accepted'),
//             },
//           ],
//           {cancelable: false},
//         );
//       }, 500);
//       return () => clearTimeout(timer);
//     }
//   }, [_hasHydrated, trackingConsent, setTrackingConsent]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // ðŸ›ï¸ Fetch AI Shopping Suggestions once per app session (or if stale after 24h)
//   const fetchingRef = useRef(false);
//   useEffect(() => {
//     if (
//       userId &&
//       (!hasAiSuggestionsLoaded || isAiSuggestionsStale()) &&
//       !fetchingRef.current
//     ) {
//       fetchingRef.current = true;
//       fetchShoppingAssistantSuggestions().finally(() => {
//         fetchingRef.current = false;
//       });
//     }
//   }, [userId, hasAiSuggestionsLoaded]);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     // Skip if no URL or if we've already tracked this URL (ignore www/trailing slash differences)
//     if (!currentTab?.url) return;

//     // Normalize for comparison to avoid www/trailing slash loops
//     const normalizeForCompare = (url: string) => {
//       try {
//         const u = new URL(url);
//         return (
//           u.origin.replace('://www.', '://') +
//           u.pathname.replace(/\/$/, '') +
//           u.search
//         );
//       } catch {
//         return url;
//       }
//     };

//     if (
//       previousUrlRef.current &&
//       normalizeForCompare(currentTab.url) ===
//         normalizeForCompare(previousUrlRef.current)
//     ) {
//       return;
//     }

//     // If we had a previous page, save its metrics before moving to new page
//     if (previousUrlRef.current && pageStartTimeRef.current > 0) {
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       useShoppingStore
//         .getState()
//         .updateHistoryMetadata(previousUrlRef.current, {
//           dwellTime: dwell,
//           scrollDepth: maxScrollDepthRef.current,
//         });
//     }

//     // Now start tracking the new page
//     pageStartTimeRef.current = Date.now();
//     maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//     previousUrlRef.current = currentTab.url; // Store for next page transition
//     const source = getDomain(currentTab.url);
//     // Extract brand from URL/title for history tracking
//     const brand = shoppingAnalytics.extractBrand(
//       currentTab.title || '',
//       currentTab.url,
//     );
//     useShoppingStore
//       .getState()
//       .addToHistory(
//         currentTab.url,
//         currentTab.title || 'New Tab',
//         source,
//         brand,
//       );

//     // Record as a product view interaction
//     useShoppingStore
//       .getState()
//       .recordProductInteraction(currentTab.url, 'view');
//   }, [currentTab?.url]);

//   // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
//   useEffect(() => {
//     if (speech && isHoldingMic === false) {
//       setInputValue(speech);
//     }
//   }, [speech]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   // Normalize URLs for comparison (ignore www and trailing slash differences)
//   const normalizeUrlForComparison = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       // Remove www. and trailing slash for comparison
//       return (
//         urlObj.origin.replace('://www.', '://') +
//         urlObj.pathname.replace(/\/$/, '') +
//         urlObj.search
//       );
//     } catch {
//       return url;
//     }
//   };

//   // Check if two URLs are effectively the same (ignoring www and trailing slash)
//   const isSameUrl = (url1: string, url2: string) => {
//     return normalizeUrlForComparison(url1) === normalizeUrlForComparison(url2);
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   // Set URL and navigate - same flow as manual typing
//   const handleQuickShop = useCallback(
//     (url: string) => {
//       const newUrl = normalizeUrl(url);
//       setInputValue(newUrl);
//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, getDomain(url));
//       } else {
//         addTab(newUrl, getDomain(url));
//       }
//     },
//     [currentTab, updateTab, addTab],
//   );

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         // Clear previous text to ensure we get fresh content
//         lastPageTextRef.current = '';

//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 10000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);

//         // Wait for message with timeout - poll until we get text or timeout
//         const startTime = Date.now();
//         while (!lastPageTextRef.current && Date.now() - startTime < 500) {
//           await new Promise(resolve => setTimeout(resolve, 50));
//         }
//         console.log(
//           '[Bookmark] Page text received:',
//           lastPageTextRef.current?.length || 0,
//           'chars',
//         );
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//       setShowShareMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleShareToNotes = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowShareMenu(false);
//     navigate('SaveNote', {
//       url: currentTab.url,
//       title: currentTab.title || getDomain(currentTab.url),
//       content: '',
//     });
//   };

//   const handleShareButtonPress = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowShareMenu(true);
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         function detectCart() {
//           try {
//             // Look for common cart indicators
//             const pageUrl = window.location.href;
//             const isCartPage = /(cart|bag|basket|checkout|gp\\/cart)/.test(pageUrl.toLowerCase());

//             if (!isCartPage) return false;

//             // Extract item count from common patterns
//             let itemCount = 0;

//             // Pattern 1: Amazon-specific - look for cart count in various places
//             const amazonCartCount = document.querySelector('#nav-cart-count, .nav-cart-count, [data-csa-c-type="widget"][data-csa-c-slot-id="nav-cart-count"]');
//             if (amazonCartCount) {
//               const count = parseInt(amazonCartCount.textContent.trim());
//               if (!isNaN(count)) itemCount = count;
//             }

//             // Pattern 2: "Items in cart: X" or "Cart (X)"
//             if (itemCount === 0) {
//               const countMatch = document.body.innerText.match(/(?:cart|bag|basket)\\s*\\(?(\\d+)\\)?/i);
//               if (countMatch) itemCount = parseInt(countMatch[1]);
//             }

//             // Pattern 3: Look for cart badge/counter elements
//             if (itemCount === 0) {
//               const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"], [class*="qty"]');
//               for (const badge of badges) {
//                 const text = badge.textContent.trim();
//                 const match = text.match(/^\\d+$/);
//                 if (match) {
//                   itemCount = parseInt(match[0]);
//                   break;
//                 }
//               }
//             }

//             // Extract estimated total - Amazon specific patterns first
//             let estimatedTotal = 0;

//             // Amazon subtotal patterns
//             const amazonSubtotal = document.querySelector('#sc-subtotal-amount-activecart, .sc-subtotal-amount, [data-name="Subtotal"]');
//             if (amazonSubtotal) {
//               const priceMatch = amazonSubtotal.textContent.match(/[$Â£â‚¬Â¥]\\s*([\\d,]+\\.?\\d*)/);
//               if (priceMatch) {
//                 estimatedTotal = parseFloat(priceMatch[1].replace(/,/g, ''));
//               }
//             }

//             // Generic total patterns
//             if (estimatedTotal === 0) {
//               const totalMatch = document.body.innerText.match(/(?:subtotal|total|cart total)[:\\s]*[$Â£â‚¬Â¥]\\s*([\\d,]+\\.?\\d*)/i);
//               if (totalMatch) {
//                 estimatedTotal = parseFloat(totalMatch[1].replace(/,/g, ''));
//               }
//             }

//             // Only send if we found something meaningful
//             if (itemCount > 0 || estimatedTotal > 0) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'cartDetected',
//                 itemCount: itemCount,
//                 estimatedTotal: estimatedTotal,
//                 cartUrl: pageUrl
//               }));
//               return true;
//             }
//             return false;
//           } catch (e) {
//             console.log('Cart detection error:', e);
//             return false;
//           }
//         }

//         // Try immediately
//         if (!detectCart()) {
//           // Retry after delays for dynamically loaded content
//           setTimeout(detectCart, 500);
//           setTimeout(detectCart, 1500);
//           setTimeout(detectCart, 3000);
//         }
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     // IMPORTANT: Must be strict to avoid false positives on cart pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();
//           const pageTitle = document.title.toLowerCase();

//           // First, explicitly exclude cart/checkout pages that are NOT confirmations
//           const isCartPage = /(cart|bag|basket|checkout|payment|shipping|billing)\\b/.test(pageUrl);
//           const isCheckoutInProgress = /(enter.*address|payment.*method|select.*shipping|review.*order|place.*order|continue.*checkout|proceed.*checkout)/.test(pageText);

//           if (isCartPage && isCheckoutInProgress) {
//             // This is a checkout page in progress, not a confirmation
//             return;
//           }

//           // Purchase completion indicators - must be VERY specific
//           // Require order/confirmation number or specific completion language
//           const hasOrderNumber = /(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+[A-Z0-9-]{4,}/i.test(pageText);
//           const hasExplicitConfirmation = /(your order has been (placed|confirmed|received)|order successfully placed|purchase complete|thank you for your order|order confirmation|we've received your order)/.test(pageText);
//           const isConfirmationUrl = /(order-confirmation|order-complete|order-success|checkout-success|thank-you.*order|confirmation.*complete)/.test(pageUrl);

//           // Require at least 2 strong signals to confirm a purchase
//           const signals = [hasOrderNumber, hasExplicitConfirmation, isConfirmationUrl].filter(Boolean).length;
//           const isPurchaseConfirmation = signals >= 2 || (hasExplicitConfirmation && hasOrderNumber);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // Image long-press detection script
//     const imageLongPressScript = `
//       (function() {
//         if (window.__styliqImageLongPressAdded) return;
//         window.__styliqImageLongPressAdded = true;

//         let longPressTimer = null;
//         let touchedImage = null;

//         document.addEventListener('touchstart', function(e) {
//           const target = e.target;
//           if (target.tagName === 'IMG' && target.src) {
//             touchedImage = target;
//             longPressTimer = setTimeout(function() {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'imageLongPress',
//                 imageUrl: touchedImage.src,
//                 alt: touchedImage.alt || ''
//               }));
//             }, 500);
//           }
//         }, {passive: true});

//         document.addEventListener('touchend', function() {
//           if (longPressTimer) {
//             clearTimeout(longPressTimer);
//             longPressTimer = null;
//           }
//           touchedImage = null;
//         });

//         document.addEventListener('touchmove', function() {
//           if (longPressTimer) {
//             clearTimeout(longPressTimer);
//             longPressTimer = null;
//           }
//         });
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//     webRef.current.injectJavaScript(imageLongPressScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });

//         // Deduplicate: skip if same cart detected within 10 seconds
//         const now = Date.now();
//         const lastDetection = lastCartDetectionRef.current;
//         if (
//           lastDetection &&
//           lastDetection.url === data.cartUrl &&
//           now - lastDetection.timestamp < 10000
//         ) {
//           console.log('[MSG] Skipping duplicate cart detection');
//           return;
//         }
//         lastCartDetectionRef.current = {url: data.cartUrl, timestamp: now};

//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: now,
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });

//         // Deduplicate: skip if same purchase URL detected within 60 seconds
//         // (purchase confirmation pages often reload/re-render)
//         const now = Date.now();
//         const lastPurchase = lastPurchaseDetectionRef.current;
//         if (
//           lastPurchase &&
//           lastPurchase.url === data.purchaseUrl &&
//           now - lastPurchase.timestamp < 60000
//         ) {
//           console.log('[MSG] Skipping duplicate purchase detection');
//           return;
//         }
//         lastPurchaseDetectionRef.current = {
//           url: data.purchaseUrl,
//           timestamp: now,
//         };

//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       } else if (data.type === 'imageLongPress') {
//         // Handle image long-press - show save options
//         console.log('[MSG] Image long-pressed:', data.imageUrl);
//         setLongPressedImageUrl(data.imageUrl);
//         setShowImageSaveModal(true);
//         triggerHaptic('impactMedium');
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // Track last scroll Y for nav bar hide/show
//   const lastNavScrollY = useRef(0);
//   const bottomNavTranslateY = useRef(new Animated.Value(0)).current;
//   const isBottomNavHidden = useRef(false);
//   const NAV_HEIGHT = 100;
//   const SCROLL_THRESHOLD = 3;

//   // GOLD #9: Track scroll depth in WebView + nav bar hide/show
//   const handleWebViewScroll = useCallback(
//     (event: any) => {
//       try {
//         const {contentOffset, contentSize, layoutMeasurement} =
//           event.nativeEvent;
//         const diff = contentOffset.y - lastNavScrollY.current;

//         // Scrolling down (up on screen) - hide nav
//         if (
//           diff > SCROLL_THRESHOLD &&
//           !isBottomNavHidden.current &&
//           contentOffset.y > 10
//         ) {
//           isBottomNavHidden.current = true;
//           Animated.timing(bottomNavTranslateY, {
//             toValue: NAV_HEIGHT + insets.bottom,
//             duration: 300,
//             easing: Easing.out(Easing.cubic),
//             useNativeDriver: true,
//           }).start();
//         }
//         // Scrolling up (down on screen) - show nav
//         else if (diff < -SCROLL_THRESHOLD && isBottomNavHidden.current) {
//           isBottomNavHidden.current = false;
//           Animated.timing(bottomNavTranslateY, {
//             toValue: 0,
//             duration: 300,
//             easing: Easing.out(Easing.cubic),
//             useNativeDriver: true,
//           }).start();
//         }

//         lastNavScrollY.current = contentOffset.y;

//         if (contentSize.height > 0) {
//           const scrollPosition = contentOffset.y;
//           const viewportHeight = layoutMeasurement.height;
//           const contentHeight = contentSize.height;
//           // Calculate scroll depth as percentage (0-100)
//           const scrollDepth = Math.min(
//             100,
//             Math.round(
//               ((scrollPosition + viewportHeight) / contentHeight) * 100,
//             ),
//           );
//           // Update max scroll depth reached
//           if (scrollDepth > maxScrollDepthRef.current) {
//             maxScrollDepthRef.current = scrollDepth;
//           }
//         }
//       } catch (e) {
//         // Silently fail if scroll metrics unavailable
//       }
//     },
//     [bottomNavTranslateY, insets.bottom],
//   );

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     headerTint: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       height: insets.top + 55,
//       backgroundColor: 'rgba(0, 0, 0, 0.26)',
//       zIndex: 998,
//     },
//     header: {
//       position: 'absolute',
//       top: insets.top + 55,
//       left: 0,
//       right: 0,
//       zIndex: 999,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: 'rgba(0, 0, 0, 0.65)',
//       borderRadius: 25,
//       borderWidth: tokens.borderWidth.md,
//       borderColor: theme.colors.foreground,
//       paddingHorizontal: 14,
//       height: 50,
//       // marginTop: 5,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//     },
//     // Bottom navbar styles - pill shaped like main BottomNavigation
//     bottomNavContainer: {
//       position: 'absolute',
//       bottom: 0,
//       left: 0,
//       right: 0,
//       zIndex: 1000,
//       paddingBottom: insets.bottom < 20 ? 10 : 0,
//     },
//     bottomNavPill: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       width: '90%',
//       alignSelf: 'center',
//       borderRadius: 50,
//       height: 55,
//       borderWidth: tokens.borderWidth.md,
//       borderColor: theme.colors.muted,
//       overflow: 'hidden',
//       shadowColor: '#000',
//       shadowOpacity: 0.2,
//       shadowRadius: 12,
//       shadowOffset: {width: 0, height: 4},
//       backgroundColor: 'rgba(0, 0, 0, 0.35)',
//       marginBottom: insets.bottom < 20 ? 10 : 25,
//     },
//     bottomNavPillFallback: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       width: '90%',
//       alignSelf: 'center',
//       borderRadius: 50,
//       height: 55,
//       borderWidth: tokens.borderWidth.md,
//       borderColor: theme.colors.muted,
//       overflow: 'hidden',
//       shadowColor: '#000',
//       shadowOpacity: 0.2,
//       shadowRadius: 12,
//       shadowOffset: {width: 0, height: 4},
//       backgroundColor: 'rgba(0, 0, 0, 0.7)',
//       marginBottom: insets.bottom < 20 ? 10 : 25,
//     },
//     bottomNavItem: {
//       flex: 1,
//       alignItems: 'center',
//       justifyContent: 'center',
//       paddingVertical: 8,
//     },
//     tabsButtonNav: {
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCountNav: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginTop: 60,
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   // ðŸ”¥ VOICE ADD
//   const handleMicPressIn = async () => {
//     const ok = await prepareAudio();
//     if (!ok) return;
//     ReactNativeHapticFeedback.trigger('impactLight');
//     setIsHoldingMic(true);
//     startListening();
//   };

//   // Ref to track if we should auto-submit after voice input
//   const shouldAutoSubmitVoice = useRef(false);
//   const wasRecording = useRef(false);

//   const handleMicPressOut = () => {
//     setIsHoldingMic(false);
//     stopListening();
//     ReactNativeHapticFeedback.trigger('selection');
//     // Flag to auto-submit after voice input ends (WebBrowser address bar only)
//     shouldAutoSubmitVoice.current = true;
//   };

//   // Auto-submit when recording stops after mic release (voice input only)
//   useEffect(() => {
//     // Detect transition from recording to not recording
//     if (wasRecording.current && !isRecording && shouldAutoSubmitVoice.current) {
//       shouldAutoSubmitVoice.current = false;
//       // Delay to ensure inputValue is updated from speech, then submit
//       setTimeout(() => {
//         handleSubmit();
//       }, 400);
//     }
//     wasRecording.current = isRecording;
//   }, [isRecording]); // Only trigger on recording state change, not inputValue

//   // Calculate address bar header height for content padding (like HomeScreen's HEADER_HEIGHT)
//   const ADDRESS_BAR_HEIGHT = 52; // urlBar height (40) + paddingBottom (12)

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       {/* Full-screen scrollable content - exactly like HomeScreen */}
//       {showLanding ? (
//         <ScrollView
//           contentContainerStyle={{
//             paddingTop: insets.top + 55 + ADDRESS_BAR_HEIGHT, // space for global header + address bar
//             paddingBottom: insets.bottom + 90, // space for bottom nav
//             minHeight: '100%',
//           }}
//           scrollEventThrottle={16}
//           onScroll={event => {
//             const y = event.nativeEvent.contentOffset.y;
//             const diff = y - lastNavScrollY.current;

//             // Scrolling down - hide nav
//             if (
//               diff > SCROLL_THRESHOLD &&
//               !isBottomNavHidden.current &&
//               y > 10
//             ) {
//               isBottomNavHidden.current = true;
//               Animated.timing(bottomNavTranslateY, {
//                 toValue: NAV_HEIGHT + insets.bottom,
//                 duration: 300,
//                 easing: Easing.out(Easing.cubic),
//                 useNativeDriver: true,
//               }).start();
//             }
//             // Scrolling up - show nav
//             else if (diff < -SCROLL_THRESHOLD && isBottomNavHidden.current) {
//               isBottomNavHidden.current = false;
//               Animated.timing(bottomNavTranslateY, {
//                 toValue: 0,
//                 duration: 300,
//                 easing: Easing.out(Easing.cubic),
//                 useNativeDriver: true,
//               }).start();
//             }

//             lastNavScrollY.current = y;
//           }}
//           showsVerticalScrollIndicator={false}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View
//           ref={containerRef}
//           style={StyleSheet.absoluteFill}
//           collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={StyleSheet.absoluteFill}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Content inset to scroll under floating header (like HomeScreen)
//             contentInset={{
//               top: insets.top + 55 + ADDRESS_BAR_HEIGHT,
//               bottom: insets.bottom + 90,
//             }}
//             contentInsetAdjustmentBehavior="never"
//             automaticallyAdjustContentInsets={false}
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               // Debounce navigation state changes to prevent rapid URL toggling
//               if (!navState.url || !currentTab) return;

//               // Skip if same URL (ignore www/trailing slash differences)
//               if (
//                 isSameUrl(navState.url, currentTab.url) &&
//                 isSameUrl(navState.url, lastNavUrlRef.current)
//               ) {
//                 return;
//               }

//               // Clear any pending debounce
//               if (navStateDebounceRef.current) {
//                 clearTimeout(navStateDebounceRef.current);
//               }

//               // Store the latest URL
//               lastNavUrlRef.current = navState.url;

//               // Debounce the update - only apply after URL is stable for 300ms
//               navStateDebounceRef.current = setTimeout(() => {
//                 // Double-check the URL is still the same after debounce
//                 if (
//                   navState.url === lastNavUrlRef.current &&
//                   !isSameUrl(navState.url, currentTab.url)
//                 ) {
//                   updateTab(
//                     currentTab.id,
//                     navState.url,
//                     navState.title || currentTab.title,
//                   );
//                   setInputValue(navState.url);
//                   // Track visit history with brand
//                   const navBrand = shoppingAnalytics.extractBrand(
//                     navState.title || '',
//                     navState.url,
//                   );
//                   addToHistory(
//                     navState.url,
//                     navState.title || getDomain(navState.url),
//                     getDomain(navState.url),
//                     navBrand,
//                   );
//                 }
//               }, 300);
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//             pullToRefreshEnabled={true}
//             allowsBackForwardNavigationGestures={true}
//           />
//         </View>
//       )}

//       {/* Light tint overlay for global header area */}
//       <View style={styles.headerTint} pointerEvents="none" />

//       {/* Floating Address Bar Header - renders after content to appear on top */}
//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* Refresh button */}
//           {currentTab?.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => webRef.current?.reload()}>
//               <MaterialIcons
//                 name="refresh"
//                 size={22}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
//           <TouchableOpacity
//             onPressIn={handleMicPressIn}
//             onPressOut={handleMicPressOut}
//             style={styles.iconButton}>
//             <MaterialIcons
//               name={isRecording ? 'mic' : 'mic-none'}
//               size={22}
//               color={
//                 isRecording ? theme.colors.primary : theme.colors.foreground3
//               }
//             />
//           </TouchableOpacity>
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {/* Browsers Bottom Navbar - Pill shaped with hide on scroll */}
//       {!showTabsView && (
//         <Animated.View
//           style={[
//             styles.bottomNavContainer,
//             {transform: [{translateY: bottomNavTranslateY}]},
//           ]}>
//           {isLiquidGlassSupported ? (
//             <LiquidGlassView
//               style={styles.bottomNavPill}
//               effect="clear"
//               tintColor="rgba(0, 0, 0, 0.48)"
//               colorScheme="system">
//               <AppleTouchFeedback
//                 onPress={() => navigate('Home')}
//                 hapticStyle="impactLight"
//                 style={{
//                   padding: moderateScale(tokens.spacing.xxs),
//                   marginLeft: moderateScale(tokens.spacing.xsm),
//                 }}>
//                 <Icon name="home" size={26} color={theme.colors.foreground} />
//               </AppleTouchFeedback>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={() => webRef.current?.goBack()}>
//                 <MaterialIcons
//                   name="arrow-back-ios"
//                   size={22}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={() => webRef.current?.goForward()}>
//                 <MaterialIcons
//                   name="arrow-forward-ios"
//                   size={22}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               {/* Bookmark button - commented out
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleAddToBookmarks}>
//                 <MaterialIcons
//                   name={bookmarked ? 'bookmark' : 'bookmark-border'}
//                   size={24}
//                   color={
//                     bookmarked ? theme.colors.button1 : theme.colors.buttonText1
//                   }
//                 />
//               </TouchableOpacity>
//               */}
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleShareButtonPress}>
//                 <MaterialIcons
//                   name="ios-share"
//                   size={24}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={openTabsView}>
//                 <View style={styles.tabsButtonNav}>
//                   <Text style={styles.tabsCountNav}>{tabs.length || 1}</Text>
//                 </View>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={28}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//             </LiquidGlassView>
//           ) : (
//             <View style={styles.bottomNavPillFallback}>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={() => webRef.current?.goBack()}>
//                 <MaterialIcons
//                   name="arrow-back-ios"
//                   size={22}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={() => webRef.current?.goForward()}>
//                 <MaterialIcons
//                   name="arrow-forward-ios"
//                   size={22}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               {/* Bookmark button - commented out
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleAddToBookmarks}>
//                 <MaterialIcons
//                   name={bookmarked ? 'bookmark' : 'bookmark-border'}
//                   size={24}
//                   color={
//                     bookmarked ? theme.colors.button1 : theme.colors.buttonText1
//                   }
//                 />
//               </TouchableOpacity>
//               */}
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleShareButtonPress}>
//                 <MaterialIcons
//                   name="ios-share"
//                   size={24}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={openTabsView}>
//                 <View style={styles.tabsButtonNav}>
//                   <Text style={styles.tabsCountNav}>{tabs.length || 1}</Text>
//                 </View>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.bottomNavItem}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={28}
//                   color={theme.colors.buttonText1}
//                 />
//               </TouchableOpacity>
//             </View>
//           )}
//         </Animated.View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//           aiSuggestions={aiShoppingAssistantSuggestions}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs
//                 .filter(tab => tab.url)
//                 .map((tab, index) => {
//                   const isDragging = draggingIndex === index;
//                   const isDropTarget =
//                     draggedOverIndex === index && draggingIndex !== index;
//                   const panResponder = createPanResponder(index);

//                   return (
//                     <Animated.View
//                       key={tab.id}
//                       onLayout={e => handleTabLayout(index, e)}
//                       style={[
//                         isDragging && {
//                           transform: [
//                             {translateX: dragAnimatedValue.x},
//                             {translateY: dragAnimatedValue.y},
//                             {scale: dragScale},
//                           ],
//                           zIndex: 1000,
//                           elevation: 10,
//                         },
//                         isDropTarget && {
//                           opacity: 0.5,
//                         },
//                       ]}
//                       {...panResponder.panHandlers}>
//                       <TouchableOpacity
//                         style={[
//                           styles.tabCard,
//                           tab.id === currentTabId && styles.tabCardActive,
//                           isDragging && styles.tabCardDragging,
//                         ]}
//                         onPress={() => handleSelectTab(tab.id)}
//                         onLongPress={() => handleLongPress(index)}
//                         delayLongPress={300}
//                         activeOpacity={0.8}>
//                         {/* Tab Preview Background */}
//                         <View style={styles.tabCardPreviewContainer}>
//                           {tab.screenshot ? (
//                             <Image
//                               source={{uri: tab.screenshot}}
//                               style={styles.tabCardScreenshot}
//                               resizeMode="cover"
//                             />
//                           ) : (
//                             <>
//                               {/* Gradient/colored background when no screenshot */}
//                               <View
//                                 style={[
//                                   styles.tabCardPlaceholder,
//                                   {backgroundColor: theme.colors.surface},
//                                 ]}
//                               />
//                               <Image
//                                 source={{
//                                   uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                     tab.url,
//                                   )}.ico`,
//                                 }}
//                                 style={styles.tabCardFavicon}
//                                 defaultSource={require('../assets/images/desktop-2.jpg')}
//                               />
//                             </>
//                           )}
//                         </View>

//                         {/* Overlay with text content */}
//                         <View style={styles.tabCardOverlay}>
//                           <View style={styles.tabCardHeader}>
//                             <Text style={styles.tabCardTitle} numberOfLines={2}>
//                               {tab.title || getDomain(tab.url)}
//                             </Text>
//                             <TouchableOpacity
//                               style={styles.tabCardClose}
//                               onPress={() => handleCloseTab(tab.id)}
//                               hitSlop={{
//                                 top: 10,
//                                 bottom: 10,
//                                 left: 10,
//                                 right: 10,
//                               }}>
//                               <MaterialIcons
//                                 name="close"
//                                 size={16}
//                                 color="#fff"
//                               />
//                             </TouchableOpacity>
//                           </View>
//                           <View style={styles.tabCardContent}>
//                             <Text style={styles.tabCardDomain}>
//                               {getDomain(tab.url)}
//                             </Text>
//                           </View>
//                         </View>
//                       </TouchableOpacity>
//                     </Animated.View>
//                   );
//                 })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Share Menu Modal */}
//       <Modal
//         visible={showShareMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowShareMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => setShowShareMenu(false)}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Share</Text>
//             {/* Save to My Notes */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleShareToNotes}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="note-add" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Save to My Notes</Text>
//               <MaterialIcons
//                 name="arrow-forward-ios"
//                 size={16}
//                 color={theme.colors.foreground3}
//                 style={styles.saveMenuItemCheck}
//               />
//             </TouchableOpacity>
//             {/* Share via iOS */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="ios-share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share via...</Text>
//               <MaterialIcons
//                 name="arrow-forward-ios"
//                 size={16}
//                 color={theme.colors.foreground3}
//                 style={styles.saveMenuItemCheck}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Image Save Modal */}
//       <Modal
//         visible={showImageSaveModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowImageSaveModal(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => setShowImageSaveModal(false)}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Image</Text>
//             {/* Save to Photos */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={async () => {
//                 if (longPressedImageUrl) {
//                   setShowImageSaveModal(false);
//                   try {
//                     await ImageSaverModule.saveImageFromUrl(
//                       longPressedImageUrl,
//                     );
//                     triggerHaptic('notificationSuccess');
//                   } catch (error) {
//                     console.log('Image save error:', error);
//                     triggerHaptic('notificationError');
//                   }
//                 } else {
//                   setShowImageSaveModal(false);
//                 }
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="photo-library" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Save to Photos</Text>
//               <MaterialIcons
//                 name="arrow-forward-ios"
//                 size={16}
//                 color={theme.colors.foreground3}
//                 style={styles.saveMenuItemCheck}
//               />
//             </TouchableOpacity>
//             {/* Add to Wardrobe */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 if (longPressedImageUrl) {
//                   navigate('AddItem', {imageUrl: longPressedImageUrl});
//                 }
//                 setShowImageSaveModal(false);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="checkroom" size={22} color="#8b5cf6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Wardrobe</Text>
//               <MaterialIcons
//                 name="arrow-forward-ios"
//                 size={16}
//                 color={theme.colors.foreground3}
//                 style={styles.saveMenuItemCheck}
//               />
//             </TouchableOpacity>
//             {/* Save to Inspired Looks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={async () => {
//                 if (longPressedImageUrl && userId) {
//                   setShowImageSaveModal(false);
//                   try {
//                     const response = await fetch(
//                       `${API_BASE_URL}/saved-looks`,
//                       {
//                         method: 'POST',
//                         headers: {'Content-Type': 'application/json'},
//                         body: JSON.stringify({
//                           user_id: userId,
//                           image_url: longPressedImageUrl,
//                           name: 'Web Inspiration',
//                         }),
//                       },
//                     );
//                     if (response.ok) {
//                       triggerHaptic('notificationSuccess');
//                     } else {
//                       triggerHaptic('notificationError');
//                     }
//                   } catch (error) {
//                     console.log('Save to Inspired Looks error:', error);
//                     triggerHaptic('notificationError');
//                   }
//                 } else {
//                   setShowImageSaveModal(false);
//                 }
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="auto-awesome" size={22} color="#f59e0b" />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 Save to Inspired Looks
//               </Text>
//               <MaterialIcons
//                 name="arrow-forward-ios"
//                 size={16}
//                 color={theme.colors.foreground3}
//                 style={styles.saveMenuItemCheck}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             {/* <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity> */}

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
//             <TouchableOpacity
//               onPressIn={handleMicPressIn}
//               onPressOut={handleMicPressOut}>
//               <MaterialIcons
//                 name={isRecording ? 'mic' : 'mic-none'}
//                 size={20}
//                 color={
//                   isRecording ? theme.colors.primary : theme.colors.foreground3
//                 }
//                 style={styles.bookmarksSearchMic}
//               />
//             </TouchableOpacity>
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

///////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import {tokens} from '../styles/tokens/tokens';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';
// // ðŸ”¥ VOICE ADD/
// import {useVoiceControl} from '../hooks/useVoiceControl';
// import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
// import {PermissionsAndroid, Platform} from 'react-native';
// import {API_BASE_URL} from '../config/api';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   // ðŸ”¥ VOICE ADD
//   const {speech, isRecording, startListening, stopListening} =
//     useVoiceControl();
//   const [isHoldingMic, setIsHoldingMic] = useState(false);
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   console.log('WebBrowserScreen mounted, userId:', userId);
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//     aiShoppingAssistantSuggestions,
//     setAiShoppingAssistantSuggestions,
//     hasAiSuggestionsLoaded,
//     setHasAiSuggestionsLoaded,
//     isAiSuggestionsStale,
//   } = useShoppingStore();

//   // ðŸ”¥ VOICE ADD
//   async function prepareAudio() {
//     try {
//       if (Platform.OS === 'android') {
//         const granted = await PermissionsAndroid.request(
//           PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
//         );
//         if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
//       } else {
//         const AV = require('react-native').NativeModules.AVAudioSession;
//         if (AV?.setCategory) {
//           await AV.setCategory('PlayAndRecord');
//           await AV.setActive(true);
//         }
//       }
//       return true;
//     } catch {
//       return false;
//     }
//   }

//   // ðŸ›ï¸ Fetch shopping suggestions with smart context classification
//   async function fetchShoppingAssistantSuggestions() {
//     if (!userId || (hasAiSuggestionsLoaded && !isAiSuggestionsStale())) {
//       return;
//     }

//     const SHOPPING_PROMPT = `SHOPPING ASSISTANT MODE: Analyze the user's wardrobe, style profile, and calendar to generate 5 HIGHLY SPECIFIC personalized shopping recommendations.

// ðŸŽ¯ CRITICAL REQUIREMENTS:
// 1. Access user's wardrobe inventory to identify SPECIFIC gaps (colors owned, categories missing, fit preferences)
// 2. Reference style profile: body type, preferred colors, disliked styles, climate
// 3. Check calendar for upcoming events needing specific pieces
// 4. NO GENERIC SUGGESTIONS - every recommendation must PROVE you know their wardrobe
// 5. EVERY recommendation MUST explicitly name SPECIFIC items they already own

// â­ MANDATORY WARDROBE REFERENCING (you MUST do this):
// - Use language patterns like "pair with your [COLOR] [ITEM] you own"
// - Examples of GOOD recommendations:
//   â€¢ "Navy blazer - pairs perfectly with your sleek white pants and complements your gray cardigans"
//   â€¢ "Camel belt - fills your warm-neutral gap; works with your dark bottoms and existing brown shoes"
//   â€¢ "Black tailored trousers - adds formality; you have 8 tops (mostly navy/gray) but only 2 bottoms"
//   â€¢ "Cream linen shirt - bridges your white and navy pieces; works for your business casual events next month"
//   â€¢ "Burgundy wool sweater - complements your warm undertones and pairs with the cream chinos you own"

// - Examples of BAD recommendations (NEVER do these):
//   â€¢ âŒ "Elevate your look with a premium leather belt"
//   â€¢ âŒ "Fill the gap with classic black trousers"
//   â€¢ âŒ "Add a stylish blazer to complete your wardrobe"

// Use strategies:
// 1. **CALENDAR**: Reference specific events and what they NEED
// 2. **WARDROBE_GAP**: Name specific missing colors or categories (e.g., "you lack warm-toned bottoms") AND list similar items they own
// 3. **STYLE_UPGRADE**: Reference existing pieces BY NAME and suggest exact complementary items
// 4. **TRENDING**: Name trending style AND explain why THEIR specific aesthetic needs it
// 5. **COMPLETE_LOOK**: Reference saved outfits and name SPECIFIC pieces missing

// Respond with JSON array of exactly 5 objects with SPECIFIC recommendations:
// [
//   {"text": "[Color] [fit] [garment] - [concrete reason naming specific items they own]", "site": "https://nordstrom.com", "search": "[specific search]", "strategy": "calendar"},
//   ...
// ]`;

//     try {
//       const response = await fetch(`${API_BASE_URL}/ai/chat`, {
//         method: 'POST',
//         headers: {'Content-Type': 'application/json'},
//         body: JSON.stringify({
//           user_id: userId,
//           messages: [{role: 'user', content: SHOPPING_PROMPT}],
//         }),
//       });

//       if (!response.ok) throw new Error('AI request failed');

//       const data = await response.json();
//       const aiText = data.reply || data.text || data.response || '';

//       try {
//         const parsed = JSON.parse(aiText.match(/\[[\s\S]*\]/)?.[0] || '[]');
//         if (Array.isArray(parsed) && parsed.length > 0) {
//           setAiShoppingAssistantSuggestions(parsed);
//           setHasAiSuggestionsLoaded(true);
//         }
//       } catch {
//         // Failed to parse shopping suggestions
//       }
//     } catch (err) {
//       // Shopping suggestions fetch failed
//     }
//   }

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // ðŸ›ï¸ Fetch AI Shopping Suggestions once per app session (or if stale after 24h)
//   useEffect(() => {
//     if (userId && (!hasAiSuggestionsLoaded || isAiSuggestionsStale())) {
//       fetchShoppingAssistantSuggestions();
//     }
//   }, [userId, hasAiSuggestionsLoaded]);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
//   useEffect(() => {
//     if (speech && isHoldingMic === false) {
//       setInputValue(speech);
//     }
//   }, [speech]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // Track last scroll Y for nav bar hide/show
//   const lastNavScrollY = useRef(0);

//   // GOLD #9: Track scroll depth in WebView + nav bar hide/show
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;

//       // Update global navScrollY for bottom nav hide/show (same as HomeScreen)
//       if (global.__navScrollY) {
//         global.__navScrollY.setValue(contentOffset.y);
//       }
//       lastNavScrollY.current = contentOffset.y;

//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     headerTint: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       height: insets.top + 55,
//       backgroundColor: 'rgba(0, 0, 0, 0.26)',
//       zIndex: 998,
//     },
//     header: {
//       position: 'absolute',
//       top: insets.top + 55,
//       left: 0,
//       right: 0,
//       zIndex: 999,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: 'rgba(0, 0, 0, 0.73)',
//       borderRadius: 25,
//       borderWidth: tokens.borderWidth.md,
//       borderColor: theme.colors.foreground,
//       paddingHorizontal: 14,
//       height: 50,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   // ðŸ”¥ VOICE ADD
//   const handleMicPressIn = async () => {
//     const ok = await prepareAudio();
//     if (!ok) return;
//     ReactNativeHapticFeedback.trigger('impactLight');
//     setIsHoldingMic(true);
//     startListening();
//   };

//   const handleMicPressOut = () => {
//     setIsHoldingMic(false);
//     stopListening();
//     ReactNativeHapticFeedback.trigger('selection');
//   };

//   // Calculate address bar header height for content padding (like HomeScreen's HEADER_HEIGHT)
//   const ADDRESS_BAR_HEIGHT = 52; // urlBar height (40) + paddingBottom (12)

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       {/* Full-screen scrollable content - exactly like HomeScreen */}
//       {showLanding ? (
//         <ScrollView
//           contentContainerStyle={{
//             paddingTop: insets.top + 55 + ADDRESS_BAR_HEIGHT, // space for global header + address bar
//             paddingBottom: insets.bottom + 90, // space for bottom nav
//             minHeight: '100%',
//           }}
//           scrollEventThrottle={16}
//           onScroll={event => {
//             // Update global navScrollY for bottom nav hide/show (same as HomeScreen)
//             if (global.__navScrollY) {
//               global.__navScrollY.setValue(event.nativeEvent.contentOffset.y);
//             }
//           }}
//           showsVerticalScrollIndicator={false}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View
//           ref={containerRef}
//           style={StyleSheet.absoluteFill}
//           collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={StyleSheet.absoluteFill}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Content inset to scroll under floating header (like HomeScreen)
//             contentInset={{
//               top: insets.top + 55 + ADDRESS_BAR_HEIGHT,
//               bottom: insets.bottom + 90,
//             }}
//             contentInsetAdjustmentBehavior="never"
//             automaticallyAdjustContentInsets={false}
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Light tint overlay for global header area */}
//       <View style={styles.headerTint} pointerEvents="none" />

//       {/* Floating Address Bar Header - renders after content to appear on top */}
//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
//           <TouchableOpacity
//             onPressIn={handleMicPressIn}
//             onPressOut={handleMicPressOut}
//             style={styles.iconButton}>
//             <MaterialIcons
//               name={isRecording ? 'mic' : 'mic-none'}
//               size={22}
//               color={
//                 isRecording ? theme.colors.primary : theme.colors.foreground3
//               }
//             />
//           </TouchableOpacity>

//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.tabsButton}
//                 onPress={openTabsView}>
//                 <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleAddToBookmarks}>
//                 <MaterialIcons
//                   name={bookmarked ? 'bookmark' : 'bookmark-border'}
//                   size={24}
//                   color={
//                     bookmarked ? theme.colors.primary : theme.colors.foreground2
//                   }
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//           aiSuggestions={aiShoppingAssistantSuggestions}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
//             <TouchableOpacity
//               onPressIn={handleMicPressIn}
//               onPressOut={handleMicPressOut}>
//               <MaterialIcons
//                 name={isRecording ? 'mic' : 'mic-none'}
//                 size={20}
//                 color={
//                   isRecording ? theme.colors.primary : theme.colors.foreground3
//                 }
//                 style={styles.bookmarksSearchMic}
//               />
//             </TouchableOpacity>
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

///////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';
// // ðŸ”¥ VOICE ADD/
// import {useVoiceControl} from '../hooks/useVoiceControl';
// import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
// import {PermissionsAndroid, Platform} from 'react-native';
// import {API_BASE_URL} from '../config/api';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   // ðŸ”¥ VOICE ADD
//   const {speech, isRecording, startListening, stopListening} =
//     useVoiceControl();
//   const [isHoldingMic, setIsHoldingMic] = useState(false);
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   console.log('WebBrowserScreen mounted, userId:', userId);
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//     aiShoppingAssistantSuggestions,
//     setAiShoppingAssistantSuggestions,
//     hasAiSuggestionsLoaded,
//     setHasAiSuggestionsLoaded,
//     isAiSuggestionsStale,
//   } = useShoppingStore();

//   // ðŸ”¥ VOICE ADD
//   async function prepareAudio() {
//     try {
//       if (Platform.OS === 'android') {
//         const granted = await PermissionsAndroid.request(
//           PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
//         );
//         if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
//       } else {
//         const AV = require('react-native').NativeModules.AVAudioSession;
//         if (AV?.setCategory) {
//           await AV.setCategory('PlayAndRecord');
//           await AV.setActive(true);
//         }
//       }
//       return true;
//     } catch {
//       return false;
//     }
//   }

//   // ðŸ›ï¸ Fetch shopping suggestions with smart context classification
//   async function fetchShoppingAssistantSuggestions() {
//     if (!userId || (hasAiSuggestionsLoaded && !isAiSuggestionsStale())) {
//       return;
//     }

//     const SHOPPING_PROMPT = `SHOPPING ASSISTANT MODE: Analyze the user's wardrobe, style profile, and calendar to generate 5 HIGHLY SPECIFIC personalized shopping recommendations.

// ðŸŽ¯ CRITICAL REQUIREMENTS:
// 1. Access user's wardrobe inventory to identify SPECIFIC gaps (colors owned, categories missing, fit preferences)
// 2. Reference style profile: body type, preferred colors, disliked styles, climate
// 3. Check calendar for upcoming events needing specific pieces
// 4. NO GENERIC SUGGESTIONS - every recommendation must PROVE you know their wardrobe
// 5. EVERY recommendation MUST explicitly name SPECIFIC items they already own

// â­ MANDATORY WARDROBE REFERENCING (you MUST do this):
// - Use language patterns like "pair with your [COLOR] [ITEM] you own"
// - Examples of GOOD recommendations:
//   â€¢ "Navy blazer - pairs perfectly with your sleek white pants and complements your gray cardigans"
//   â€¢ "Camel belt - fills your warm-neutral gap; works with your dark bottoms and existing brown shoes"
//   â€¢ "Black tailored trousers - adds formality; you have 8 tops (mostly navy/gray) but only 2 bottoms"
//   â€¢ "Cream linen shirt - bridges your white and navy pieces; works for your business casual events next month"
//   â€¢ "Burgundy wool sweater - complements your warm undertones and pairs with the cream chinos you own"

// - Examples of BAD recommendations (NEVER do these):
//   â€¢ âŒ "Elevate your look with a premium leather belt"
//   â€¢ âŒ "Fill the gap with classic black trousers"
//   â€¢ âŒ "Add a stylish blazer to complete your wardrobe"

// Use strategies:
// 1. **CALENDAR**: Reference specific events and what they NEED
// 2. **WARDROBE_GAP**: Name specific missing colors or categories (e.g., "you lack warm-toned bottoms") AND list similar items they own
// 3. **STYLE_UPGRADE**: Reference existing pieces BY NAME and suggest exact complementary items
// 4. **TRENDING**: Name trending style AND explain why THEIR specific aesthetic needs it
// 5. **COMPLETE_LOOK**: Reference saved outfits and name SPECIFIC pieces missing

// Respond with JSON array of exactly 5 objects with SPECIFIC recommendations:
// [
//   {"text": "[Color] [fit] [garment] - [concrete reason naming specific items they own]", "site": "https://nordstrom.com", "search": "[specific search]", "strategy": "calendar"},
//   ...
// ]`;

//     try {
//       const response = await fetch(`${API_BASE_URL}/ai/chat`, {
//         method: 'POST',
//         headers: {'Content-Type': 'application/json'},
//         body: JSON.stringify({
//           user_id: userId,
//           messages: [{role: 'user', content: SHOPPING_PROMPT}],
//         }),
//       });

//       if (!response.ok) throw new Error('AI request failed');

//       const data = await response.json();
//       const aiText = data.reply || data.text || data.response || '';

//       try {
//         const parsed = JSON.parse(aiText.match(/\[[\s\S]*\]/)?.[0] || '[]');
//         if (Array.isArray(parsed) && parsed.length > 0) {
//           setAiShoppingAssistantSuggestions(parsed);
//           setHasAiSuggestionsLoaded(true);
//         }
//       } catch {
//         // Failed to parse shopping suggestions
//       }
//     } catch (err) {
//       // Shopping suggestions fetch failed
//     }
//   }

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // ðŸ›ï¸ Fetch AI Shopping Suggestions once per app session (or if stale after 24h)
//   useEffect(() => {
//     if (userId && (!hasAiSuggestionsLoaded || isAiSuggestionsStale())) {
//       fetchShoppingAssistantSuggestions();
//     }
//   }, [userId, hasAiSuggestionsLoaded]);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
//   useEffect(() => {
//     if (speech && isHoldingMic === false) {
//       setInputValue(speech);
//     }
//   }, [speech]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   // ðŸ”¥ VOICE ADD
//   const handleMicPressIn = async () => {
//     const ok = await prepareAudio();
//     if (!ok) return;
//     ReactNativeHapticFeedback.trigger('impactLight');
//     setIsHoldingMic(true);
//     startListening();
//   };

//   const handleMicPressOut = () => {
//     setIsHoldingMic(false);
//     stopListening();
//     ReactNativeHapticFeedback.trigger('selection');
//   };

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
//           <TouchableOpacity
//             onPressIn={handleMicPressIn}
//             onPressOut={handleMicPressOut}
//             style={styles.iconButton}>
//             <MaterialIcons
//               name={isRecording ? 'mic' : 'mic-none'}
//               size={22}
//               color={
//                 isRecording ? theme.colors.primary : theme.colors.foreground3
//               }
//             />
//           </TouchableOpacity>

//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.tabsButton}
//                 onPress={openTabsView}>
//                 <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleAddToBookmarks}>
//                 <MaterialIcons
//                   name={bookmarked ? 'bookmark' : 'bookmark-border'}
//                   size={24}
//                   color={bookmarked ? theme.colors.primary : theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//           aiSuggestions={aiShoppingAssistantSuggestions}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
//             <TouchableOpacity
//               onPressIn={handleMicPressIn}
//               onPressOut={handleMicPressOut}>
//               <MaterialIcons
//                 name={isRecording ? 'mic' : 'mic-none'}
//                 size={20}
//                 color={
//                   isRecording ? theme.colors.primary : theme.colors.foreground3
//                 }
//                 style={styles.bookmarksSearchMic}
//               />
//             </TouchableOpacity>
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

///////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';
// // ðŸ”¥ VOICE ADD
// import {useVoiceControl} from '../hooks/useVoiceControl';
// import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
// import {PermissionsAndroid, Platform} from 'react-native';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   // ðŸ”¥ VOICE ADD
//   const {speech, isRecording, startListening, stopListening} =
//     useVoiceControl();
//   const [isHoldingMic, setIsHoldingMic] = useState(false);
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   // ðŸ”¥ VOICE ADD
//   async function prepareAudio() {
//     try {
//       if (Platform.OS === 'android') {
//         const granted = await PermissionsAndroid.request(
//           PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
//         );
//         if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
//       } else {
//         const AV = require('react-native').NativeModules.AVAudioSession;
//         if (AV?.setCategory) {
//           await AV.setCategory('PlayAndRecord');
//           await AV.setActive(true);
//         }
//       }
//       return true;
//     } catch {
//       return false;
//     }
//   }

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
//   useEffect(() => {
//     if (speech && isHoldingMic === false) {
//       setInputValue(speech);
//     }
//   }, [speech]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   // ðŸ”¥ VOICE ADD
//   const handleMicPressIn = async () => {
//     const ok = await prepareAudio();
//     if (!ok) return;
//     ReactNativeHapticFeedback.trigger('impactLight');
//     setIsHoldingMic(true);
//     startListening();
//   };

//   const handleMicPressOut = () => {
//     setIsHoldingMic(false);
//     stopListening();
//     ReactNativeHapticFeedback.trigger('selection');
//   };

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
//           <TouchableOpacity
//             onPressIn={handleMicPressIn}
//             onPressOut={handleMicPressOut}
//             style={styles.iconButton}>
//             <MaterialIcons
//               name={isRecording ? 'mic' : 'mic-none'}
//               size={22}
//               color={
//                 isRecording ? theme.colors.primary : theme.colors.foreground3
//               }
//             />
//           </TouchableOpacity>

//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.tabsButton}
//                 onPress={openTabsView}>
//                 <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
//             <TouchableOpacity
//               onPressIn={handleMicPressIn}
//               onPressOut={handleMicPressOut}>
//               <MaterialIcons
//                 name={isRecording ? 'mic' : 'mic-none'}
//                 size={20}
//                 color={
//                   isRecording ? theme.colors.primary : theme.colors.foreground3
//                 }
//                 style={styles.bookmarksSearchMic}
//               />
//             </TouchableOpacity>
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

///////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';
// // ðŸ”¥ VOICE ADD
// import {useVoiceControl} from '../hooks/useVoiceControl';
// import ReactNativeHapticFeedback from 'react-native-haptic-feedback';
// import {PermissionsAndroid, Platform} from 'react-native';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   // ðŸ”¥ VOICE ADD
//   const {speech, isRecording, startListening, stopListening} =
//     useVoiceControl();
//   const [isHoldingMic, setIsHoldingMic] = useState(false);
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   // ðŸ”¥ VOICE ADD
//   async function prepareAudio() {
//     try {
//       if (Platform.OS === 'android') {
//         const granted = await PermissionsAndroid.request(
//           PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
//         );
//         if (granted !== PermissionsAndroid.RESULTS.GRANTED) return false;
//       } else {
//         const AV = require('react-native').NativeModules.AVAudioSession;
//         if (AV?.setCategory) {
//           await AV.setCategory('PlayAndRecord');
//           await AV.setActive(true);
//         }
//       }
//       return true;
//     } catch {
//       return false;
//     }
//   }

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   // ðŸ”¥ VOICE ADD â€” Update inputValue when speech updates
//   useEffect(() => {
//     if (speech && isHoldingMic === false) {
//       setInputValue(speech);
//     }
//   }, [speech]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   // ðŸ”¥ VOICE ADD
//   const handleMicPressIn = async () => {
//     const ok = await prepareAudio();
//     if (!ok) return;
//     ReactNativeHapticFeedback.trigger('impactLight');
//     setIsHoldingMic(true);
//     startListening();
//   };

//   const handleMicPressOut = () => {
//     setIsHoldingMic(false);
//     stopListening();
//     ReactNativeHapticFeedback.trigger('selection');
//   };

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {/* ðŸ”¥ VOICE ADD â€“ Mic button */}
//           <TouchableOpacity
//             onPressIn={handleMicPressIn}
//             onPressOut={handleMicPressOut}
//             style={styles.iconButton}>
//             <MaterialIcons
//               name={isRecording ? 'mic' : 'mic-none'}
//               size={22}
//               color={
//                 isRecording ? theme.colors.primary : theme.colors.foreground3
//               }
//             />
//           </TouchableOpacity>

//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.tabsButton}
//                 onPress={openTabsView}>
//                 <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             {/* ðŸ”¥ VOICE ADD â€“ functional mic */}
//             <TouchableOpacity
//               onPressIn={handleMicPressIn}
//               onPressOut={handleMicPressOut}>
//               <MaterialIcons
//                 name={isRecording ? 'mic' : 'mic-none'}
//                 size={20}
//                 color={
//                   isRecording ? theme.colors.primary : theme.colors.foreground3
//                 }
//                 style={styles.bookmarksSearchMic}
//               />
//             </TouchableOpacity>
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

///////////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//       marginTop: 60,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}

//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.tabsButton}
//                 onPress={openTabsView}>
//                 <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>

//             {/* Auto-fill Settings */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => {
//                 setShowSaveMenu(false);
//                 setShowAutofillSettings(true);
//               }}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="lock" size={22} color="#10b981" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Auto-fill Settings</Text>
//               <MaterialIcons
//                 name="chevron-right"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

////////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';
// import AutofillSettings from '../components/BrowserSettings/AutofillSettings';
// import {
//   generatePasswordAutofillScript,
//   getDomainFromUrl,
// } from '../utils/autofill';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);
//   const [showAutofillSettings, setShowAutofillSettings] = useState(false);
//   const [historySearchQuery, setHistorySearchQuery] = useState('');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // GOLD #7 & #10: Track sizes and colors clicked on current page
//   const sizesClickedRef = useRef<{size: string; timestamp: number}[]>([]);
//   const colorsClickedRef = useRef<{color: string; timestamp: number}[]>([]);

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//     sizesViewed?: string[];
//     colorsViewed?: string[];
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // Auto-fill: Inject saved password on page load
//   useEffect(() => {
//     if (!currentTab?.url || !webRef.current) return;

//     const {getPasswordForDomain} = useShoppingStore.getState();
//     const domain = getDomainFromUrl(currentTab.url);
//     const savedPassword = getPasswordForDomain(domain);

//     if (savedPassword) {
//       const script = generatePasswordAutofillScript(savedPassword);
//       webRef.current.injectJavaScript(script);
//     }
//   }, [currentTab?.url]);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (
//         previousUrlRef.current &&
//         previousUrlRef.current !== currentTab.url &&
//         pageStartTimeRef.current > 0
//       ) {
//         const dwell = Math.round(
//           (Date.now() - pageStartTimeRef.current) / 1000,
//         );
//         useShoppingStore
//           .getState()
//           .updateHistoryMetadata(previousUrlRef.current, {
//             dwellTime: dwell,
//             scrollDepth: maxScrollDepthRef.current,
//           });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // GOLD #7 & #10: Extract unique sizes and colors clicked
//       const sizesViewed = [
//         ...new Set(sizesClickedRef.current.map(s => s.size)),
//       ];
//       const colorsViewed = [
//         ...new Set(colorsClickedRef.current.map(c => c.color)),
//       ];

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//         sizesViewed,
//         colorsViewed,
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//         sizesViewed, // GOLD #7: Sizes clicked before bookmarking
//         colorsViewed, // GOLD #10: Colors clicked before bookmarking
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');

//         // GOLD: Also record as a checkout_start event if on checkout page
//         const isCheckout = /(checkout|payment|order)/.test(
//           currentTab.url.toLowerCase(),
//         );
//         useShoppingStore.getState().recordCartEvent({
//           type: isCheckout ? 'checkout_start' : 'add',
//           timestamp: Date.now(),
//           cartUrl: currentTab.url,
//         });
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads, and inject size/color click listeners
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     // Reset size/color tracking for new page
//     sizesClickedRef.current = [];
//     colorsClickedRef.current = [];

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     // GOLD #7 & #10: Inject size/color click detection
//     const sizeColorClickScript = `
//       (function() {
//         if (window.__styliqClickListenersAdded) return;
//         window.__styliqClickListenersAdded = true;

//         // Common size selector patterns across shopping sites
//         const sizePatterns = [
//           // Text patterns for sizes
//           /^(XXS|XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL)$/i,
//           /^(\\d{1,2}(\\.\\d)?)(\\s)?(US|UK|EU)?$/i, // 8, 8.5, 10 US, 42 EU
//           /^(\\d{2})([RWLS])?$/i, // 32R, 34L, 28W
//           /^(One Size|OS|OSFA|Free Size)$/i,
//           /^(Small|Medium|Large|Extra Large)$/i,
//         ];

//         // Common color patterns
//         const colorPatterns = [
//           /^(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy|cream|ivory|tan|olive|maroon|teal|coral|gold|silver)$/i,
//           /^(light|dark|bright|pale|deep)?\\s?(black|white|red|blue|green|yellow|orange|purple|pink|gray|grey|brown|beige|navy)$/i,
//         ];

//         const commonColors = ['black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'gray', 'grey', 'brown', 'beige', 'navy', 'cream', 'ivory', 'tan', 'olive', 'maroon', 'teal', 'coral', 'gold', 'silver', 'burgundy', 'charcoal', 'khaki', 'mint', 'rose', 'lavender', 'turquoise'];

//         function isSize(text) {
//           const trimmed = text.trim();
//           if (!trimmed || trimmed.length > 20) return false;
//           return sizePatterns.some(pattern => pattern.test(trimmed));
//         }

//         function isColor(text) {
//           const trimmed = text.trim().toLowerCase();
//           if (!trimmed || trimmed.length > 30) return false;
//           if (commonColors.includes(trimmed)) return true;
//           return colorPatterns.some(pattern => pattern.test(trimmed));
//         }

//         function getColorFromElement(el) {
//           // Check text content
//           const text = el.textContent?.trim() || '';
//           if (isColor(text)) return text;

//           // Check aria-label
//           const ariaLabel = el.getAttribute('aria-label') || '';
//           if (isColor(ariaLabel)) return ariaLabel;

//           // Check title
//           const title = el.getAttribute('title') || '';
//           if (isColor(title)) return title;

//           // Check data attributes
//           const dataColor = el.getAttribute('data-color') || el.getAttribute('data-value') || '';
//           if (isColor(dataColor)) return dataColor;

//           // Check background color (color swatches)
//           const bgColor = window.getComputedStyle(el).backgroundColor;
//           if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
//             // Return a simplified color description
//             return 'color-swatch';
//           }

//           return null;
//         }

//         // Add click listener to document
//         document.addEventListener('click', function(e) {
//           const target = e.target;
//           if (!target) return;

//           // Check clicked element and its parents (up to 3 levels)
//           let el = target;
//           for (let i = 0; i < 3 && el; i++) {
//             const text = el.textContent?.trim() || '';

//             // Check for size click
//             if (isSize(text)) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'sizeClick',
//                 size: text.toUpperCase()
//               }));
//               return;
//             }

//             // Check for color click
//             const color = getColorFromElement(el);
//             if (color) {
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'colorClick',
//                 color: color
//               }));
//               return;
//             }

//             el = el.parentElement;
//           }
//         }, true);
//       })();
//       true;
//     `;

//     // GOLD: Cart detection script - extracts item count and estimated total
//     const cartDetectionScript = `
//       (function() {
//         try {
//           // Look for common cart indicators
//           const pageUrl = window.location.href;
//           const isCartPage = /(cart|bag|checkout)/.test(pageUrl.toLowerCase());

//           if (!isCartPage) return;

//           // Extract item count from common patterns
//           let itemCount = 0;

//           // Pattern 1: "Items in cart: X" or "Cart (X)"
//           const countMatch = document.body.innerText.match(/(?:cart|bag)\\s*\\(?(\\d+)\\)?/i);
//           if (countMatch) itemCount = parseInt(countMatch[1]);

//           // Pattern 2: Look for cart badge/counter elements
//           if (itemCount === 0) {
//             const badges = document.querySelectorAll('[class*="cart"], [class*="badge"], [class*="count"]');
//             for (const badge of badges) {
//               const text = badge.textContent.trim();
//               const match = text.match(/^\\d+$/);
//               if (match) {
//                 itemCount = parseInt(match[0]);
//                 break;
//               }
//             }
//           }

//           // Extract estimated total
//           let estimatedTotal = 0;
//           const totalMatch = document.body.innerText.match(/(?:total|subtotal|cart total)[:\\s]+[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//           if (totalMatch) {
//             const totalStr = totalMatch[1].replace(',', '.');
//             estimatedTotal = parseFloat(totalStr);
//           }

//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'cartDetected',
//             itemCount: itemCount,
//             estimatedTotal: estimatedTotal,
//             cartUrl: pageUrl
//           }));
//         } catch (e) {}
//       })();
//       true;
//     `;

//     // GOLD: Purchase completion detection - detects order confirmation pages
//     const purchaseDetectionScript = `
//       (function() {
//         try {
//           const pageUrl = window.location.href.toLowerCase();
//           const pageText = document.body.innerText.toLowerCase();

//           // Purchase completion indicators
//           const confirmationIndicators = [
//             // URL patterns
//             /order\\s*(confirmation|complete)|(thank\\s*you|purchase\\s*complete|order\\s*placed)/.test(pageUrl),
//             // Text patterns
//             /(order.*confirmation|thank you for your (purchase|order)|order (placed|confirmed)|purchase (complete|successful))/.test(pageText),
//             // Page title
//             /order|confirmation|thank you|purchase complete/.test(document.title.toLowerCase()),
//           ];

//           const isPurchaseConfirmation = confirmationIndicators.some(indicator => indicator);

//           if (isPurchaseConfirmation) {
//             // Extract purchase details if available
//             let orderNumber = '';
//             let totalAmount = 0;

//             // Try to find order number
//             const orderMatch = pageText.match(/(?:order|confirmation)\\s*(?:number|id|#)?[:\\s]+([A-Z0-9-]+)/i);
//             if (orderMatch) orderNumber = orderMatch[1];

//             // Try to find total amount
//             const totalMatch = pageText.match(/(?:total|amount|grand total)[:\\s]*[$Â£â‚¬Â¥]\\s*(\\d+(?:[.,]\\d{2})?)/i);
//             if (totalMatch) {
//               const totalStr = totalMatch[1].replace(',', '.');
//               totalAmount = parseFloat(totalStr);
//             }

//             // Count items (look for common patterns)
//             let itemCount = 0;
//             const itemMatch = pageText.match(/(?:items?|products?)\\s*(?:ordered|purchased)?[:\\s]*([0-9]+)/i);
//             if (itemMatch) itemCount = parseInt(itemMatch[1]);

//             window.ReactNativeWebView.postMessage(JSON.stringify({
//               type: 'purchaseComplete',
//               orderNumber: orderNumber,
//               totalAmount: totalAmount,
//               itemCount: itemCount,
//               purchaseUrl: pageUrl,
//               timestamp: Date.now()
//             }));
//           }
//         } catch (e) {}
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//     webRef.current.injectJavaScript(sizeColorClickScript);
//     webRef.current.injectJavaScript(cartDetectionScript);
//     webRef.current.injectJavaScript(purchaseDetectionScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log(
//           '[MSG] Page text received:',
//           data.length,
//           'chars, extracted:',
//           data.extracted,
//         );
//       } else if (data.type === 'sizeClick') {
//         // GOLD #7: Track size clicks with timestamp
//         const sizeEntry = {size: data.size, timestamp: Date.now()};
//         sizesClickedRef.current = [...sizesClickedRef.current, sizeEntry];
//         console.log(
//           '[MSG] Size clicked:',
//           data.size,
//           'Total:',
//           sizesClickedRef.current.length,
//         );
//       } else if (data.type === 'colorClick') {
//         // GOLD #10: Track color clicks with timestamp
//         const colorEntry = {color: data.color, timestamp: Date.now()};
//         colorsClickedRef.current = [...colorsClickedRef.current, colorEntry];
//         console.log(
//           '[MSG] Color clicked:',
//           data.color,
//           'Total:',
//           colorsClickedRef.current.length,
//         );
//       } else if (data.type === 'cartDetected') {
//         // GOLD: Cart detection with item count and total
//         console.log('[MSG] Cart detected:', {
//           itemCount: data.itemCount,
//           estimatedTotal: data.estimatedTotal,
//         });
//         // Record cart view event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'cart_view',
//           timestamp: Date.now(),
//           cartUrl: data.cartUrl,
//           itemCount: data.itemCount,
//           cartValue: data.estimatedTotal,
//         });
//       } else if (data.type === 'purchaseComplete') {
//         // GOLD: Purchase completion detected on order confirmation page
//         console.log('[MSG] Purchase complete detected:', {
//           orderNumber: data.orderNumber,
//           totalAmount: data.totalAmount,
//           itemCount: data.itemCount,
//         });
//         // Record purchase completion event
//         useShoppingStore.getState().recordCartEvent({
//           type: 'checkout_complete',
//           timestamp: data.timestamp || Date.now(),
//           cartUrl: data.purchaseUrl,
//           itemCount: data.itemCount,
//           cartValue: data.totalAmount,
//         });
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const {contentOffset, contentSize, layoutMeasurement} = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100),
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={() => setShowAutofillSettings(true)}>
//                 <MaterialIcons
//                   name="settings"
//                   size={24}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//               <TouchableOpacity
//                 style={styles.iconButton}
//                 onPress={handleSaveMenuOpen}>
//                 <MaterialIcons
//                   name="add-circle-outline"
//                   size={32}
//                   color={theme.colors.foreground2}
//                 />
//               </TouchableOpacity>
//             </>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity
//               onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“ Sizes:{' '}
//             {debugInfo.sizesViewed?.length
//               ? debugInfo.sizesViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸŽ¨ Colors:{' '}
//             {debugInfo.colorsViewed?.length
//               ? debugInfo.colorsViewed.join(', ')
//               : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text:{' '}
//             {debugInfo.pageTextLength
//               ? `${debugInfo.pageTextLength} chars`
//               : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>
//                     Page Text Preview:
//                   </Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>

//       {/* Auto-fill Settings Modal */}
//       <AutofillSettings
//         visible={showAutofillSettings}
//         onClose={() => setShowAutofillSettings(false)}
//       />
//     </View>
//   );
// }

////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);
//   const maxScrollDepthRef = useRef<number>(0);
//   const previousUrlRef = useRef<string>('');
//   const lastPageTextRef = useRef<string>('');

//   // Debug info display
//   const [debugInfo, setDebugInfo] = useState<{
//     price?: number;
//     brand?: string;
//     category?: string;
//     pageTextLength?: number;
//     pageTextPreview?: string;
//     inputText?: string;
//     timestamp?: number;
//   } | null>(null);
//   const [showDebugDetail, setShowDebugDetail] = useState(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // GOLD #1, #9: Track dwell time and scroll depth when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       // If we had a previous page, save its metrics before moving to new page
//       if (previousUrlRef.current && previousUrlRef.current !== currentTab.url && pageStartTimeRef.current > 0) {
//         const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//         useShoppingStore.getState().updateHistoryMetadata(previousUrlRef.current, {
//           dwellTime: dwell,
//           scrollDepth: maxScrollDepthRef.current,
//         });
//       }

//       // Now start tracking the new page
//       pageStartTimeRef.current = Date.now();
//       maxScrollDepthRef.current = 0; // Reset scroll depth for new page
//       previousUrlRef.current = currentTab.url; // Store for next page transition
//       const source = getDomain(currentTab.url);
//       useShoppingStore
//         .getState()
//         .addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }

//       // Try to extract page text right now via JavaScript injection
//       // This provides fresh data at bookmark time
//       if (webRef.current) {
//         const extractScript = `
//           (function() {
//             try {
//               const text = document.body.innerText.substring(0, 5000);
//               window.ReactNativeWebView.postMessage(JSON.stringify({
//                 type: 'pageText',
//                 content: text,
//                 length: text.length,
//                 extracted: true
//               }));
//             } catch (e) {}
//           })();
//           true;
//         `;
//         webRef.current.injectJavaScript(extractScript);
//         // Small delay to let the message come through
//         await new Promise(resolve => setTimeout(resolve, 100));
//       }

//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(
//         currentTab.title || '',
//         currentTab.url,
//       );
//       const brand = shoppingAnalytics.extractBrand(
//         currentTab.title || '',
//         currentTab.url,
//       );

//       // Extract price from title + URL + any cached page text
//       let price = shoppingAnalytics.extractPrice(
//         `${currentTab.title || ''} ${currentTab.url}`,
//       );

//       // If not found, try the page text we captured
//       if (!price && lastPageTextRef.current) {
//         price = shoppingAnalytics.extractPrice(lastPageTextRef.current);
//       }

//       // DEBUG: Show what was extracted
//       const inputText = `${currentTab.title || ''} ${currentTab.url}`;
//       setDebugInfo({
//         price,
//         brand,
//         category,
//         pageTextLength: lastPageTextRef.current?.length || 0,
//         pageTextPreview: lastPageTextRef.current?.substring(0, 200) || '',
//         inputText,
//         timestamp: Date.now(),
//       });

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         brand, // GOLD #2b: Brand extracted from title/URL
//         price, // GOLD #4: Initial price
//         priceHistory: price ? [{price, date: Date.now()}] : [], // GOLD #4: Price history
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore
//           .getState()
//           .recordProductInteraction(currentTab.url, 'add_to_cart');
//       }

//       // Record bookmark interaction
//       useShoppingStore
//         .getState()
//         .recordProductInteraction(currentTab.url, 'bookmark');

//       // GOLD #1, #9: Update history with dwell time and scroll depth
//       useShoppingStore.getState().updateHistoryMetadata(currentTab.url, {
//         dwellTime: dwell,
//         scrollDepth: maxScrollDepthRef.current,
//         isCartPage: shoppingAnalytics.isCartUrl(currentTab.url),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   // Extract and cache page text when page loads
//   const handleWebViewLoadEnd = useCallback(() => {
//     if (!webRef.current) return;

//     const extractPageTextScript = `
//       (function() {
//         try {
//           const text = document.body.innerText.substring(0, 5000);
//           const data = {
//             type: 'pageText',
//             content: text,
//             length: text.length,
//             extracted: true
//           };
//           window.ReactNativeWebView.postMessage(JSON.stringify(data));
//         } catch (err) {
//           window.ReactNativeWebView.postMessage(JSON.stringify({
//             type: 'pageText',
//             content: '',
//             error: err.message,
//             extracted: false
//           }));
//         }
//       })();
//       true;
//     `;

//     webRef.current.injectJavaScript(extractPageTextScript);
//   }, []);

//   // Handle messages from WebView
//   const handleWebViewMessage = useCallback((event: any) => {
//     try {
//       const data = JSON.parse(event.nativeEvent.data);
//       if (data.type === 'pageText') {
//         lastPageTextRef.current = data.content || '';
//         console.log('[MSG] Page text received:', data.length, 'chars, extracted:', data.extracted);
//       }
//     } catch (e) {
//       console.log('[MSG] Error parsing message:', e);
//     }
//   }, []);

//   // GOLD #9: Track scroll depth in WebView
//   const handleWebViewScroll = useCallback((event: any) => {
//     try {
//       const { contentOffset, contentSize, layoutMeasurement } = event.nativeEvent;
//       if (contentSize.height > 0) {
//         const scrollPosition = contentOffset.y;
//         const viewportHeight = layoutMeasurement.height;
//         const contentHeight = contentSize.height;
//         // Calculate scroll depth as percentage (0-100)
//         const scrollDepth = Math.min(
//           100,
//           Math.round(((scrollPosition + viewportHeight) / contentHeight) * 100)
//         );
//         // Update max scroll depth reached
//         if (scrollDepth > maxScrollDepthRef.current) {
//           maxScrollDepthRef.current = scrollDepth;
//         }
//       }
//     } catch (e) {
//       // Silently fail if scroll metrics unavailable
//     }
//   }, []);

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//     // DEBUG: Price Extraction Panel
//     debugPanel: {
//       position: 'absolute',
//       bottom: insets.bottom + 80,
//       left: 16,
//       right: 16,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//       borderWidth: 2,
//       borderColor: theme.colors.primary,
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 2},
//       shadowOpacity: 0.3,
//       shadowRadius: 8,
//       elevation: 5,
//       zIndex: 1000,
//     },
//     debugTitle: {
//       fontSize: 13,
//       fontWeight: '700',
//       color: theme.colors.primary,
//       marginBottom: 8,
//     },
//     debugText: {
//       fontSize: 12,
//       color: theme.colors.foreground2,
//       marginBottom: 4,
//       fontFamily: 'Menlo',
//     },
//     debugDismiss: {
//       fontSize: 12,
//       color: theme.colors.primary,
//       marginTop: 8,
//       fontWeight: '600',
//       textAlign: 'center',
//     },
//     debugHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     debugToggle: {
//       fontSize: 14,
//       color: theme.colors.primary,
//       fontWeight: '600',
//     },
//     debugDetail: {
//       marginTop: 8,
//       paddingTop: 8,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     debugDetailTitle: {
//       fontSize: 11,
//       fontWeight: '600',
//       color: theme.colors.primary,
//       marginTop: 6,
//       marginBottom: 2,
//     },
//     debugDetailText: {
//       fontSize: 10,
//       color: theme.colors.foreground3,
//       fontFamily: 'Menlo',
//       lineHeight: 14,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             onScroll={handleWebViewScroll}
//             onLoadEnd={handleWebViewLoadEnd}
//             onMessage={handleWebViewMessage}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* DEBUG: Price Extraction Display */}
//       {debugInfo && (
//         <View style={styles.debugPanel}>
//           <View style={styles.debugHeader}>
//             <Text style={styles.debugTitle}>Last Extraction:</Text>
//             <TouchableOpacity onPress={() => setShowDebugDetail(!showDebugDetail)}>
//               <Text style={styles.debugToggle}>
//                 {showDebugDetail ? 'â–¼' : 'â–¶'}
//               </Text>
//             </TouchableOpacity>
//           </View>

//           <Text style={styles.debugText}>
//             ðŸ’° Price: {debugInfo.price ? `$${debugInfo.price}` : 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ·ï¸ Brand: {debugInfo.brand || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ‘• Category: {debugInfo.category || 'â€”'}
//           </Text>
//           <Text style={styles.debugText}>
//             ðŸ“„ Page text: {debugInfo.pageTextLength ? `${debugInfo.pageTextLength} chars` : '0 chars'}
//           </Text>

//           {showDebugDetail && (
//             <View style={styles.debugDetail}>
//               <Text style={styles.debugDetailTitle}>Input (Title + URL):</Text>
//               <Text style={styles.debugDetailText} numberOfLines={3}>
//                 {debugInfo.inputText?.substring(0, 150) || '(empty)'}
//               </Text>

//               {debugInfo.pageTextPreview && (
//                 <>
//                   <Text style={styles.debugDetailTitle}>Page Text Preview:</Text>
//                   <Text style={styles.debugDetailText} numberOfLines={4}>
//                     {debugInfo.pageTextPreview}
//                   </Text>
//                 </>
//               )}
//             </View>
//           )}

//           <TouchableOpacity onPress={() => setDebugInfo(null)}>
//             <Text style={styles.debugDismiss}>âœ• Dismiss</Text>
//           </TouchableOpacity>
//         </View>
//       )}

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

//////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {shoppingAnalytics} from '../../../../store/shoppingAnalytics';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // GOLD: Tracking refs
//   const pageStartTimeRef = useRef<number>(0);
//   const sessionStartedRef = useRef<boolean>(false);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   // GOLD #1, #3: Start session on first load (don't end it on unmount)
//   useEffect(() => {
//     if (!sessionStartedRef.current) {
//       const currentSession = useShoppingStore.getState().currentSessionId;
//       if (!currentSession) {
//         useShoppingStore.getState().startSession();
//       }
//       sessionStartedRef.current = true;
//     }
//   }, []);

//   // GOLD #1: Track dwell time when page loads
//   useEffect(() => {
//     if (currentTab?.url) {
//       pageStartTimeRef.current = Date.now();
//       const source = getDomain(currentTab.url);
//       useShoppingStore.getState().addToHistory(currentTab.title || 'New Tab', currentTab.url, source);

//       // Record as a product view interaction
//       useShoppingStore.getState().recordProductInteraction(currentTab.url, 'view');
//     }
//   }, [currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }
//       // GOLD: Enrich bookmark with gold data
//       const bookmarkId = Date.now().toString();
//       const dwell = Math.round((Date.now() - pageStartTimeRef.current) / 1000);
//       const category = shoppingAnalytics.extractCategory(currentTab.title || '', currentTab.url);

//       addBookmark({
//         id: bookmarkId,
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//         viewCount: 1,
//         category, // GOLD #2
//         priceHistory: [], // GOLD #4 (will be updated if price detected)
//       });

//       // Track as add-to-cart interaction if it's a cart page
//       if (shoppingAnalytics.isCartUrl(currentTab.url)) {
//         useShoppingStore.getState().recordProductInteraction(currentTab.url, 'add_to_cart');
//       }

//       // Record bookmark interaction
//       useShoppingStore.getState().recordProductInteraction(currentTab.url, 'bookmark');
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

//////////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';
// import ShoppingAssistant from '../components/ShoppingAssistant';
// import {useUUID} from '../context/UUIDContext';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const userId = useUUID();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab && currentTab.url !== inputValue) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Shopping Assistant */}
//       {!showTabsView && (
//         <ShoppingAssistant
//           onSuggestionPress={url => {
//             if (currentTab) {
//               updateTab(currentTab.id, url, currentTab.title);
//             } else {
//               addTab(url, 'New Tab');
//             }
//           }}
//           isVisible={!showTabsView}
//           userId={userId}
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

/////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');
//   const [showAutocomplete, setShowAutocomplete] = useState(false);
//   const [isInputFocused, setIsInputFocused] = useState(false);

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<
//     {x: number; y: number; width: number; height: number}[]
//   >([]);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (
//         !normalized.startsWith('http://') &&
//         !normalized.startsWith('https://') &&
//         !normalized.includes('.')
//       ) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   // Autocomplete suggestions from history
//   const autocompleteSuggestions = React.useMemo(() => {
//     if (!isInputFocused || inputValue.length < 1) return [];
//     const searchTerm = inputValue.toLowerCase();
//     return history
//       .filter(
//         item =>
//           item.url.toLowerCase().includes(searchTerm) ||
//           item.title.toLowerCase().includes(searchTerm),
//       )
//       .sort((a, b) => b.visitCount - a.visitCount)
//       .slice(0, 5);
//   }, [history, inputValue, isInputFocused]);

//   const handleAutocompleteSelect = (url: string) => {
//     setInputValue(url);
//     setShowAutocomplete(false);
//     if (currentTab) {
//       updateTab(currentTab.id, url, currentTab.title);
//     } else {
//       addTab(url, 'New Tab');
//     }
//     Keyboard.dismiss();
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (
//     index: number,
//     gestureState: {dx: number; dy: number},
//   ) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (
//       draggingIndex !== null &&
//       draggedOverIndex !== null &&
//       draggingIndex !== draggedOverIndex
//     ) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     autocompleteContainer: {
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginTop: 8,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       overflow: 'hidden',
//     },
//     autocompleteItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 12,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     autocompleteIcon: {
//       marginRight: 10,
//     },
//     autocompleteTextContainer: {
//       flex: 1,
//     },
//     autocompleteTitle: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 2,
//     },
//     autocompleteUrl: {
//       fontSize: 12,
//       color: theme.colors.foreground3,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//       marginTop: 60,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 4,
//       paddingHorizontal: 16,
//       paddingBottom: 6,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 4,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={text => {
//               setInputValue(text);
//               setShowAutocomplete(text.length > 0);
//             }}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => {
//               triggerHaptic('impactLight');
//               setIsInputFocused(true);
//               setShowAutocomplete(inputValue.length > 0);
//             }}
//             onBlur={() => {
//               setTimeout(() => {
//                 setIsInputFocused(false);
//                 setShowAutocomplete(false);
//               }, 150);
//             }}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//         {showAutocomplete && autocompleteSuggestions.length > 0 && (
//           <View style={styles.autocompleteContainer}>
//             {autocompleteSuggestions.map((item, index) => (
//               <TouchableOpacity
//                 key={`${item.url}-${index}`}
//                 style={styles.autocompleteItem}
//                 onPress={() => handleAutocompleteSelect(item.url)}>
//                 <MaterialIcons
//                   name="history"
//                   size={18}
//                   color={theme.colors.foreground3}
//                   style={styles.autocompleteIcon}
//                 />
//                 <View style={styles.autocompleteTextContainer}>
//                   <Text
//                     style={styles.autocompleteTitle}
//                     numberOfLines={1}
//                     ellipsizeMode="tail">
//                     {item.title || getDomain(item.url)}
//                   </Text>
//                   <Text
//                     style={styles.autocompleteUrl}
//                     numberOfLines={1}
//                     ellipsizeMode="middle">
//                     {item.url}
//                   </Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//           </View>
//         )}
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <TouchableOpacity
//           activeOpacity={1}
//           onPress={closeTabsView}
//           style={styles.tabsOverlay}>
//           <Animated.View
//             style={[
//               {flex: 1},
//               {
//                 opacity: tabsViewScale,
//                 transform: [
//                   {
//                     scale: tabsViewScale.interpolate({
//                       inputRange: [0, 1],
//                       outputRange: [0.9, 1],
//                     }),
//                   },
//                 ],
//               },
//             ]}>
//             <TouchableOpacity
//               activeOpacity={1}
//               onPress={e => e.stopPropagation()}>
//               <View style={styles.tabsHeader}>
//                 {/* <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={handleNewTab}>
//                   <Text style={styles.tabsHeaderButtonText}>+</Text>
//                 </TouchableOpacity> */}
//                 <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//                 <TouchableOpacity
//                   style={styles.tabsHeaderButton}
//                   onPress={closeTabsView}>
//                   <Text style={styles.tabsHeaderButtonText}>Done</Text>
//                 </TouchableOpacity>
//               </View>
//             </TouchableOpacity>

//             <ScrollView
//               contentContainerStyle={styles.tabsGrid}
//               scrollEnabled={draggingIndex === null}>
//               {tabs.map((tab, index) => {
//                 const isDragging = draggingIndex === index;
//                 const isDropTarget =
//                   draggedOverIndex === index && draggingIndex !== index;
//                 const panResponder = createPanResponder(index);

//                 return (
//                   <Animated.View
//                     key={tab.id}
//                     onLayout={e => handleTabLayout(index, e)}
//                     style={[
//                       isDragging && {
//                         transform: [
//                           {translateX: dragAnimatedValue.x},
//                           {translateY: dragAnimatedValue.y},
//                           {scale: dragScale},
//                         ],
//                         zIndex: 1000,
//                         elevation: 10,
//                       },
//                       isDropTarget && {
//                         opacity: 0.5,
//                       },
//                     ]}
//                     {...panResponder.panHandlers}>
//                     <TouchableOpacity
//                       style={[
//                         styles.tabCard,
//                         tab.id === currentTabId && styles.tabCardActive,
//                         isDragging && styles.tabCardDragging,
//                       ]}
//                       onPress={() => handleSelectTab(tab.id)}
//                       onLongPress={() => handleLongPress(index)}
//                       delayLongPress={300}
//                       activeOpacity={0.8}>
//                       {/* Tab Preview Background */}
//                       <View style={styles.tabCardPreviewContainer}>
//                         {tab.screenshot ? (
//                           <Image
//                             source={{uri: tab.screenshot}}
//                             style={styles.tabCardScreenshot}
//                             resizeMode="cover"
//                           />
//                         ) : (
//                           <>
//                             {/* Gradient/colored background when no screenshot */}
//                             <View
//                               style={[
//                                 styles.tabCardPlaceholder,
//                                 {backgroundColor: theme.colors.surface},
//                               ]}
//                             />
//                             <Image
//                               source={{
//                                 uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                   tab.url,
//                                 )}.ico`,
//                               }}
//                               style={styles.tabCardFavicon}
//                               defaultSource={require('../assets/images/desktop-2.jpg')}
//                             />
//                           </>
//                         )}
//                       </View>

//                       {/* Overlay with text content */}
//                       <View style={styles.tabCardOverlay}>
//                         <View style={styles.tabCardHeader}>
//                           <Text style={styles.tabCardTitle} numberOfLines={2}>
//                             {tab.title || getDomain(tab.url)}
//                           </Text>
//                           <TouchableOpacity
//                             style={styles.tabCardClose}
//                             onPress={() => handleCloseTab(tab.id)}
//                             hitSlop={{
//                               top: 10,
//                               bottom: 10,
//                               left: 10,
//                               right: 10,
//                             }}>
//                             <MaterialIcons
//                               name="close"
//                               size={16}
//                               color="#fff"
//                             />
//                           </TouchableOpacity>
//                         </View>
//                         <View style={styles.tabCardContent}>
//                           <Text style={styles.tabCardDomain}>
//                             {getDomain(tab.url)}
//                           </Text>
//                         </View>
//                       </View>
//                     </TouchableOpacity>
//                   </Animated.View>
//                 );
//               })}
//               <TouchableOpacity
//                 style={styles.newTabCard}
//                 onPress={handleNewTab}>
//                 <MaterialIcons
//                   name="add"
//                   size={2}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.newTabText}>New Tab</Text>
//               </TouchableOpacity>
//             </ScrollView>
//           </Animated.View>
//         </TouchableOpacity>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

////////////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
//   PanResponder,
//   LayoutChangeEvent,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     reorderTabs,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     addSearch,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');

//   // Drag and drop state for tabs
//   const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
//   const [draggedOverIndex, setDraggedOverIndex] = useState<number | null>(null);
//   const dragAnimatedValue = useRef(new Animated.ValueXY()).current;
//   const dragScale = useRef(new Animated.Value(1)).current;
//   const tabPositions = useRef<{x: number; y: number; width: number; height: number}[]>([]);

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl) {
//       // Check if this URL is already open in a tab
//       const existingTab = tabs.find(t => t.url === initialUrl);
//       if (existingTab) {
//         // Switch to existing tab
//         switchTab(existingTab.id);
//       } else {
//         // Add new tab with the URL
//         addTab(initialUrl, 'New Tab');
//       }
//     }
//   }, [_hasHydrated, initialUrl]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     // Check if it looks like a domain (has a dot and looks like a valid domain pattern)
//     // Valid domain patterns: example.com, sub.example.com, example.co.uk, etc.
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       // Check if it has a valid TLD or domain structure
//       const parts = normalized.split('.');
//       const lastPart = parts[parts.length - 1];
//       // Check if the last part (potential TLD) is at least 2 characters and is alphabetic
//       if (lastPart.length >= 2 && /^[a-zA-Z]+$/.test(lastPart)) {
//         // Looks like a valid domain
//         return `https://${normalized}`;
//       }
//     }
//     // Treat as search query
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const normalized = inputValue.trim();
//       const newUrl = normalizeUrl(normalized);

//       // Track search if user typed a search query (not a full URL)
//       if (!normalized.startsWith('http://') && !normalized.startsWith('https://') && !normalized.includes('.')) {
//         // This is a plain search query
//         addSearch(normalized);
//       } else if (newUrl.includes('google.com/search?q=')) {
//         // User typed a domain-like query that got converted to Google search
//         try {
//           const query = new URLSearchParams(new URL(newUrl).search).get('q');
//           if (query) {
//             addSearch(query);
//           }
//         } catch (e) {
//           // URL parsing failed, skip search tracking
//         }
//       }

//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = async () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       // Capture screenshot for the bookmark preview
//       let screenshot: string | undefined;
//       if (containerRef.current) {
//         try {
//           screenshot = await captureRef(containerRef, {
//             format: 'jpg',
//             quality: 0.7,
//             result: 'data-uri',
//           });
//         } catch (e) {
//           console.log('Failed to capture bookmark screenshot:', e);
//         }
//       }
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         screenshot,
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = async (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     // Capture screenshot for the collection item preview
//     let screenshot: string | undefined;
//     if (containerRef.current) {
//       try {
//         screenshot = await captureRef(containerRef, {
//           format: 'jpg',
//           quality: 0.7,
//           result: 'data-uri',
//         });
//       } catch (e) {
//         console.log('Failed to capture collection item screenshot:', e);
//       }
//     }
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       screenshot,
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     if (draggingIndex !== null) return; // Don't select while dragging
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   // Drag and drop handlers for tab reordering
//   const handleLongPress = (index: number) => {
//     triggerHaptic('impactHeavy');
//     setDraggingIndex(index);
//     // Scale up the dragged item
//     Animated.spring(dragScale, {
//       toValue: 1.05,
//       useNativeDriver: true,
//     }).start();
//   };

//   const handleDragMove = (index: number, gestureState: {dx: number; dy: number}) => {
//     if (draggingIndex === null) return;

//     dragAnimatedValue.setValue({
//       x: gestureState.dx,
//       y: gestureState.dy,
//     });

//     // Calculate which tab we're hovering over
//     const currentPos = tabPositions.current[draggingIndex];
//     if (!currentPos) return;

//     const newX = currentPos.x + gestureState.dx;
//     const newY = currentPos.y + gestureState.dy;

//     // Find the target index based on position
//     let targetIndex = draggingIndex;
//     for (let i = 0; i < tabPositions.current.length; i++) {
//       const pos = tabPositions.current[i];
//       if (
//         newX >= pos.x - pos.width / 2 &&
//         newX <= pos.x + pos.width * 1.5 &&
//         newY >= pos.y - pos.height / 2 &&
//         newY <= pos.y + pos.height * 1.5
//       ) {
//         targetIndex = i;
//         break;
//       }
//     }

//     if (targetIndex !== draggedOverIndex) {
//       setDraggedOverIndex(targetIndex);
//       if (targetIndex !== draggingIndex) {
//         triggerHaptic('impactLight');
//       }
//     }
//   };

//   const handleDragEnd = () => {
//     if (draggingIndex !== null && draggedOverIndex !== null && draggingIndex !== draggedOverIndex) {
//       reorderTabs(draggingIndex, draggedOverIndex);
//       triggerHaptic('impactMedium');
//     }

//     // Reset animations
//     Animated.parallel([
//       Animated.spring(dragScale, {
//         toValue: 1,
//         useNativeDriver: true,
//       }),
//       Animated.spring(dragAnimatedValue, {
//         toValue: {x: 0, y: 0},
//         useNativeDriver: true,
//       }),
//     ]).start();

//     setDraggingIndex(null);
//     setDraggedOverIndex(null);
//   };

//   const createPanResponder = (index: number) => {
//     return PanResponder.create({
//       onStartShouldSetPanResponder: () => false,
//       onMoveShouldSetPanResponder: () => draggingIndex === index,
//       onPanResponderMove: (_, gestureState) => {
//         handleDragMove(index, gestureState);
//       },
//       onPanResponderRelease: () => {
//         handleDragEnd();
//       },
//       onPanResponderTerminate: () => {
//         handleDragEnd();
//       },
//     });
//   };

//   const handleTabLayout = (index: number, event: LayoutChangeEvent) => {
//     const {x, y, width, height} = event.nativeEvent.layout;
//     tabPositions.current[index] = {x, y, width, height};
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 12,
//       paddingHorizontal: 16,
//       paddingBottom: 12,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 8,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardDragging: {
//       shadowColor: '#000',
//       shadowOffset: {width: 0, height: 8},
//       shadowOpacity: 0.4,
//       shadowRadius: 12,
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       marginTop: insets.top,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={setInputValue}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => triggerHaptic('impactLight')}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="ascii-capable"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <Animated.View
//           style={[
//             styles.tabsOverlay,
//             {
//               opacity: tabsViewScale,
//               transform: [
//                 {
//                   scale: tabsViewScale.interpolate({
//                     inputRange: [0, 1],
//                     outputRange: [0.9, 1],
//                   }),
//                 },
//               ],
//             },
//           ]}>
//           <View style={styles.tabsHeader}>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={handleNewTab}>
//               <Text style={styles.tabsHeaderButtonText}>+</Text>
//             </TouchableOpacity>
//             <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={closeTabsView}>
//               <Text style={styles.tabsHeaderButtonText}>Done</Text>
//             </TouchableOpacity>
//           </View>

//           <ScrollView contentContainerStyle={styles.tabsGrid} scrollEnabled={draggingIndex === null}>
//             {tabs.map((tab, index) => {
//               const isDragging = draggingIndex === index;
//               const isDropTarget = draggedOverIndex === index && draggingIndex !== index;
//               const panResponder = createPanResponder(index);

//               return (
//                 <Animated.View
//                   key={tab.id}
//                   onLayout={(e) => handleTabLayout(index, e)}
//                   style={[
//                     isDragging && {
//                       transform: [
//                         {translateX: dragAnimatedValue.x},
//                         {translateY: dragAnimatedValue.y},
//                         {scale: dragScale},
//                       ],
//                       zIndex: 1000,
//                       elevation: 10,
//                     },
//                     isDropTarget && {
//                       opacity: 0.5,
//                     },
//                   ]}
//                   {...panResponder.panHandlers}>
//                   <TouchableOpacity
//                     style={[
//                       styles.tabCard,
//                       tab.id === currentTabId && styles.tabCardActive,
//                       isDragging && styles.tabCardDragging,
//                     ]}
//                     onPress={() => handleSelectTab(tab.id)}
//                     onLongPress={() => handleLongPress(index)}
//                     delayLongPress={300}
//                     activeOpacity={0.8}>
//                     {/* Tab Preview Background */}
//                     <View style={styles.tabCardPreviewContainer}>
//                       {tab.screenshot ? (
//                         <Image
//                           source={{uri: tab.screenshot}}
//                           style={styles.tabCardScreenshot}
//                           resizeMode="cover"
//                         />
//                       ) : (
//                         <>
//                           {/* Gradient/colored background when no screenshot */}
//                           <View
//                             style={[
//                               styles.tabCardPlaceholder,
//                               {backgroundColor: theme.colors.surface},
//                             ]}
//                           />
//                           <Image
//                             source={{
//                               uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                                 tab.url,
//                               )}.ico`,
//                             }}
//                             style={styles.tabCardFavicon}
//                             defaultSource={require('../assets/images/desktop-2.jpg')}
//                           />
//                         </>
//                       )}
//                     </View>

//                     {/* Overlay with text content */}
//                     <View style={styles.tabCardOverlay}>
//                       <View style={styles.tabCardHeader}>
//                         <Text style={styles.tabCardTitle} numberOfLines={2}>
//                           {tab.title || getDomain(tab.url)}
//                         </Text>
//                         <TouchableOpacity
//                           style={styles.tabCardClose}
//                           onPress={() => handleCloseTab(tab.id)}
//                           hitSlop={{top: 10, bottom: 10, left: 10, right: 10}}>
//                           <MaterialIcons name="close" size={16} color="#fff" />
//                         </TouchableOpacity>
//                       </View>
//                       <View style={styles.tabCardContent}>
//                         <Text style={styles.tabCardDomain}>
//                           {getDomain(tab.url)}
//                         </Text>
//                       </View>
//                     </View>
//                   </TouchableOpacity>
//                 </Animated.View>
//               );
//             })}
//             <TouchableOpacity style={styles.newTabCard} onPress={handleNewTab}>
//               <MaterialIcons
//                 name="add"
//                 size={2}
//                 color={theme.colors.foreground3}
//               />
//               <Text style={styles.newTabText}>New Tab</Text>
//             </TouchableOpacity>
//           </ScrollView>
//         </Animated.View>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

///////////////

// import React, {useRef, useState, useEffect, useCallback} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
//   Image,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {captureRef} from 'react-native-view-shot';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const containerRef = useRef<View>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     updateTabScreenshot,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//     history,
//     addToHistory,
//     _hasHydrated,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);
//   const [activeBookmarksTab, setActiveBookmarksTab] = useState<
//     'bookmarks' | 'history'
//   >('bookmarks');

//   // Initialize with a tab if navigating with URL (wait for hydration)
//   useEffect(() => {
//     if (_hasHydrated && initialUrl && tabs.length === 0) {
//       addTab(initialUrl, 'New Tab');
//     }
//   }, [_hasHydrated, initialUrl, tabs.length]);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const extractImageFromPage = (url: string): string => {
//     // Use DuckDuckGo favicon service (more reliable)
//     try {
//       const domain = new URL(url).hostname;
//       // DuckDuckGo favicon service
//       return `https://icons.duckduckgo.com/ip3/${domain}.ico`;
//     } catch {
//       return '';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       return `https://${normalized}`;
//     }
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const newUrl = normalizeUrl(inputValue);
//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         imageUrl: extractImageFromPage(currentTab.url),
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       imageUrl: extractImageFromPage(currentTab.url),
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${
//           currentTab.url
//         }`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const captureCurrentTabScreenshot = useCallback(async () => {
//     if (!containerRef.current || !currentTab || !currentTab.url) {
//       console.log('Screenshot skipped - no containerRef or currentTab');
//       return;
//     }
//     try {
//       console.log('Capturing screenshot for tab:', currentTab.id);
//       const uri = await captureRef(containerRef, {
//         format: 'jpg',
//         quality: 0.7,
//         result: 'data-uri',
//       });
//       console.log('Screenshot captured, length:', uri?.length);
//       if (uri) {
//         updateTabScreenshot(currentTab.id, uri);
//         console.log('Screenshot saved to tab');
//       }
//     } catch (error) {
//       console.log('Screenshot capture error:', error);
//     }
//   }, [currentTab, updateTabScreenshot]);

//   const openTabsView = async () => {
//     triggerHaptic('impactLight');
//     // Capture screenshot of current tab before showing tabs view
//     await captureCurrentTabScreenshot();
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 12,
//       paddingHorizontal: 16,
//       paddingBottom: 12,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 8,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: 'transparent',
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: '#fff',
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: 'transparent',
//       justifyContent: 'flex-end',
//       alignItems: 'center',
//       paddingBottom: 8,
//     },
//     tabCardDomain: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: 'rgba(255, 255, 255, 0.9)',
//       marginTop: 0,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       marginTop: insets.top,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Tab Card Preview Image
//     tabCardPreview: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPreviewContainer: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       width: '100%',
//       height: '100%',
//       justifyContent: 'center',
//       alignItems: 'center',
//       overflow: 'hidden',
//     },
//     tabCardScreenshot: {
//       width: '100%',
//       height: '100%',
//       resizeMode: 'cover',
//     },
//     tabCardPlaceholder: {
//       position: 'absolute',
//       width: '100%',
//       height: '100%',
//       top: 0,
//       left: 0,
//     },
//     tabCardFavicon: {
//       width: 64,
//       height: 64,
//       borderRadius: 8,
//     },
//     tabCardOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: 'rgba(0, 0, 0, 0.4)',
//       justifyContent: 'space-between',
//       padding: 0,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={setInputValue}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => triggerHaptic('impactLight')}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="url"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <View ref={containerRef} style={{flex: 1}} collapsable={false}>
//           <WebView
//             ref={webRef}
//             source={{uri: currentTab?.url || ''}}
//             style={{flex: 1}}
//             originWhitelist={['*']}
//             javaScriptEnabled
//             domStorageEnabled
//             // ðŸ‘‡ Inertia / momentum scrolling
//             decelerationRate="normal" // gives Safari-style glide
//             bounces={true} // iOS bounce effect
//             scrollEnabled={true} // ensure scroll isn't locked
//             showsVerticalScrollIndicator={false}
//             showsHorizontalScrollIndicator={false}
//             overScrollMode="never" // keeps Android smooth too
//             androidLayerType="hardware" // helps performance
//             onNavigationStateChange={navState => {
//               if (currentTab && navState.url) {
//                 updateTab(
//                   currentTab.id,
//                   navState.url,
//                   navState.title || currentTab.title,
//                 );
//                 setInputValue(navState.url);
//                 // Track visit history
//                 addToHistory(
//                   navState.url,
//                   navState.title || getDomain(navState.url),
//                   getDomain(navState.url),
//                 );
//               }
//             }}
//             userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//           />
//         </View>
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <Animated.View
//           style={[
//             styles.tabsOverlay,
//             {
//               opacity: tabsViewScale,
//               transform: [
//                 {
//                   scale: tabsViewScale.interpolate({
//                     inputRange: [0, 1],
//                     outputRange: [0.9, 1],
//                   }),
//                 },
//               ],
//             },
//           ]}>
//           <View style={styles.tabsHeader}>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={handleNewTab}>
//               <Text style={styles.tabsHeaderButtonText}>+</Text>
//             </TouchableOpacity>
//             <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={closeTabsView}>
//               <Text style={styles.tabsHeaderButtonText}>Done</Text>
//             </TouchableOpacity>
//           </View>

//           <ScrollView contentContainerStyle={styles.tabsGrid}>
//             {tabs.map(tab => (
//               <TouchableOpacity
//                 key={tab.id}
//                 style={[
//                   styles.tabCard,
//                   tab.id === currentTabId && styles.tabCardActive,
//                 ]}
//                 onPress={() => handleSelectTab(tab.id)}
//                 activeOpacity={0.8}>
//                 {/* Tab Preview Background */}
//                 <View style={styles.tabCardPreviewContainer}>
//                   {tab.screenshot ? (
//                     <Image
//                       source={{uri: tab.screenshot}}
//                       style={styles.tabCardScreenshot}
//                       resizeMode="cover"
//                     />
//                   ) : (
//                     <>
//                       {/* Gradient/colored background when no screenshot */}
//                       <View style={[styles.tabCardPlaceholder, {backgroundColor: theme.colors.surface}]} />
//                       <Image
//                         source={{
//                           uri: `https://icons.duckduckgo.com/ip3/${getDomain(
//                             tab.url,
//                           )}.ico`,
//                         }}
//                         style={styles.tabCardFavicon}
//                         defaultSource={require('../assets/images/desktop-2.jpg')}
//                       />
//                     </>
//                   )}
//                 </View>

//                 {/* Overlay with text content */}
//                 <View style={styles.tabCardOverlay}>
//                   <View style={styles.tabCardHeader}>
//                     <Text style={styles.tabCardTitle} numberOfLines={2}>
//                       {tab.title || getDomain(tab.url)}
//                     </Text>
//                     <TouchableOpacity
//                       style={styles.tabCardClose}
//                       onPress={() => handleCloseTab(tab.id)}
//                       hitSlop={{top: 10, bottom: 10, left: 10, right: 10}}>
//                       <MaterialIcons name="close" size={16} color="#fff" />
//                     </TouchableOpacity>
//                   </View>
//                   <View style={styles.tabCardContent}>
//                     <Text style={styles.tabCardDomain}>
//                       {getDomain(tab.url)}
//                     </Text>
//                   </View>
//                 </View>
//               </TouchableOpacity>
//             ))}
//             <TouchableOpacity style={styles.newTabCard} onPress={handleNewTab}>
//               <MaterialIcons
//                 name="add"
//                 size={2}
//                 color={theme.colors.foreground3}
//               />
//               <Text style={styles.newTabText}>New Tab</Text>
//             </TouchableOpacity>
//           </ScrollView>
//         </Animated.View>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity style={styles.saveMenuItem} onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons name="share" size={22} color="#3b82f6" />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {activeBookmarksTab === 'bookmarks' ? (
//               <>
//                 {/* Recently Saved */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.recentlySavedSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Recently Saved
//                       <MaterialIcons
//                         name="chevron-right"
//                         size={18}
//                         color={theme.colors.foreground3}
//                       />
//                     </Text>
//                     <ScrollView
//                       horizontal
//                       showsHorizontalScrollIndicator={false}
//                       style={styles.recentlySavedScroll}>
//                       {bookmarks.slice(0, 5).map(bookmark => (
//                         <TouchableOpacity
//                           key={bookmark.id}
//                           style={styles.recentlySavedCard}
//                           onPress={() =>
//                             handleBookmarkNavigation(
//                               bookmark.url,
//                               bookmark.title,
//                             )
//                           }>
//                           <View style={styles.recentlySavedPreview}>
//                             <MaterialIcons
//                               name="language"
//                               size={32}
//                               color={theme.colors.foreground3}
//                             />
//                           </View>
//                           <Text
//                             style={styles.recentlySavedTitle}
//                             numberOfLines={2}>
//                             {bookmark.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {bookmark.source}
//                           </Text>
//                           <View style={styles.recentlySavedBadge}>
//                             <MaterialIcons
//                               name="schedule"
//                               size={10}
//                               color={theme.colors.foreground3}
//                             />
//                             <Text style={styles.recentlySavedBadgeText}>
//                               Bookmarks
//                             </Text>
//                           </View>
//                         </TouchableOpacity>
//                       ))}
//                     </ScrollView>
//                   </View>
//                 )}

//                 {/* Collections Folders */}
//                 {collections.length > 0 && (
//                   <View style={styles.foldersSection}>
//                     <Text style={styles.sectionHeaderText}>Collections</Text>
//                     {collections.map(collection => (
//                       <TouchableOpacity
//                         key={collection.id}
//                         style={styles.folderItem}>
//                         <View
//                           style={[
//                             styles.folderIcon,
//                             {backgroundColor: collection.color + '33'},
//                           ]}>
//                           <MaterialIcons
//                             name="folder"
//                             size={20}
//                             color={collection.color}
//                           />
//                         </View>
//                         <Text style={styles.folderName}>{collection.name}</Text>
//                         <Text style={styles.folderCount}>
//                           {collection.items.length}
//                         </Text>
//                         <MaterialIcons
//                           name="chevron-right"
//                           size={20}
//                           color={theme.colors.foreground3}
//                         />
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* All Bookmarks */}
//                 {bookmarks.length > 0 && (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                     {bookmarks.map(bookmark => (
//                       <TouchableOpacity
//                         key={bookmark.id}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(bookmark.url, bookmark.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="language"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <Text
//                           style={styles.bookmarkListTitle}
//                           numberOfLines={1}>
//                           {bookmark.title}
//                         </Text>
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 )}

//                 {/* Empty State */}
//                 {bookmarks.length === 0 && collections.length === 0 && (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="bookmark-border"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No bookmarks yet
//                     </Text>
//                   </View>
//                 )}
//               </>
//             ) : (
//               <>
//                 {/* Browsing History */}
//                 {history.length > 0 ? (
//                   <View style={styles.bookmarksSection}>
//                     <Text style={styles.sectionHeaderText}>
//                       Browsing History
//                     </Text>
//                     {history.map((item, index) => (
//                       <TouchableOpacity
//                         key={`${item.url}-${index}`}
//                         style={styles.bookmarkListItem}
//                         onPress={() =>
//                           handleBookmarkNavigation(item.url, item.title)
//                         }>
//                         <View style={styles.bookmarkListIcon}>
//                           <MaterialIcons
//                             name="history"
//                             size={16}
//                             color={theme.colors.foreground3}
//                           />
//                         </View>
//                         <View style={{flex: 1}}>
//                           <Text
//                             style={styles.bookmarkListTitle}
//                             numberOfLines={1}>
//                             {item.title}
//                           </Text>
//                           <Text
//                             style={styles.recentlySavedUrl}
//                             numberOfLines={1}>
//                             {item.source}
//                           </Text>
//                         </View>
//                         {item.visitCount > 1 && (
//                           <Text style={styles.folderCount}>
//                             {item.visitCount}x
//                           </Text>
//                         )}
//                       </TouchableOpacity>
//                     ))}
//                   </View>
//                 ) : (
//                   <View style={styles.bookmarksEmptyState}>
//                     <MaterialIcons
//                       name="history"
//                       size={48}
//                       color={theme.colors.foreground3}
//                     />
//                     <Text style={styles.bookmarksEmptyText}>
//                       No browsing history
//                     </Text>
//                   </View>
//                 )}
//               </>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('bookmarks');
//               }}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'bookmarks'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//             <TouchableOpacity
//               style={styles.bookmarksTab}
//               onPress={() => {
//                 triggerHaptic('impactLight');
//                 setActiveBookmarksTab('history');
//               }}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={
//                   activeBookmarksTab === 'history'
//                     ? theme.colors.primary
//                     : theme.colors.foreground3
//                 }
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

/////////////////////

// import React, {useRef, useState, useEffect} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
//   Share,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);
//   const [showBookmarksModal, setShowBookmarksModal] = useState(false);

//   // Initialize with a tab if navigating with URL
//   useEffect(() => {
//     if (initialUrl && tabs.length === 0) {
//       addTab(initialUrl, 'New Tab');
//     }
//   }, []);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       return `https://${normalized}`;
//     }
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const newUrl = normalizeUrl(inputValue);
//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const handleShare = async () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     try {
//       await Share.share({
//         url: currentTab.url,
//         title: currentTab.title || getDomain(currentTab.url),
//         message: `${currentTab.title || getDomain(currentTab.url)}\n${currentTab.url}`,
//       });
//       setShowSaveMenu(false);
//     } catch (error) {
//       console.error('Error sharing:', error);
//     }
//   };

//   const handleOpenBookmarks = () => {
//     triggerHaptic('impactLight');
//     setShowSaveMenu(false);
//     setShowBookmarksModal(true);
//   };

//   const handleBookmarkNavigation = (url: string, title: string) => {
//     triggerHaptic('impactLight');
//     if (currentTab) {
//       updateTab(currentTab.id, url, title);
//     } else {
//       addTab(url, title);
//     }
//     setShowBookmarksModal(false);
//   };

//   const openTabsView = () => {
//     triggerHaptic('impactLight');
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 12,
//       paddingHorizontal: 16,
//       paddingBottom: 12,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 8,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: theme.colors.surface,
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabCardDomain: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground2,
//       marginTop: 8,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//     // Bookmarks Modal Styles
//     bookmarksModalContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       marginTop: insets.top,
//     },
//     bookmarksModalHeader: {
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//       paddingHorizontal: 16,
//       paddingTop: 16,
//       paddingBottom: 8,
//     },
//     bookmarksCloseButton: {
//       padding: 8,
//     },
//     bookmarksMenuButton: {
//       padding: 8,
//     },
//     bookmarksSearchContainer: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.surface,
//       borderRadius: 10,
//       marginHorizontal: 16,
//       marginBottom: 16,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     bookmarksSearchIcon: {
//       marginRight: 8,
//     },
//     bookmarksSearchInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     bookmarksSearchMic: {
//       marginLeft: 8,
//     },
//     bookmarksModalContent: {
//       flex: 1,
//     },
//     // Recently Saved Section
//     recentlySavedSection: {
//       marginBottom: 24,
//     },
//     sectionHeaderText: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 16,
//       marginBottom: 12,
//     },
//     recentlySavedScroll: {
//       paddingLeft: 16,
//     },
//     recentlySavedCard: {
//       width: 160,
//       marginRight: 12,
//       backgroundColor: theme.colors.surface,
//       borderRadius: 12,
//       padding: 12,
//     },
//     recentlySavedPreview: {
//       width: '100%',
//       height: 100,
//       backgroundColor: theme.colors.background,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginBottom: 8,
//     },
//     recentlySavedTitle: {
//       fontSize: 13,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     recentlySavedUrl: {
//       fontSize: 11,
//       color: theme.colors.foreground3,
//       marginBottom: 6,
//     },
//     recentlySavedBadge: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       alignSelf: 'flex-start',
//       paddingHorizontal: 6,
//       paddingVertical: 2,
//       borderRadius: 4,
//     },
//     recentlySavedBadgeText: {
//       fontSize: 9,
//       color: theme.colors.foreground3,
//       marginLeft: 2,
//     },
//     // Folders Section
//     foldersSection: {
//       marginBottom: 24,
//     },
//     folderItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     folderIcon: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     folderName: {
//       flex: 1,
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     folderCount: {
//       fontSize: 14,
//       color: theme.colors.foreground3,
//       marginRight: 8,
//     },
//     // Bookmarks Section
//     bookmarksSection: {
//       marginBottom: 24,
//     },
//     bookmarkListItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 10,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//     },
//     bookmarkListIcon: {
//       width: 24,
//       height: 24,
//       borderRadius: 6,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkListTitle: {
//       flex: 1,
//       fontSize: 14,
//       color: theme.colors.foreground,
//     },
//     // Empty State
//     bookmarksEmptyState: {
//       flex: 1,
//       justifyContent: 'center',
//       alignItems: 'center',
//       paddingVertical: 60,
//     },
//     bookmarksEmptyText: {
//       fontSize: 16,
//       color: theme.colors.foreground3,
//       marginTop: 16,
//     },
//     // Tab Bar
//     bookmarksTabBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     bookmarksTab: {
//       padding: 8,
//     },
//     // Legacy styles (for compatibility)
//     bookmarkModalItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 16,
//       backgroundColor: theme.colors.surface,
//       borderBottomWidth: 1,
//       borderBottomColor: theme.colors.surfaceBorder,
//     },
//     bookmarkModalIcon: {
//       width: 36,
//       height: 36,
//       borderRadius: 8,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     bookmarkModalInfo: {
//       flex: 1,
//       marginRight: 8,
//     },
//     bookmarkModalTitle: {
//       fontSize: 15,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//       marginBottom: 4,
//     },
//     bookmarkModalUrl: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={setInputValue}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => triggerHaptic('impactLight')}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="url"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <WebView
//           ref={webRef}
//           source={{uri: currentTab?.url || ''}}
//           style={{flex: 1}}
//           originWhitelist={['*']}
//           javaScriptEnabled
//           domStorageEnabled
//           // ðŸ‘‡ Inertia / momentum scrolling
//           decelerationRate="normal" // gives Safari-style glide
//           bounces={true} // iOS bounce effect
//           scrollEnabled={true} // ensure scroll isnâ€™t locked
//           showsVerticalScrollIndicator={false}
//           showsHorizontalScrollIndicator={false}
//           overScrollMode="never" // keeps Android smooth too
//           androidLayerType="hardware" // helps performance
//           onNavigationStateChange={navState => {
//             if (currentTab && navState.url) {
//               updateTab(
//                 currentTab.id,
//                 navState.url,
//                 navState.title || currentTab.title,
//               );
//               setInputValue(navState.url);
//             }
//           }}
//           userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <Animated.View
//           style={[
//             styles.tabsOverlay,
//             {
//               opacity: tabsViewScale,
//               transform: [
//                 {
//                   scale: tabsViewScale.interpolate({
//                     inputRange: [0, 1],
//                     outputRange: [0.9, 1],
//                   }),
//                 },
//               ],
//             },
//           ]}>
//           <View style={styles.tabsHeader}>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={handleNewTab}>
//               <Text style={styles.tabsHeaderButtonText}>+</Text>
//             </TouchableOpacity>
//             <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={closeTabsView}>
//               <Text style={styles.tabsHeaderButtonText}>Done</Text>
//             </TouchableOpacity>
//           </View>

//           <ScrollView contentContainerStyle={styles.tabsGrid}>
//             {tabs.map(tab => (
//               <TouchableOpacity
//                 key={tab.id}
//                 style={[
//                   styles.tabCard,
//                   tab.id === currentTabId && styles.tabCardActive,
//                 ]}
//                 onPress={() => handleSelectTab(tab.id)}
//                 activeOpacity={0.8}>
//                 <View style={styles.tabCardHeader}>
//                   <Text style={styles.tabCardTitle} numberOfLines={1}>
//                     {tab.title || getDomain(tab.url)}
//                   </Text>
//                   <TouchableOpacity
//                     style={styles.tabCardClose}
//                     onPress={() => handleCloseTab(tab.id)}
//                     hitSlop={{top: 10, bottom: 10, left: 10, right: 10}}>
//                     <MaterialIcons
//                       name="close"
//                       size={16}
//                       color={theme.colors.foreground3}
//                     />
//                   </TouchableOpacity>
//                 </View>
//                 <View style={styles.tabCardContent}>
//                   <MaterialIcons
//                     name="language"
//                     size={40}
//                     color={theme.colors.foreground3}
//                   />
//                   <Text style={styles.tabCardDomain}>{getDomain(tab.url)}</Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//             <TouchableOpacity style={styles.newTabCard} onPress={handleNewTab}>
//               <MaterialIcons
//                 name="add"
//                 size={2}
//                 color={theme.colors.foreground3}
//               />
//               <Text style={styles.newTabText}>New Tab</Text>
//             </TouchableOpacity>
//           </ScrollView>
//         </Animated.View>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}

//             {/* Share Link */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleShare}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="share"
//                   size={22}
//                   color="#3b82f6"
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Share Link</Text>
//               <MaterialIcons
//                 name="ios-share"
//                 size={20}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* View Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleOpenBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmarks"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Bookmarks</Text>
//               <Text style={styles.collectionCount}>{bookmarks.length}</Text>
//             </TouchableOpacity>
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>

//       {/* Bookmarks Modal */}
//       <Modal
//         visible={showBookmarksModal}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowBookmarksModal(false)}>
//         <View style={styles.bookmarksModalContainer}>
//           {/* Header */}
//           <View style={styles.bookmarksModalHeader}>
//             <TouchableOpacity
//               onPress={() => setShowBookmarksModal(false)}
//               style={styles.bookmarksCloseButton}>
//               <MaterialIcons
//                 name="close"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksMenuButton}>
//               <MaterialIcons
//                 name="more-horiz"
//                 size={24}
//                 color={theme.colors.foreground}
//               />
//             </TouchableOpacity>
//           </View>

//           {/* Search Bar */}
//           <View style={styles.bookmarksSearchContainer}>
//             <MaterialIcons
//               name="search"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchIcon}
//             />
//             <TextInput
//               style={styles.bookmarksSearchInput}
//               placeholder="Search Bookmarks"
//               placeholderTextColor={theme.colors.foreground3}
//             />
//             <MaterialIcons
//               name="mic"
//               size={20}
//               color={theme.colors.foreground3}
//               style={styles.bookmarksSearchMic}
//             />
//           </View>

//           <ScrollView style={styles.bookmarksModalContent}>
//             {/* Recently Saved */}
//             {bookmarks.length > 0 && (
//               <View style={styles.recentlySavedSection}>
//                 <Text style={styles.sectionHeaderText}>
//                   Recently Saved
//                   <MaterialIcons
//                     name="chevron-right"
//                     size={18}
//                     color={theme.colors.foreground3}
//                   />
//                 </Text>
//                 <ScrollView
//                   horizontal
//                   showsHorizontalScrollIndicator={false}
//                   style={styles.recentlySavedScroll}>
//                   {bookmarks.slice(0, 5).map(bookmark => (
//                     <TouchableOpacity
//                       key={bookmark.id}
//                       style={styles.recentlySavedCard}
//                       onPress={() =>
//                         handleBookmarkNavigation(bookmark.url, bookmark.title)
//                       }>
//                       <View style={styles.recentlySavedPreview}>
//                         <MaterialIcons
//                           name="language"
//                           size={32}
//                           color={theme.colors.foreground3}
//                         />
//                       </View>
//                       <Text
//                         style={styles.recentlySavedTitle}
//                         numberOfLines={2}>
//                         {bookmark.title}
//                       </Text>
//                       <Text style={styles.recentlySavedUrl} numberOfLines={1}>
//                         {bookmark.source}
//                       </Text>
//                       <View style={styles.recentlySavedBadge}>
//                         <MaterialIcons
//                           name="schedule"
//                           size={10}
//                           color={theme.colors.foreground3}
//                         />
//                         <Text style={styles.recentlySavedBadgeText}>
//                           Bookmarks
//                         </Text>
//                       </View>
//                     </TouchableOpacity>
//                   ))}
//                 </ScrollView>
//               </View>
//             )}

//             {/* Collections Folders */}
//             {collections.length > 0 && (
//               <View style={styles.foldersSection}>
//                 <Text style={styles.sectionHeaderText}>Collections</Text>
//                 {collections.map(collection => (
//                   <TouchableOpacity
//                     key={collection.id}
//                     style={styles.folderItem}>
//                     <View
//                       style={[
//                         styles.folderIcon,
//                         {backgroundColor: collection.color + '33'},
//                       ]}>
//                       <MaterialIcons
//                         name="folder"
//                         size={20}
//                         color={collection.color}
//                       />
//                     </View>
//                     <Text style={styles.folderName}>{collection.name}</Text>
//                     <Text style={styles.folderCount}>
//                       {collection.items.length}
//                     </Text>
//                     <MaterialIcons
//                       name="chevron-right"
//                       size={20}
//                       color={theme.colors.foreground3}
//                     />
//                   </TouchableOpacity>
//                 ))}
//               </View>
//             )}

//             {/* All Bookmarks */}
//             {bookmarks.length > 0 && (
//               <View style={styles.bookmarksSection}>
//                 <Text style={styles.sectionHeaderText}>Bookmarks</Text>
//                 {bookmarks.map(bookmark => (
//                   <TouchableOpacity
//                     key={bookmark.id}
//                     style={styles.bookmarkListItem}
//                     onPress={() =>
//                       handleBookmarkNavigation(bookmark.url, bookmark.title)
//                     }>
//                     <View style={styles.bookmarkListIcon}>
//                       <MaterialIcons
//                         name="language"
//                         size={16}
//                         color={theme.colors.foreground3}
//                       />
//                     </View>
//                     <Text style={styles.bookmarkListTitle} numberOfLines={1}>
//                       {bookmark.title}
//                     </Text>
//                   </TouchableOpacity>
//                 ))}
//               </View>
//             )}

//             {/* Empty State */}
//             {bookmarks.length === 0 && collections.length === 0 && (
//               <View style={styles.bookmarksEmptyState}>
//                 <MaterialIcons
//                   name="bookmark-border"
//                   size={48}
//                   color={theme.colors.foreground3}
//                 />
//                 <Text style={styles.bookmarksEmptyText}>No bookmarks yet</Text>
//               </View>
//             )}
//           </ScrollView>

//           {/* Bottom Tab Bar */}
//           <View style={styles.bookmarksTabBar}>
//             <TouchableOpacity style={styles.bookmarksTab}>
//               <MaterialIcons
//                 name="bookmark"
//                 size={22}
//                 color={theme.colors.primary}
//               />
//             </TouchableOpacity>
//             <TouchableOpacity style={styles.bookmarksTab}>
//               <MaterialIcons
//                 name="history"
//                 size={22}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           </View>
//         </View>
//       </Modal>
//     </View>
//   );
// }

////////////////////

// import React, {useRef, useState, useEffect} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
//   Modal,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//     collections,
//     addItemToCollection,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;
//   const [showSaveMenu, setShowSaveMenu] = useState(false);
//   const [showCollectionPicker, setShowCollectionPicker] = useState(false);

//   // Initialize with a tab if navigating with URL
//   useEffect(() => {
//     if (initialUrl && tabs.length === 0) {
//       addTab(initialUrl, 'New Tab');
//     }
//   }, []);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       return `https://${normalized}`;
//     }
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const newUrl = normalizeUrl(inputValue);
//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   const handleSaveMenuOpen = () => {
//     if (!currentTab || !currentTab.url) return;
//     triggerHaptic('impactLight');
//     setShowSaveMenu(true);
//   };

//   const handleAddToBookmarks = () => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         addedAt: Date.now(),
//       });
//     }
//     setShowSaveMenu(false);
//   };

//   const handleAddToCollection = (collectionId: string) => {
//     if (!currentTab) return;
//     triggerHaptic('impactLight');
//     addItemToCollection(collectionId, {
//       id: Date.now().toString(),
//       title: currentTab.title || getDomain(currentTab.url),
//       url: currentTab.url,
//       source: getDomain(currentTab.url),
//       addedAt: Date.now(),
//     });
//     setShowCollectionPicker(false);
//     setShowSaveMenu(false);
//   };

//   const openTabsView = () => {
//     triggerHaptic('impactLight');
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 12,
//       paddingHorizontal: 16,
//       paddingBottom: 12,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 8,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: theme.colors.surface,
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabCardDomain: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground2,
//       marginTop: 8,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//     // Save Menu Styles
//     saveMenuOverlay: {
//       flex: 1,
//       backgroundColor: 'rgba(0,0,0,0.5)',
//       justifyContent: 'flex-end',
//     },
//     saveMenuContent: {
//       backgroundColor: theme.colors.surface,
//       borderTopLeftRadius: 20,
//       borderTopRightRadius: 20,
//       paddingTop: 12,
//       paddingBottom: insets.bottom + 20,
//     },
//     saveMenuHandle: {
//       width: 36,
//       height: 4,
//       backgroundColor: theme.colors.foreground3,
//       borderRadius: 2,
//       alignSelf: 'center',
//       marginBottom: 16,
//     },
//     saveMenuTitle: {
//       fontSize: 16,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       paddingHorizontal: 20,
//       marginBottom: 12,
//     },
//     saveMenuItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 14,
//       paddingHorizontal: 20,
//     },
//     saveMenuItemIcon: {
//       width: 40,
//       height: 40,
//       borderRadius: 10,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//       marginRight: 12,
//     },
//     saveMenuItemText: {
//       flex: 1,
//       fontSize: 16,
//       color: theme.colors.foreground,
//     },
//     saveMenuItemCheck: {
//       marginLeft: 8,
//     },
//     collectionItem: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingHorizontal: 20,
//     },
//     collectionColor: {
//       width: 32,
//       height: 32,
//       borderRadius: 8,
//       marginRight: 12,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     collectionName: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//     },
//     collectionCount: {
//       fontSize: 13,
//       color: theme.colors.foreground3,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={setInputValue}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => triggerHaptic('impactLight')}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="url"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//           {currentTab && currentTab.url && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={handleSaveMenuOpen}>
//               <MaterialIcons
//                 name="add-circle-outline"
//                 size={32}
//                 color={theme.colors.foreground2}
//               />
//             </TouchableOpacity>
//           )}
//         </View>
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <WebView
//           ref={webRef}
//           source={{uri: currentTab?.url || ''}}
//           style={{flex: 1}}
//           originWhitelist={['*']}
//           javaScriptEnabled
//           domStorageEnabled
//           onNavigationStateChange={navState => {
//             if (currentTab && navState.url) {
//               updateTab(
//                 currentTab.id,
//                 navState.url,
//                 navState.title || currentTab.title,
//               );
//               setInputValue(navState.url);
//             }
//           }}
//           userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <Animated.View
//           style={[
//             styles.tabsOverlay,
//             {
//               opacity: tabsViewScale,
//               transform: [
//                 {
//                   scale: tabsViewScale.interpolate({
//                     inputRange: [0, 1],
//                     outputRange: [0.9, 1],
//                   }),
//                 },
//               ],
//             },
//           ]}>
//           <View style={styles.tabsHeader}>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={handleNewTab}>
//               <Text style={styles.tabsHeaderButtonText}>+</Text>
//             </TouchableOpacity>
//             <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//             <TouchableOpacity
//               style={styles.tabsHeaderButton}
//               onPress={closeTabsView}>
//               <Text style={styles.tabsHeaderButtonText}>Done</Text>
//             </TouchableOpacity>
//           </View>

//           <ScrollView contentContainerStyle={styles.tabsGrid}>
//             {tabs.map(tab => (
//               <TouchableOpacity
//                 key={tab.id}
//                 style={[
//                   styles.tabCard,
//                   tab.id === currentTabId && styles.tabCardActive,
//                 ]}
//                 onPress={() => handleSelectTab(tab.id)}
//                 activeOpacity={0.8}>
//                 <View style={styles.tabCardHeader}>
//                   <Text style={styles.tabCardTitle} numberOfLines={1}>
//                     {tab.title || getDomain(tab.url)}
//                   </Text>
//                   <TouchableOpacity
//                     style={styles.tabCardClose}
//                     onPress={() => handleCloseTab(tab.id)}
//                     hitSlop={{top: 10, bottom: 10, left: 10, right: 10}}>
//                     <MaterialIcons
//                       name="close"
//                       size={16}
//                       color={theme.colors.foreground3}
//                     />
//                   </TouchableOpacity>
//                 </View>
//                 <View style={styles.tabCardContent}>
//                   <MaterialIcons
//                     name="language"
//                     size={40}
//                     color={theme.colors.foreground3}
//                   />
//                   <Text style={styles.tabCardDomain}>{getDomain(tab.url)}</Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//             <TouchableOpacity style={styles.newTabCard} onPress={handleNewTab}>
//               <MaterialIcons
//                 name="add"
//                 size={2}
//                 color={theme.colors.foreground3}
//               />
//               <Text style={styles.newTabText}>New Tab</Text>
//             </TouchableOpacity>
//           </ScrollView>
//         </Animated.View>
//       )}

//       {/* Save Menu Modal */}
//       <Modal
//         visible={showSaveMenu}
//         transparent
//         animationType="slide"
//         onRequestClose={() => setShowSaveMenu(false)}>
//         <TouchableOpacity
//           style={styles.saveMenuOverlay}
//           activeOpacity={1}
//           onPress={() => {
//             setShowSaveMenu(false);
//             setShowCollectionPicker(false);
//           }}>
//           <TouchableOpacity
//             activeOpacity={1}
//             onPress={e => e.stopPropagation()}
//             style={styles.saveMenuContent}>
//             <View style={styles.saveMenuHandle} />
//             <Text style={styles.saveMenuTitle}>Save Page</Text>

//             {/* Add to Bookmarks */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={handleAddToBookmarks}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="bookmark"
//                   size={22}
//                   color={theme.colors.primary}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>
//                 {bookmarked ? 'Remove from Bookmarks' : 'Add to Bookmarks'}
//               </Text>
//               {bookmarked && (
//                 <MaterialIcons
//                   name="check"
//                   size={20}
//                   color={theme.colors.primary}
//                   style={styles.saveMenuItemCheck}
//                 />
//               )}
//             </TouchableOpacity>

//             {/* Add to Collection */}
//             <TouchableOpacity
//               style={styles.saveMenuItem}
//               onPress={() => setShowCollectionPicker(!showCollectionPicker)}>
//               <View style={styles.saveMenuItemIcon}>
//                 <MaterialIcons
//                   name="folder-special"
//                   size={22}
//                   color={theme.colors.secondary || '#f59e0b'}
//                 />
//               </View>
//               <Text style={styles.saveMenuItemText}>Add to Favorites</Text>
//               <MaterialIcons
//                 name={showCollectionPicker ? 'expand-less' : 'expand-more'}
//                 size={24}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>

//             {/* Collection Picker */}
//             {showCollectionPicker && (
//               <View>
//                 {collections.length === 0 ? (
//                   <Text
//                     style={[
//                       styles.collectionName,
//                       {paddingHorizontal: 20, paddingVertical: 12},
//                     ]}>
//                     No collections yet
//                   </Text>
//                 ) : (
//                   collections.map(collection => (
//                     <TouchableOpacity
//                       key={collection.id}
//                       style={styles.collectionItem}
//                       onPress={() => handleAddToCollection(collection.id)}>
//                       <View
//                         style={[
//                           styles.collectionColor,
//                           {backgroundColor: collection.color},
//                         ]}>
//                         <MaterialIcons name="folder" size={18} color="#fff" />
//                       </View>
//                       <Text style={styles.collectionName}>
//                         {collection.name}
//                       </Text>
//                       <Text style={styles.collectionCount}>
//                         {collection.items.length} items
//                       </Text>
//                     </TouchableOpacity>
//                   ))
//                 )}
//               </View>
//             )}
//           </TouchableOpacity>
//         </TouchableOpacity>
//       </Modal>
//     </View>
//   );
// }

//////////////////

// import React, {useRef, useState, useEffect} from 'react';
// import {
//   View,
//   Text,
//   StyleSheet,
//   TouchableOpacity,
//   StatusBar,
//   TextInput,
//   Keyboard,
//   ScrollView,
//   Dimensions,
//   Animated,
// } from 'react-native';
// import {WebView} from 'react-native-webview';
// import {useSafeAreaInsets} from 'react-native-safe-area-context';
// import MaterialIcons from 'react-native-vector-icons/MaterialIcons';
// import {useAppTheme} from '../context/ThemeContext';
// import {useShoppingStore} from '../../../../store/shoppingStore';
// import {triggerHaptic} from '../utils/haptics';

// const {width: screenWidth} = Dimensions.get('window');
// const TAB_CARD_WIDTH = (screenWidth - 48) / 2;
// const TAB_CARD_HEIGHT = TAB_CARD_WIDTH * 1.4;

// const SHOPPING_SITES = [
//   {name: 'Google', url: 'https://google.com'},
//   {name: 'Amazon', url: 'https://amazon.com'},
//   {name: 'ASOS', url: 'https://asos.com'},
//   {name: 'H&M', url: 'https://hm.com'},
//   {name: 'Zara', url: 'https://zara.com'},
//   {name: 'Shein', url: 'https://shein.com'},
//   {name: 'SSENSE', url: 'https://ssense.com'},
//   {name: 'Farfetch', url: 'https://farfetch.com'},
//   {name: 'Nordstrom', url: 'https://nordstrom.com'},
// ];

// type Props = {
//   route?: {params?: {url?: string; title?: string}};
// };

// export default function WebBrowserScreen({route}: Props) {
//   const {theme} = useAppTheme();
//   const insets = useSafeAreaInsets();
//   const initialUrl = route?.params?.url || '';
//   const webRef = useRef<WebView>(null);
//   const [inputValue, setInputValue] = useState(initialUrl);
//   const [showTabsView, setShowTabsView] = useState(false);
//   const tabsViewScale = useRef(new Animated.Value(0)).current;

//   const {
//     tabs,
//     currentTabId,
//     addTab,
//     removeTab,
//     switchTab,
//     updateTab,
//     addBookmark,
//     removeBookmark,
//     isBookmarked,
//     bookmarks,
//   } = useShoppingStore();

//   const currentTab = tabs.find(t => t.id === currentTabId);
//   const bookmarked = currentTab ? isBookmarked(currentTab.url) : false;

//   // Initialize with a tab if navigating with URL
//   useEffect(() => {
//     if (initialUrl && tabs.length === 0) {
//       addTab(initialUrl, 'New Tab');
//     }
//   }, []);

//   // Update input when tab changes
//   useEffect(() => {
//     if (currentTab) {
//       setInputValue(currentTab.url);
//     }
//   }, [currentTabId, currentTab?.url]);

//   const getDomain = (url: string) => {
//     try {
//       const urlObj = new URL(url);
//       return urlObj.hostname.replace('www.', '');
//     } catch {
//       return url || 'New Tab';
//     }
//   };

//   const normalizeUrl = (text: string): string => {
//     const normalized = text.trim();
//     if (normalized.startsWith('http://') || normalized.startsWith('https://')) {
//       return normalized;
//     }
//     if (normalized.includes('.') && !normalized.includes(' ')) {
//       return `https://${normalized}`;
//     }
//     return `https://google.com/search?q=${encodeURIComponent(normalized)}`;
//   };

//   const handleSubmit = () => {
//     if (inputValue.trim()) {
//       const newUrl = normalizeUrl(inputValue);
//       if (currentTab) {
//         updateTab(currentTab.id, newUrl, currentTab.title);
//       } else {
//         addTab(newUrl, 'New Tab');
//       }
//     }
//     Keyboard.dismiss();
//   };

//   const handleQuickShop = (url: string) => {
//     addTab(url, getDomain(url));
//     setShowTabsView(false);
//   };

//   const handleBookmark = () => {
//     if (!currentTab) return;
//     if (bookmarked) {
//       const bookmark = bookmarks.find(b => b.url === currentTab.url);
//       if (bookmark) {
//         removeBookmark(bookmark.id);
//       }
//     } else {
//       addBookmark({
//         id: Date.now().toString(),
//         title: currentTab.title || getDomain(currentTab.url),
//         url: currentTab.url,
//         source: getDomain(currentTab.url),
//         addedAt: Date.now(),
//       });
//     }
//   };

//   const openTabsView = () => {
//     triggerHaptic('impactLight');
//     setShowTabsView(true);
//     Animated.spring(tabsViewScale, {
//       toValue: 1,
//       useNativeDriver: true,
//       tension: 50,
//       friction: 8,
//     }).start();
//   };

//   const closeTabsView = () => {
//     Animated.timing(tabsViewScale, {
//       toValue: 0,
//       duration: 200,
//       useNativeDriver: true,
//     }).start(() => setShowTabsView(false));
//   };

//   const handleSelectTab = (tabId: string) => {
//     triggerHaptic('impactLight');
//     switchTab(tabId);
//     closeTabsView();
//   };

//   const handleCloseTab = (tabId: string) => {
//     triggerHaptic('impactMedium');
//     removeTab(tabId);
//   };

//   const handleNewTab = () => {
//     triggerHaptic('impactLight');
//     addTab('', 'New Tab');
//     closeTabsView();
//   };

//   const styles = StyleSheet.create({
//     container: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     header: {
//       paddingTop: insets.top + 55,
//       backgroundColor: theme.colors.surface,
//       paddingHorizontal: 12,
//       paddingBottom: 12,
//     },
//     urlBar: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       backgroundColor: theme.colors.background,
//       borderRadius: 10,
//       paddingHorizontal: 12,
//       height: 40,
//     },
//     urlInput: {
//       flex: 1,
//       fontSize: 15,
//       color: theme.colors.foreground,
//       padding: 0,
//     },
//     iconButton: {
//       padding: 4,
//       marginLeft: 8,
//     },
//     tabsButton: {
//       marginLeft: 8,
//       width: 28,
//       height: 24,
//       borderRadius: 6,
//       borderWidth: 2,
//       borderColor: theme.colors.foreground2,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabsCount: {
//       fontSize: 12,
//       fontWeight: '700',
//       color: theme.colors.foreground2,
//     },
//     landingContainer: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//     },
//     landingTitle: {
//       fontSize: 18,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//       marginHorizontal: 16,
//       marginTop: 24,
//       marginBottom: 16,
//     },
//     shoppingGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 8,
//     },
//     shoppingButton: {
//       alignItems: 'center',
//       justifyContent: 'center',
//       margin: 8,
//       padding: 16,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       borderWidth: 1,
//       borderColor: theme.colors.surfaceBorder,
//       width: (screenWidth - 48) / 2,
//     },
//     shoppingButtonText: {
//       color: theme.colors.foreground,
//       fontSize: 14,
//       fontWeight: '500',
//       marginTop: 8,
//     },
//     // Tabs View Overlay
//     tabsOverlay: {
//       position: 'absolute',
//       top: 0,
//       left: 0,
//       right: 0,
//       bottom: 0,
//       backgroundColor: theme.colors.background,
//       zIndex: 1000,
//     },
//     tabsHeader: {
//       paddingTop: insets.top + 12,
//       paddingHorizontal: 16,
//       paddingBottom: 12,
//       flexDirection: 'row',
//       justifyContent: 'space-between',
//       alignItems: 'center',
//     },
//     tabsHeaderTitle: {
//       fontSize: 17,
//       fontWeight: '600',
//       color: theme.colors.foreground,
//     },
//     tabsHeaderButton: {
//       padding: 8,
//     },
//     tabsHeaderButtonText: {
//       fontSize: 17,
//       color: theme.colors.primary,
//     },
//     tabsGrid: {
//       flexDirection: 'row',
//       flexWrap: 'wrap',
//       paddingHorizontal: 12,
//       paddingTop: 8,
//     },
//     tabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       overflow: 'hidden',
//       borderWidth: 2,
//       borderColor: 'transparent',
//     },
//     tabCardActive: {
//       borderColor: theme.colors.primary,
//     },
//     tabCardHeader: {
//       flexDirection: 'row',
//       alignItems: 'center',
//       justifyContent: 'space-between',
//       paddingHorizontal: 10,
//       paddingVertical: 8,
//       backgroundColor: theme.colors.surface,
//     },
//     tabCardTitle: {
//       flex: 1,
//       fontSize: 12,
//       fontWeight: '500',
//       color: theme.colors.foreground,
//     },
//     tabCardClose: {
//       padding: 2,
//     },
//     tabCardContent: {
//       flex: 1,
//       backgroundColor: theme.colors.background,
//       justifyContent: 'center',
//       alignItems: 'center',
//     },
//     tabCardDomain: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground2,
//       marginTop: 8,
//     },
//     newTabCard: {
//       width: TAB_CARD_WIDTH,
//       height: TAB_CARD_HEIGHT,
//       margin: 6,
//       borderRadius: 12,
//       backgroundColor: theme.colors.surface,
//       justifyContent: 'center',
//       alignItems: 'center',
//       borderWidth: 2,
//       borderColor: theme.colors.surfaceBorder,
//       borderStyle: 'dashed',
//     },
//     newTabText: {
//       fontSize: 14,
//       fontWeight: '500',
//       color: theme.colors.foreground3,
//       marginTop: 8,
//     },
//     bottomBar: {
//       flexDirection: 'row',
//       justifyContent: 'space-around',
//       alignItems: 'center',
//       paddingVertical: 12,
//       paddingBottom: insets.bottom + 12,
//       backgroundColor: theme.colors.surface,
//       borderTopWidth: 1,
//       borderTopColor: theme.colors.surfaceBorder,
//     },
//   });

//   const showLanding = !currentTab || !currentTab.url;

//   return (
//     <View style={styles.container}>
//       <StatusBar barStyle="light-content" />

//       <View style={styles.header}>
//         <View style={styles.urlBar}>
//           <TextInput
//             style={styles.urlInput}
//             value={inputValue}
//             onChangeText={setInputValue}
//             onSubmitEditing={handleSubmit}
//             onFocus={() => triggerHaptic('impactLight')}
//             placeholder="Search or enter URL"
//             placeholderTextColor={theme.colors.foreground3}
//             autoCapitalize="none"
//             autoCorrect={false}
//             keyboardType="url"
//             returnKeyType="go"
//             selectTextOnFocus
//           />
//           {inputValue.length > 0 && (
//             <TouchableOpacity
//               style={styles.iconButton}
//               onPress={() => setInputValue('')}>
//               <MaterialIcons
//                 name="close"
//                 size={18}
//                 color={theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           {currentTab && currentTab.url && (
//             <TouchableOpacity style={styles.iconButton} onPress={handleBookmark}>
//               <MaterialIcons
//                 name={bookmarked ? 'bookmark' : 'bookmark-border'}
//                 size={22}
//                 color={bookmarked ? theme.colors.primary : theme.colors.foreground3}
//               />
//             </TouchableOpacity>
//           )}
//           <TouchableOpacity style={styles.tabsButton} onPress={openTabsView}>
//             <Text style={styles.tabsCount}>{tabs.length || 1}</Text>
//           </TouchableOpacity>
//         </View>
//       </View>

//       {showLanding ? (
//         <ScrollView style={styles.landingContainer}>
//           <Text style={styles.landingTitle}>Start Shopping</Text>
//           <View style={styles.shoppingGrid}>
//             {SHOPPING_SITES.map(site => (
//               <TouchableOpacity
//                 key={site.name}
//                 style={styles.shoppingButton}
//                 onPress={() => handleQuickShop(site.url)}>
//                 <MaterialIcons
//                   name="shopping-bag"
//                   size={28}
//                   color={theme.colors.primary}
//                 />
//                 <Text style={styles.shoppingButtonText}>{site.name}</Text>
//               </TouchableOpacity>
//             ))}
//           </View>
//         </ScrollView>
//       ) : (
//         <WebView
//           ref={webRef}
//           source={{uri: currentTab?.url || ''}}
//           style={{flex: 1}}
//           originWhitelist={['*']}
//           javaScriptEnabled
//           domStorageEnabled
//           onNavigationStateChange={navState => {
//             if (currentTab && navState.url) {
//               updateTab(currentTab.id, navState.url, navState.title || currentTab.title);
//               setInputValue(navState.url);
//             }
//           }}
//           userAgent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
//         />
//       )}

//       {/* Safari-style Tabs View */}
//       {showTabsView && (
//         <Animated.View
//           style={[
//             styles.tabsOverlay,
//             {
//               opacity: tabsViewScale,
//               transform: [
//                 {
//                   scale: tabsViewScale.interpolate({
//                     inputRange: [0, 1],
//                     outputRange: [0.9, 1],
//                   }),
//                 },
//               ],
//             },
//           ]}>
//           <View style={styles.tabsHeader}>
//             <TouchableOpacity style={styles.tabsHeaderButton} onPress={handleNewTab}>
//               <Text style={styles.tabsHeaderButtonText}>+</Text>
//             </TouchableOpacity>
//             <Text style={styles.tabsHeaderTitle}>{tabs.length} Tabs</Text>
//             <TouchableOpacity style={styles.tabsHeaderButton} onPress={closeTabsView}>
//               <Text style={styles.tabsHeaderButtonText}>Done</Text>
//             </TouchableOpacity>
//           </View>

//           <ScrollView contentContainerStyle={styles.tabsGrid}>
//             {tabs.map(tab => (
//               <TouchableOpacity
//                 key={tab.id}
//                 style={[
//                   styles.tabCard,
//                   tab.id === currentTabId && styles.tabCardActive,
//                 ]}
//                 onPress={() => handleSelectTab(tab.id)}
//                 activeOpacity={0.8}>
//                 <View style={styles.tabCardHeader}>
//                   <Text style={styles.tabCardTitle} numberOfLines={1}>
//                     {tab.title || getDomain(tab.url)}
//                   </Text>
//                   <TouchableOpacity
//                     style={styles.tabCardClose}
//                     onPress={() => handleCloseTab(tab.id)}
//                     hitSlop={{top: 10, bottom: 10, left: 10, right: 10}}>
//                     <MaterialIcons
//                       name="close"
//                       size={16}
//                       color={theme.colors.foreground3}
//                     />
//                   </TouchableOpacity>
//                 </View>
//                 <View style={styles.tabCardContent}>
//                   <MaterialIcons
//                     name="language"
//                     size={40}
//                     color={theme.colors.foreground3}
//                   />
//                   <Text style={styles.tabCardDomain}>{getDomain(tab.url)}</Text>
//                 </View>
//               </TouchableOpacity>
//             ))}
//             <TouchableOpacity style={styles.newTabCard} onPress={handleNewTab}>
//               <MaterialIcons name="add" size={32} color={theme.colors.foreground3} />
//               <Text style={styles.newTabText}>New Tab</Text>
//             </TouchableOpacity>
//           </ScrollView>
//         </Animated.View>
//       )}
//     </View>
//   );
// }
